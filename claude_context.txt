File: backend/src/core/security.py
from datetime import datetime, timedelta, timezone
from passlib.context import CryptContext
from jose import JWTError, jwt
from typing import Dict, Any, Optional
from sqlmodel import select
from sqlalchemy.ext.asyncio.session import AsyncSession

from src.core.settings import get_settings
from src.db import models

settings = get_settings()
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.now(timezone.utc) + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)

def create_refresh_token(data: dict):
    to_encode = data.copy()
    expire = datetime.now(timezone.utc) + timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)

def decode_token(token: str) -> Optional[Dict[str, Any]]:
    try:
        return jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
    except JWTError:
        return None

async def get_user_by_email(session: AsyncSession, email: str) -> Optional[models.User]:
    """Fetches a user by their email address."""
    statement = select(models.User).where(models.User.email == email)

    result = await session.execute(statement)
    return result.scalar_one_or_none()-e 
-e

File: backend/src/core/settings.py
from pydantic_settings import BaseSettings, SettingsConfigDict
from functools import lru_cache
import os

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env.test" if os.getenv("ENVIRONMENT") == "test" else ".env"
    )

    ENVIRONMENT: str = "development"
    DEBUG: bool = True
    FAIL_FAST: bool = False

    # Security & JWT
    SECRET_KEY: str
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 60
    REFRESH_TOKEN_EXPIRE_DAYS: int = 7

    # AI APIs
    QLOO_API_KEY: str
    GEMINI_API_KEY: str
    GEMINI_MODEL_NAME: str = "gemini-2.5-pro"
    TAVILY_API_KEY: str
    SCRAPER_API_KEY: str
    
    # Google OAuth
    GOOGLE_CLIENT_ID: str
    GOOGLE_CLIENT_SECRET: str

    # Database
    POSTGRES_DATABASE_URL: str
    POSTGRES_SCHEMA: str = "public"
    POSTGRES_POOL_SIZE: int = 10
    POSTGRES_MAX_OVERFLOW: int = 5
    POSTGRES_POOL_TIMEOUT: int = 30
    POSTGRES_POOL_RECYCLE: int = 1800
    POSTGRES_USE_SSL: bool = True

    # CORS & Frontend
    CORS_ORIGINS: list[str]

@lru_cache
def get_settings():
    return Settings()-e 
-e

File: backend/src/utils/__init__.py
from contextlib import asynccontextmanager
from fastapi import FastAPI
from loguru import logger
import time
from src.db.postgresql import postgres_db
from src.core.settings import get_settings
from src.db.models import rebuild_all_models

settings = get_settings()

# --- Lifespan Manager ---
@asynccontextmanager
async def lifespan(app: FastAPI):
    # --- SETUP PHASE ---
    logger.info(f"Starting up in {settings.ENVIRONMENT} mode...")
    start_time = time.time()
    
    # Resolve all model relationships before touching the database.
    rebuild_all_models()

    try:
        await postgres_db.create_db_and_tables()
        logger.info("Database connection and tables verified.")

        # CORE FIX: In development, after recreating the schema, the connection
        # pool may contain stale connections with invalid prepared statement
        # caches. Disposing the pool forces new, clean connections to be made.
        if settings.ENVIRONMENT == "development":
            logger.warning("DEV MODE: Disposing connection pool to clear caches after schema rebuild.")
            await postgres_db.engine.dispose()
            logger.info("Connection pool disposed successfully.")

    except Exception as e:
        logger.critical(f"Database connection failed: {e}")
        if settings.FAIL_FAST:
            raise RuntimeError("Database connection failed.") from e

    logger.info(f"Startup complete in {time.time() - start_time:.2f}s")
    
    # --- APPLICATION RUNNING ---
    yield
    
    # --- SHUTDOWN PHASE ---
    logger.info("Shutting down...")-e 
-e

File: backend/src/db/postgresql.py
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy.sql import text
from typing import AsyncGenerator, Dict, Any
from contextlib import asynccontextmanager
import asyncio
from sqlmodel import SQLModel
from urllib.parse import urlparse, parse_qs
from loguru import logger
import ssl
from src.core.settings import get_settings

settings = get_settings()


class PostgresDatabase:
    def __init__(self):
        self.DATABASE_URL = settings.POSTGRES_DATABASE_URL
        if not self.DATABASE_URL:
            raise ValueError("POSTGRES_DATABASE_URL environment variable is not set.")
        
        # Parse the URL and extract SSL mode if present
        url = urlparse(self.DATABASE_URL)
        self.db_host, self.db_port, self.db_user = url.hostname, url.port or 5432, url.username
        self.schema = getattr(settings, "POSTGRES_SCHEMA", "public")

        # Extract sslmode from query parameters
        query_params = parse_qs(url.query)
        sslmode = query_params.get('sslmode', [None])[0]
        
        # Remove query parameters from the URL to create a clean database URL
        clean_url = self.DATABASE_URL.split('?')[0]
        self.DATABASE_URL = clean_url

        # --- CORRECTED SSL and connect_args LOGIC ---
        connect_args: Dict[str, Any] = {}
        
        # Handle SSL configuration
        if settings.POSTGRES_USE_SSL or sslmode in ['require', 'prefer']:
            ssl_context = ssl.create_default_context(ssl.Purpose.SERVER_AUTH)
            # The following lines are often needed for cloud providers that don't
            # have their CA in the default trust store. Adjust as needed.
            ssl_context.check_hostname = False
            ssl_context.verify_mode = ssl.CERT_NONE
            connect_args["ssl"] = ssl_context
        elif sslmode == 'disable':
            # Explicitly disable SSL
            connect_args["ssl"] = False
        
        # CORE FIX: In a development environment, prepared statement caching can cause
        # errors when the schema changes during hot-reloading (e.g., dropping and
        # recreating tables on startup). Disabling the cache for asyncpg resolves this.
        if settings.ENVIRONMENT == "development":
            # The value 0 disables the cache.
            connect_args["statement_cache_size"] = 0
            logger.warning(
                "DEV MODE: Disabling prepared statement cache to prevent schema change errors."
            )

        self.pool_size = settings.POSTGRES_POOL_SIZE
        self.max_overflow = settings.POSTGRES_MAX_OVERFLOW
        self.pool_timeout = settings.POSTGRES_POOL_TIMEOUT
        self.pool_recycle = settings.POSTGRES_POOL_RECYCLE
        self.max_retries = 5
        self.retry_delay = 2
        self.debug_mode = settings.DEBUG

        try:
            self.engine = create_async_engine(
                self.DATABASE_URL, 
                echo=self.debug_mode, 
                pool_size=self.pool_size, 
                max_overflow=self.max_overflow,
                pool_timeout=self.pool_timeout, 
                pool_recycle=self.pool_recycle, 
                pool_pre_ping=True, 
                connect_args=connect_args
            )
            self.async_session_maker = sessionmaker(self.engine, class_=AsyncSession, expire_on_commit=False)
            logger.info(f"PostgreSQL connection initialized: host={self.db_host}, user={self.db_user}, schema={self.schema}")
        except Exception as e:
            logger.error(f"Failed to initialize PostgreSQL connection: {str(e)}")
            raise

    async def create_db_and_tables(self):
        """
        Initializes database tables. For development, it drops and recreates tables
        to ensure the schema is always in sync with the models. For production,
        it creates tables if they don't exist, but does not perform migrations.
        """
        retries = 0
        last_error = None
        while retries < self.max_retries:
            try:
                logger.info(f"Attempting to connect to database (attempt {retries + 1})")
                async with self.engine.begin() as conn:
                    # Ensure the schema exists
                    await conn.execute(text(f"CREATE SCHEMA IF NOT EXISTS {self.schema}"))
                    
                    # CORE FIX: In a dev environment, ensure schema is always up-to-date.
                    if settings.ENVIRONMENT == "development":
                        logger.warning("DEV MODE: Dropping and recreating tables for schema sync.")
                        await conn.run_sync(SQLModel.metadata.drop_all)

                    # Create all tables. This is idempotent and will not
                    # alter existing tables unless they were just dropped.
                    await conn.run_sync(SQLModel.metadata.create_all)

                logger.success("Database schema verified and ready.")
                return True

            except Exception as e:
                retries += 1
                last_error = e
                if retries < self.max_retries:
                    wait_time = self.retry_delay * retries
                    logger.warning(f"DB connection failed: {str(e)}. Retrying in {wait_time}s ({retries}/{self.max_retries})")
                    await asyncio.sleep(wait_time)
                else:
                    logger.error(f"Failed to connect to database after {self.max_retries} attempts. Last error: {str(last_error)}")
        raise last_error or RuntimeError("Failed to connect to database")

    @asynccontextmanager
    async def get_session(self) -> AsyncGenerator[AsyncSession, None]:
        async with self.async_session_maker() as session:
            try:
                await session.execute(text(f"SET search_path TO {self.schema}, public"))
                yield session
                await session.commit()
            except Exception as e:
                await session.rollback()
                logger.error(f"Database transaction error: {str(e)}")
                raise
            finally:
                await session.close()

    async def get_db_session(self) -> AsyncGenerator[AsyncSession, None]:
        async with self.get_session() as session:
            yield session

postgres_db = PostgresDatabase()

async def get_session() -> AsyncGenerator[AsyncSession, None]:
    async for session in postgres_db.get_db_session():
        yield session-e 
-e

File: backend/src/db/__init__.py
-e 
-e

File: backend/src/db/models/__init__.py
from __future__ import annotations
import enum
from typing import List, Optional, Dict, Any
from datetime import datetime, timezone 
import uuid 
from sqlmodel import Field, SQLModel, Relationship as SQLModelRelationship
from sqlalchemy.orm import relationship
from sqlalchemy import Column, DateTime, func, TEXT, JSON, ForeignKey # Import ForeignKey
from sqlalchemy.dialects.postgresql import UUID

from loguru import logger

# --- Enums ---
class ReportStatus(str, enum.Enum):
    DRAFT = "DRAFT"
    PENDING = "PENDING"
    COMPLETED = "COMPLETED"
    FAILED = "FAILED"

class ClashSeverity(str, enum.Enum):
    LOW = "LOW"
    MEDIUM = "MEDIUM"
    HIGH = "HIGH"

# --- Database Table Models ---

class User(SQLModel, table=True):
    __tablename__ = 'user'
    id: Optional[int] = Field(default=None, primary_key=True)
    full_name: Optional[str] = Field(default=None)
    email: str = Field(unique=True, index=True)
    hashed_password: Optional[str] = Field(default=None, nullable=True)
    is_active: bool = Field(default=True)
    is_superuser: bool = Field(default=False)
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc), sa_column=Column(DateTime(timezone=True), server_default=func.now(), nullable=False))
    updated_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc), 
        sa_column=Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    )
    
    reports: List["Report"] = SQLModelRelationship(sa_relationship=relationship("Report", back_populates="user"))

class Report(SQLModel, table=True):
    __tablename__ = 'report'
    id: uuid.UUID = Field(
        default_factory=uuid.uuid4,
        sa_column=Column(
            UUID(as_uuid=True),
            primary_key=True,
            index=True,
            nullable=False
        )
    )
    title: str = Field(index=True, default="Untitled Report")
    acquirer_brand: Optional[str] = Field(default=None)
    target_brand: Optional[str] = Field(default=None)
    status: ReportStatus = Field(default=ReportStatus.DRAFT, sa_column=Column(TEXT, nullable=False))
    extracted_file_context: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc), sa_column=Column(DateTime(timezone=True), server_default=func.now(), nullable=False))
    updated_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        sa_column=Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    )
    user_id: int = Field(foreign_key="user.id")

    user: "User" = SQLModelRelationship(sa_relationship=relationship("User", back_populates="reports"))
    analysis: Optional["ReportAnalysis"] = SQLModelRelationship(sa_relationship=relationship("ReportAnalysis", back_populates="report", uselist=False, cascade="all, delete-orphan"))
    culture_clashes: List["CultureClash"] = SQLModelRelationship(sa_relationship=relationship("CultureClash", back_populates="report", cascade="all, delete-orphan"))
    untapped_growths: List["UntappedGrowth"] = SQLModelRelationship(sa_relationship=relationship("UntappedGrowth", back_populates="report", cascade="all, delete-orphan"))

class ReportAnalysis(SQLModel, table=True):
    __tablename__ = 'reportanalysis'
    id: Optional[int] = Field(default=None, primary_key=True)
    cultural_compatibility_score: float = Field(index=True)
    affinity_overlap_score: float
    brand_archetype_summary: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    strategic_summary: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    report_id: uuid.UUID = Field(sa_column=Column(UUID(as_uuid=True), ForeignKey("report.id")))
    
    # --- ADDED THIS FIELD ---
    persona_expansion_summary: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    
    search_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))
    acquirer_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))
    target_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))

    # Corporate culture fields
    acquirer_corporate_profile: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    target_corporate_profile: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    corporate_ethos_summary: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    acquirer_culture_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))
    target_culture_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))
    
    # Financial analysis fields
    acquirer_financial_profile: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    target_financial_profile: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    financial_synthesis: Optional[str] = Field(default=None, sa_column=Column(TEXT))
    acquirer_financial_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))
    target_financial_sources: Optional[List[Dict[str, Any]]] = Field(default=None, sa_column=Column(JSON))

    report: "Report" = SQLModelRelationship(sa_relationship=relationship("Report", back_populates="analysis"))

class CultureClash(SQLModel, table=True):
    __tablename__ = 'cultureclash'
    id: Optional[int] = Field(default=None, primary_key=True)
    topic: str = Field(index=True)
    description: str = Field(sa_column=Column(TEXT))
    severity: ClashSeverity = Field(sa_column=Column(TEXT, nullable=False))
    report_id: uuid.UUID = Field(sa_column=Column(UUID(as_uuid=True), ForeignKey("report.id")))
    
    report: "Report" = SQLModelRelationship(sa_relationship=relationship("Report", back_populates="culture_clashes"))

class UntappedGrowth(SQLModel, table=True):
    __tablename__ = 'untappedgrowth'
    id: Optional[int] = Field(default=None, primary_key=True)
    description: str = Field(sa_column=Column(TEXT))
    potential_impact_score: int
    report_id: uuid.UUID = Field(sa_column=Column(UUID(as_uuid=True), ForeignKey("report.id")))
    
    report: "Report" = SQLModelRelationship(sa_relationship=relationship("Report", back_populates="untapped_growths"))


# --- API Schemas ---
class ReportAnalysisRead(SQLModel):
    id: Optional[int]
    cultural_compatibility_score: float
    affinity_overlap_score: float
    brand_archetype_summary: Optional[str]
    strategic_summary: Optional[str]
    report_id: uuid.UUID
    
    # --- ADDED THIS FIELD ---
    persona_expansion_summary: Optional[str]
    
    search_sources: Optional[List[Dict[str, Any]]]
    acquirer_sources: Optional[List[Dict[str, Any]]]
    target_sources: Optional[List[Dict[str, Any]]]
    acquirer_corporate_profile: Optional[str]
    target_corporate_profile: Optional[str]
    corporate_ethos_summary: Optional[str]
    acquirer_culture_sources: Optional[List[Dict[str, Any]]]
    target_culture_sources: Optional[List[Dict[str, Any]]]
    acquirer_financial_profile: Optional[str]
    target_financial_profile: Optional[str]
    financial_synthesis: Optional[str]
    acquirer_financial_sources: Optional[List[Dict[str, Any]]]
    target_financial_sources: Optional[List[Dict[str, Any]]]

class CultureClashRead(SQLModel):
    id: Optional[int]
    topic: str
    description: str
    severity: ClashSeverity
    report_id: uuid.UUID

class UntappedGrowthRead(SQLModel):
    id: Optional[int]
    description: str
    potential_impact_score: int
    report_id: uuid.UUID

class ReportCreate(SQLModel):
    title: str
    acquirer_brand: str
    target_brand: str

class ReportRead(SQLModel):
    id: uuid.UUID
    title: str
    acquirer_brand: Optional[str]
    target_brand: Optional[str]
    status: ReportStatus
    created_at: datetime
    updated_at: datetime
    user_id: int
    analysis: Optional[ReportAnalysisRead] = None
    culture_clashes: List[CultureClashRead] = []
    untapped_growths: List[UntappedGrowthRead] = []

def rebuild_all_models():
    """
    This function forces the resolution of all forward-looking type hints
    in SQLModel and Pydantic models.
    """
    logger.info("Rebuilding all model forward references...")
    User.model_rebuild()
    ReportAnalysis.model_rebuild()
    CultureClash.model_rebuild()
    UntappedGrowth.model_rebuild()
    Report.model_rebuild()

    ReportCreate.model_rebuild()
    ReportAnalysisRead.model_rebuild()
    CultureClashRead.model_rebuild()
    UntappedGrowthRead.model_rebuild()
    ReportRead.model_rebuild()
    logger.success("Model forward references rebuilt successfully.")

__all__ = [
    "User", "Report", "ReportAnalysis", "CultureClash", "UntappedGrowth",
    "ReportStatus", "ClashSeverity",
    "ReportCreate", "ReportRead",
    "ReportAnalysisRead", "CultureClashRead", "UntappedGrowthRead",
    "rebuild_all_models"
]-e 
-e

File: backend/src/api/v1/auth.py
from fastapi import APIRouter, Depends, HTTPException, status, Request, Header
from fastapi.responses import RedirectResponse
from fastapi.security import OAuth2PasswordRequestForm
from typing import Annotated, Dict, Any
from sqlalchemy.ext.asyncio import AsyncSession
from urllib.parse import urlencode, urlparse
import httpx
from loguru import logger
import uuid
import random
import json

from fastapi_simple_rate_limiter import rate_limiter
from src.core.security import (
    create_access_token,
    create_refresh_token,
    verify_password,
    get_password_hash,
    decode_token,
    get_user_by_email
)
from src.core.settings import get_settings
from src.db.postgresql import get_session
from src.db import models
from pydantic import BaseModel

settings = get_settings()
router = APIRouter()

# --- Pydantic Models ---
class Token(BaseModel):
    access_token: str
    refresh_token: str
    token_type: str

class TokenRefreshRequest(BaseModel):
    refresh_token: str
    
class TokenRefreshResponse(BaseModel):
    access_token: str
    token_type: str

class UserCreate(BaseModel):
    email: str
    password: str

# --- OAuth2 Provider Constants ---
GOOGLE_AUTH_URL = "https://accounts.google.com/o/oauth2/v2/auth"
GOOGLE_TOKEN_URL = "https://oauth2.googleapis.com/token"
GOOGLE_USERINFO_URL = "https://www.googleapis.com/oauth2/v3/userinfo"
GOOGLE_SCOPES = "openid email profile"

# --- Guest Mode Constants ---
GUEST_NAMES = [
    "Curious Capybara", "Analytical Aardvark", "Synergy Shark", 
    "Due Diligence Duck", "Strategic Squirrel", "Data-driven Dingo"
]


# --- NEW: Seed Report Helper ---
async def create_seed_report_for_user(session: AsyncSession, user: models.User):
    """Creates a pre-populated demo report for a new user."""
    logger.info(f"Creating seed report for new user: {user.email}")
    try:
        report = models.Report(
            title="Demo Report: Nike vs. Patagonia",
            acquirer_brand="Nike",
            target_brand="Patagonia",
            status=models.ReportStatus.COMPLETED,
            user_id=user.id,
        )

        analysis = models.ReportAnalysis(
            report=report,
            cultural_compatibility_score=68.4,
            affinity_overlap_score=45.2,
            brand_archetype_summary=json.dumps({
                "acquirer_archetype": "The Hero: Triumphant, determined, and focused on peak performance and victory. Nike's brand narrative consistently revolves around overcoming obstacles and achieving greatness.",
                "target_archetype": "The Explorer: Rugged, individualistic, and driven by a desire for authenticity and connection with the natural world. Patagonia embodies adventure and environmental stewardship."
            }),
            strategic_summary="This potential acquisition presents a fascinating blend of mass-market dominance and niche, purpose-driven loyalty. While the cultural compatibility score of 68.4 indicates moderate alignment, the core brand archetypes (Hero vs. Explorer) are fundamentally different. The primary risk lies in diluting Patagonia's authentic, anti-consumerist brand ethos. However, the opportunity to infuse Nike's supply chain with Patagonia's sustainability innovations is a significant potential upside. A successful integration would require maintaining Patagonia as a highly autonomous subsidiary.",
            persona_expansion_summary=json.dumps({
                "expansion_score": 72.5,
                "latent_synergies": ["Sustainable Materials", "Outdoor Performance Gear", "Brand Activism", "Documentary-style Storytelling"],
                "analysis": "Nike's audience shows a strong predicted affinity for Patagonia's core values of sustainability and outdoor adventure, suggesting high potential for product cross-pollination."
            }),
            corporate_ethos_summary=json.dumps({
                "acquirer_ethos": "A high-octane, competitive corporate culture focused on innovation, marketing dominance, and celebrity endorsements. The internal mantra is 'Just Do It,' reflecting a relentless drive for success.",
                "target_ethos": "A mission-driven culture centered on environmentalism and employee well-being. Famous for its 'Let My People Go Surfing' policy, it prioritizes work-life balance and activism."
            }),
            financial_synthesis="Nike is a global titan with massive revenue streams and complex global logistics. Patagonia operates as a private, high-margin niche player with a famously simplified product line and a 'don't buy this jacket' marketing approach. The financial profiles are starkly different in scale but both are highly profitable.",
            
            # --- MODIFIED: Added detailed profile data ---
            acquirer_corporate_profile="""
- **Leadership**: Led by CEO John Donahoe, Nike's leadership team is composed of seasoned executives from the sports, tech, and retail industries.
- **Values**: Core values revolve around performance, innovation, and a 'winning' mindset.
- **Workplace**: A fast-paced, competitive environment at its Beaverton, Oregon headquarters. Known for excellent employee benefits and a campus-like atmosphere.
            """,
            target_corporate_profile="""
- **Leadership**: Founded by Yvon Chouinard, the company is known for its unconventional, mission-driven leadership. In 2022, ownership was transferred to a trust to ensure profits are used to combat climate change.
- **Values**: Environmentalism, quality, and activism are paramount. The company is a certified B Corporation.
- **Workplace**: Fosters a culture of autonomy and passion for the outdoors, with benefits supporting environmental work and family leave.
            """,
            acquirer_financial_profile="""
- **Revenue (FY2023)**: $51.2 billion
- **Market Cap (Approx.)**: ~$150 billion
- **Business Model**: Global retail, wholesale, and direct-to-consumer (DTC) sales of athletic footwear, apparel, and equipment.
- **Key Strength**: Unmatched brand recognition and marketing prowess.
            """,
            target_financial_profile="""
- **Revenue (est.)**: ~$1.5 billion
- **Valuation (est.)**: ~$3 billion (at time of ownership transfer)
- **Business Model**: Primarily DTC and wholesale of high-quality, sustainable outdoor apparel.
- **Key Strength**: Extreme brand loyalty and pricing power due to its mission-driven approach.
            """,
            acquirer_sources=[{"title": "Nike, Inc. - Wikipedia", "url": "https://en.wikipedia.org/wiki/Nike,_Inc."}],
            target_sources=[{"title": "Patagonia, Inc. - Wikipedia", "url": "https://en.wikipedia.org/wiki/Patagonia,_Inc."}],
            acquirer_culture_sources=[{"title": "Nike's Official Careers Page", "url": "https://jobs.nike.com/"}],
            target_culture_sources=[{"title": "Patagonia's Activism Culture", "url": "https://www.patagonia.com/activism/"}],
            acquirer_financial_sources=[{"title": "Nike, Inc. (NKE) - Yahoo Finance", "url": "https://finance.yahoo.com/quote/NKE/"}],
            target_financial_sources=[{"title": "Forbes: Patagonia's New Ownership", "url": "https://www.forbes.com/sites/gurufocus/2022/09/21/patagonias-new-ownership-structure-could-be-a-game-changer-for-esg-investing/"}],
        )

        # --- MODIFIED: Replaced strategic summaries with actual taste data ---
        clashes = [
            models.CultureClash(report=report, topic="Hip Hop Music", description="The Acquirer's audience shows a strong affinity for this, a taste not shared by the Target's.", severity=models.ClashSeverity.HIGH),
            models.CultureClash(report=report, topic="Sneaker Collecting", description="The Acquirer's audience shows a strong affinity for this, a taste not shared by the Target's.", severity=models.ClashSeverity.HIGH),
            models.CultureClash(report=report, topic="Pro Basketball", description="The Acquirer's audience shows a strong affinity for this, a taste not shared by the Target's.", severity=models.ClashSeverity.MEDIUM),
            models.CultureClash(report=report, topic="Environmental Documentaries", description="The Target's audience shows a strong affinity for this, a taste not shared by the Acquirer's.", severity=models.ClashSeverity.MEDIUM),
            models.CultureClash(report=report, topic="Rock Climbing", description="The Target's audience shows a strong affinity for this, a taste not shared by the Acquirer's.", severity=models.ClashSeverity.HIGH),
            models.CultureClash(report=report, topic="Folk & Indie Music", description="The Target's audience shows a strong affinity for this, a taste not shared by the Acquirer's.", severity=models.ClashSeverity.MEDIUM),
        ]
        
        growths = [
            models.UntappedGrowth(report=report, description="Both audiences show a strong affinity for 'Social Media Influencers'.", potential_impact_score=9),
            models.UntappedGrowth(report=report, description="Both audiences show a strong affinity for 'Fitness & Wellness'.", potential_impact_score=8),
            models.UntappedGrowth(report=report, description="Both audiences show a strong affinity for 'Outdoor Apparel'.", potential_impact_score=9),
            models.UntappedGrowth(report=report, description="Both audiences show a strong affinity for 'Action & Adventure Films'.", potential_impact_score=7),
        ]

        session.add(report)
        session.add(analysis)
        session.add_all(clashes)
        session.add_all(growths)
        
        await session.commit()
        logger.success(f"Seed report created successfully for user {user.email}")
    except Exception as e:
        await session.rollback()
        logger.error(f"Failed to create seed report for user {user.email}: {e}")

# --- Helper Function ---
def get_backend_base_url() -> str:
    """
    Determines the backend's base URL. In production, it uses the first
    CORS origin (which should be the frontend URL) to derive the backend URL,
    ensuring the correct scheme (https://) and domain.
    """
    # In a production/staging environment, trust the CORS origin setting.
    # This assumes the frontend and backend are on the same domain.
    # e.g., web is on https://alloy.app, backend is on https://alloy.app
    if settings.ENVIRONMENT != "development":
        # We assume the first CORS origin is the primary frontend URL.
        # e.g., https://alloy-web-*.run.app
        frontend_url = settings.CORS_ORIGINS[0]
        parsed_uri = urlparse(frontend_url)
        # We derive the backend URL from the web URL. This is a common pattern
        # when they are hosted on subdomains of the same parent service.
        # This part might need adjustment based on your specific CNAME/DNS setup.
        # For Cloud Run, this simple replacement is often sufficient if you use a similar naming convention.
        backend_host = parsed_uri.hostname.replace("web", "backend") if parsed_uri.hostname else "localhost"
        return f"https://{backend_host}"
    
    # In development, you might be running on http://localhost:8000
    # A more robust solution for dev would be to use an env var.
    # For now, we will construct it simply.
    return "http://localhost:8000"


async def create_user_if_not_exists(session: AsyncSession, user_data: Dict[str, Any]) -> models.User:
    db_user = await get_user_by_email(session, user_data["email"])
    if db_user:
        return db_user
    
    # CORE FIX: Instantiate the model directly instead of using model_validate.
    # This allows the database to apply the server_default for created_at and updated_at.
    new_user = models.User(**user_data)
    
    try:
        session.add(new_user)
        await session.commit()
        await session.refresh(new_user)
        logger.info(f"New user created via SSO: {new_user.email}")
        
        # MODIFIED: Create seed report for new SSO user
        await create_seed_report_for_user(session, new_user)
        
        return new_user
    except Exception as e:
        await session.rollback()
        logger.error(f"Error during SSO user creation for {user_data['email']}: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Could not create user account."
        )


# --- API Endpoints ---
DBSession = Annotated[AsyncSession, Depends(get_session)]

@router.post("/register", status_code=status.HTTP_201_CREATED)
@rate_limiter(limit=30, seconds=60)
async def register_user(user_create: UserCreate, session: DBSession):
    if await get_user_by_email(session, user_create.email):
        raise HTTPException(status.HTTP_400_BAD_REQUEST, "Email already registered")
    
    new_user = models.User(
        email=user_create.email, 
        hashed_password=get_password_hash(user_create.password)
    )
    session.add(new_user)
    await session.commit()
    await session.refresh(new_user)
    
    # MODIFIED: Create seed report for new registered user
    await create_seed_report_for_user(session, new_user)
    
    return {"message": "User created successfully"}

@router.post("/login", response_model=Token)
@rate_limiter(limit=30, seconds=60)
async def login_for_access_token(
    form_data: Annotated[OAuth2PasswordRequestForm, Depends()], 
    session: DBSession
):
    user = await get_user_by_email(session, form_data.username)
    if not user or not user.hashed_password or not verify_password(form_data.password, user.hashed_password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Incorrect email or password",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    token_data = {"sub": user.email, "full_name": user.full_name}
    return Token(
        access_token=create_access_token(data=token_data),
        refresh_token=create_refresh_token(data=token_data),
        token_type="bearer"
    )

@router.post("/refresh", response_model=TokenRefreshResponse)
@rate_limiter(limit=30, seconds=60)
async def refresh_access_token(
    refresh_request: TokenRefreshRequest,
    session: DBSession
):
    token_data = decode_token(refresh_request.refresh_token)
    if not token_data or "sub" not in token_data:
        raise HTTPException(status.HTTP_401_UNAUTHORIZED, "Invalid refresh token")
    
    user = await get_user_by_email(session, token_data["sub"])
    if not user:
        raise HTTPException(status.HTTP_401_UNAUTHORIZED, "User not found")

    new_token_data = {"sub": user.email, "full_name": user.full_name}
    return TokenRefreshResponse(
        access_token=create_access_token(data=new_token_data),
        token_type="bearer"
    )

@router.get("/google/authorize", tags=["auth"], response_class=RedirectResponse)
async def google_authorize(request: Request):
    # THE FIX: Use the request's own headers to determine the base URL
    # This correctly handles https and the domain from behind a proxy.
    # Cloud Run provides X-Forwarded-Proto and X-Forwarded-Host headers.
    scheme = request.headers.get("x-forwarded-proto", "http")
    host = request.headers.get("x-forwarded-host", request.url.netloc)
    
    # Construct the base URL and the final redirect URI
    base_url = f"{scheme}://{host}"
    redirect_uri = f"{base_url}/api/v1/auth/google/callback"
    
    logger.info(f"Generated Google redirect URI: {redirect_uri}")

    params = {
        "client_id": settings.GOOGLE_CLIENT_ID,
        "redirect_uri": redirect_uri,
        "response_type": "code",
        "scope": GOOGLE_SCOPES,
        "access_type": "offline",
        "prompt": "consent",
    }
    auth_url = f"{GOOGLE_AUTH_URL}?{urlencode(params)}"
    return RedirectResponse(auth_url)


@router.get("/google/callback", tags=["auth"], response_class=RedirectResponse)
@rate_limiter(limit=30, seconds=60)
async def google_callback(
    request: Request, code: str, session: DBSession
):
    """Handles the callback from Google, exchanges code for token, and gets user info."""
    # THE FIX: Reconstruct the redirect_uri exactly as it was in the authorize step.
    scheme = request.headers.get("x-forwarded-proto", "http")
    host = request.headers.get("x-forwarded-host", request.url.netloc)
    base_url = f"{scheme}://{host}"
    redirect_uri = f"{base_url}/api/v1/auth/google/callback"

    logger.info(f"Handling Google callback for redirect URI: {redirect_uri}")

    token_data = {
        "code": code,
        "client_id": settings.GOOGLE_CLIENT_ID,
        "client_secret": settings.GOOGLE_CLIENT_SECRET,
        "redirect_uri": redirect_uri,
        "grant_type": "authorization_code",
    }
    
    async with httpx.AsyncClient() as client:
        token_response = await client.post(GOOGLE_TOKEN_URL, data=token_data)
        if token_response.status_code != 200:
            logger.error(f"Google token exchange FAILED. Status: {token_response.status_code}, Response: {token_response.json()}")
            raise HTTPException(status_code=400, detail="Could not exchange token with Google.")
        
        access_token_ext = token_response.json().get("access_token")

        user_info_response = await client.get(
            GOOGLE_USERINFO_URL, headers={"Authorization": f"Bearer {access_token_ext}"}
        )
        if user_info_response.status_code != 200:
            logger.error(f"Google user info fetch FAILED: {user_info_response.json()}")
            raise HTTPException(status_code=400, detail="Could not retrieve user info from Google.")
        
        user_info = user_info_response.json()

    email = user_info.get("email")
    if not email:
        raise HTTPException(status_code=400, detail="No email returned from Google.")

    user = await create_user_if_not_exists(session, {"email": email, "full_name": user_info.get("name")})
    
    access_token = create_access_token(data={"sub": user.email, "full_name": user.full_name})
    refresh_token = create_refresh_token(data={"sub": user.email})

    params = urlencode({"access_token": access_token, "refresh_token": refresh_token})
    # Use the first CORS origin as the definitive frontend URL to redirect back to.
    frontend_redirect_url = f"{settings.CORS_ORIGINS[0]}/token?{params}"
    
    return RedirectResponse(url=frontend_redirect_url)

@router.post("/guest", response_model=Token, tags=["auth"])
async def guest_login(session: DBSession):
    """Creates a temporary guest user and returns auth tokens. For the sake of demo, guest users are created with random names and emails."""
    guest_email = f"guest_{uuid.uuid4()}@alloy.dev"
    guest_name = random.choice(GUEST_NAMES)
    
    logger.info(f"Creating new guest user: {guest_name} ({guest_email})")
    
    # Guest users don't have passwords
    guest_user = models.User(
        email=guest_email,
        full_name=guest_name,
        is_active=True, 
        hashed_password=None
    )
    
    try:
        session.add(guest_user)
        await session.commit()
        await session.refresh(guest_user)
        
        # MODIFIED: Create seed report for new guest user
        await create_seed_report_for_user(session, guest_user)
        
    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating guest user: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Could not create guest account."
        )

    token_data = {"sub": guest_user.email, "full_name": guest_user.full_name}
    return Token(
        access_token=create_access_token(data=token_data),
        refresh_token=create_refresh_token(data=token_data),
        token_type="bearer"
    )

async def get_current_user(
    token: Annotated[str, Header(alias="Authorization")],
    session: DBSession,
) -> models.User:
    if not token.startswith("Bearer "):
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid token type")
    
    token = token.split(" ")[1]
    token_data = decode_token(token)
    if not token_data or "sub" not in token_data:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    user = await get_user_by_email(session, email=token_data["sub"])
    if not user:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="User not found")
    
    return user-e 
-e

File: backend/src/api/v1/health.py
from fastapi import APIRouter, status
from pydantic import BaseModel
from fastapi_simple_rate_limiter import rate_limiter
router = APIRouter()

class HealthCheck(BaseModel):
    status: str
    version: str

@router.get(
    "/",
    response_model=HealthCheck,
    status_code=status.HTTP_200_OK,
    tags=["Health"],
    summary="Perform a Health Check",
    description="Checks the operational status of the API service.",
)
@rate_limiter(limit=30, seconds=60)
def health_check(app_version: str = "1.0.0"):
    return HealthCheck(status="ok", version=app_version)-e 
-e

File: backend/src/api/v1/__init__.py
from fastapi import APIRouter
from . import auth, health, reports, utils # Add reports

router = APIRouter()

router.include_router(auth.router, prefix="/auth", tags=["Authentication"])
router.include_router(health.router, prefix="/health", tags=["Health"])
router.include_router(reports.router, prefix="/reports", tags=["Reports"]) # Add this line
router.include_router(utils.router, prefix="/utils", tags=["Utilities"])

__all__ = ["router"]-e 
-e

File: backend/src/api/v1/utils.py
from fastapi import APIRouter, Query, HTTPException, status
from fastapi.responses import RedirectResponse
import httpx
from typing import Optional
from bs4 import BeautifulSoup
from urllib.parse import urlparse, urljoin
from loguru import logger

from src.core.settings import get_settings
from src.services.search import find_official_website
from fastapi_simple_rate_limiter import rate_limiter

router = APIRouter()
settings = get_settings()

async def fetch_with_scraper(client: httpx.AsyncClient, url: str) -> httpx.Response:
    if not settings.SCRAPER_API_KEY or settings.SCRAPER_API_KEY == "YOUR_SCRAPER_API_KEY_HERE":
        logger.warning("ScraperAPI key not configured. Attempting direct request.")
        return await client.get(url, timeout=10)
    logger.info(f"Using ScraperAPI for URL: {url}")
    scraper_url = "http://api.scraperapi.com"
    params = {'api_key': settings.SCRAPER_API_KEY, 'url': url}
    return await client.get(scraper_url, params=params, timeout=30)

async def find_favicon_url(url: str, client: httpx.AsyncClient) -> Optional[str]:
    base_url = f"{urlparse(url).scheme}://{urlparse(url).netloc}"
    ico_url = urljoin(base_url, "/favicon.ico")
    try:
        ico_check = await client.head(ico_url, timeout=5)
        if ico_check.status_code == 200 and 'image' in ico_check.headers.get('content-type', ''):
            logger.info(f"Found favicon for {url} at default /favicon.ico")
            return ico_url
    except httpx.RequestError:
        pass
    logger.info(f"Checking HTML for favicon link in {url}")
    try:
        response = await client.get(url, timeout=10)
        response.raise_for_status()
    except httpx.HTTPStatusError as e:
        if e.response.status_code in [401, 403]:
            logger.warning(f"Direct access to {url} failed ({e.response.status_code}). Retrying with scraper.")
            response = await fetch_with_scraper(client, url)
            response.raise_for_status()
        else:
            raise
    soup = BeautifulSoup(response.text, "html.parser")
    icon_rels = ["icon", "shortcut icon", "apple-touch-icon"]
    icon_link = soup.find("link", rel=lambda r: r and r.lower() in icon_rels)
    if icon_link and icon_link.has_attr("href"):
        favicon_href = icon_link["href"]
        favicon_url = urljoin(str(response.url), favicon_href)

        # --- FIX: Add a check to ignore generic scraper favicons ---
        if "scraperapi.com" in favicon_url:
            logger.warning(f"Ignoring generic scraper favicon for {url}")
            return None # Explicitly return None to continue searching

        logger.success(f"Successfully found favicon for {url} at {favicon_url}")
        return favicon_url
    return None

async def fetch_favicon_bytes(brand_name: str) -> Optional[bytes]:
    """Finds a brand's favicon and returns its raw bytes."""
    logger.info(f"Fetching favicon bytes for PDF: '{brand_name}'")
    try:
        website_url = await find_official_website(brand_name)
        if not website_url:
            return None
        
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
        }
        async with httpx.AsyncClient(follow_redirects=True, headers=headers) as client:
            favicon_url = await find_favicon_url(website_url, client)
            if not favicon_url:
                return None
            
            response = await client.get(favicon_url, timeout=10)
            response.raise_for_status()
            return response.content
    except Exception as e:
        logger.warning(f"Could not fetch favicon bytes for '{brand_name}': {e}")
        return None

@router.get("/favicon", response_class=RedirectResponse, status_code=status.HTTP_307_TEMPORARY_REDIRECT)
@rate_limiter(limit=200, seconds=60)
async def get_favicon(
    url: Optional[str] = Query(None),
    brandName: Optional[str] = Query(None)
) -> RedirectResponse:
    """
    Finds and redirects to the favicon for a given URL or brand name.
    Prioritizes brandName if both are provided.
    """
    if not brandName and not url:
        raise HTTPException(status_code=400, detail="Either 'url' or 'brandName' query parameter is required.")

    final_url = url
    if brandName:
        logger.info(f"Initiating favicon search for brand: '{brandName}'")
        final_url = await find_official_website(brandName)
        if not final_url:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Could not find an official website for '{brandName}'.")
    
    if not final_url:
        raise HTTPException(status_code=400, detail="Invalid URL provided.")

    if not final_url.startswith('http'):
        final_url = 'https://' + final_url

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
    }
    async with httpx.AsyncClient(follow_redirects=True, headers=headers) as client:
        try:
            favicon_url = await find_favicon_url(final_url, client)
            if favicon_url:
                return RedirectResponse(url=favicon_url)
            raise HTTPException(status_code=404, detail="Favicon not found for the discovered URL.")
        except httpx.RequestError as e:
            logger.warning(f"Could not fetch URL {final_url}: {e}")
            raise HTTPException(status_code=400, detail=f"Could not fetch the provided URL: {e}")
        except Exception as e:
            logger.error(f"An unexpected error occurred while fetching favicon for {final_url}: {e}")
            raise HTTPException(status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An internal error occurred.")-e 
-e

File: backend/src/api/v1/reports.py
from fastapi import APIRouter, Depends, HTTPException, status, UploadFile, File
from typing import List, Optional, AsyncGenerator, Dict
from sqlmodel import select, SQLModel
from sqlalchemy.orm import selectinload
from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime
from fastapi.responses import StreamingResponse, Response
import json
import google.generativeai as genai
import uuid
import asyncio

from src.db.postgresql import get_session, postgres_db
from src.db import models
from src.core.settings import get_settings
from src.api.v1.auth import get_current_user
from src.api.v1.utils import fetch_favicon_bytes
from src.services.react_agent import AlloyReActAgent
from src.services.docling import process_document_with_docling
from src.services.report_generator import generate_chat_response
from src.services.pdf_generator import create_report_pdf
from loguru import logger
from fastapi_simple_rate_limiter import rate_limiter

router = APIRouter()
settings = get_settings()
genai.configure(api_key=settings.GEMINI_API_KEY)

# --- Pydantic Models for API ---
class ReportGeneratePayload(SQLModel):
    acquirer_brand: str
    target_brand: str
    title: str
    context: Optional[str] = None
    use_grounding: bool = False

class DraftReportResponse(SQLModel):
    id: uuid.UUID
    status: models.ReportStatus
    created_at: datetime
    user_id: int

class ReportChatPayload(SQLModel):
    messages: List[Dict[str, str]]
    context: str

class FileUploadResponse(SQLModel):
    filename: str
    content_type: str
    size_in_bytes: int
    message: str = "File processed successfully."

# --- Helper Functions ---
def _safe_float(value: any, default: float = 0.0) -> float:
    """Safely converts a value to a float, returning a default if conversion fails."""
    if value is None:
        return default
    try:
        return float(value)
    except (ValueError, TypeError):
        return default

async def mark_report_as_failed(report_id: uuid.UUID) -> None:
    try:
        async with postgres_db.get_session() as session:
            report = await session.get(models.Report, report_id)
            if report and report.status == models.ReportStatus.PENDING:
                report.status = models.ReportStatus.FAILED
                session.add(report)
                await session.commit()
                logger.info(f"Successfully marked report {report_id} as FAILED.")
    except Exception as e:
        logger.error(f"Could not mark report {report_id} as FAILED: {e}")

async def synthesize_final_report(agent_data: dict) -> dict:
    """
    Takes the agent's gathered data, uses an LLM to synthesize qualitative summaries,
    and then programmatically adds the quantitative scores for a reliable final report.
    """
    logger.info("Synthesizing final report from agent data.", agent_data)
    
    # --- CORRECTED SCORE CALCULATION ---
    # Fetch both core analysis components from the agent's gathered data.
    qloo_analysis = agent_data.get('qloo_analysis', {})
    persona_expansion = agent_data.get('persona_expansion', {})

    # Safely extract the quantitative scores.
    affinity_score = _safe_float(qloo_analysis.get('affinity_overlap_score', 0.0))
    expansion_score = _safe_float(persona_expansion.get('expansion_score', 0.0))

    cultural_score = (0.6 * affinity_score) + (0.4 * expansion_score)
    cultural_score = round(min(cultural_score, 100.0), 1) # Clamp score to a max of 100.
    
    data_for_synthesis = {
        key: value for key, value in agent_data.items() 
        if key not in ['culture_clashes', 'untapped_growths', 'qloo_analysis', 'persona_expansion']
    }

    model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
    prompt = f"""
    You are a senior M&A analyst from a top-tier investment bank. You have been provided with raw data from your junior research team.
    Your task is to synthesize this data into professional, qualitative summaries for a due diligence report.

    **RAW DATA FOR SYNTHESIS:**
    ```json
    {json.dumps(data_for_synthesis, indent=2)}
    ```

    **YOUR TASK (Return a single JSON object with TEXT summaries only):**
    Based *only* on the raw data provided, generate a complete report with the following keys:
    - "brand_archetype_summary": An object with "acquirer_archetype" and "target_archetype" strings. Deduce these from their 'acquirer_profile' and 'target_profile'.
    - "corporate_ethos_summary": An object with "acquirer_ethos" and "target_ethos" strings. Synthesize a sharp, comparative analysis of each company's leadership, values, and work culture based on their 'acquirer_culture_profile' and 'target_culture_profile'.
    - "financial_synthesis": A string providing a comparative summary of the two companies' financial health and market positioning based on their respective financial profiles.
    - "strategic_summary": A string providing a concise, executive-level overview of all findings, combining brand, corporate, and financial insights into a final recommendation. If cultural data seems missing, mention this as a potential risk.

    Return ONLY the final JSON object containing these text-based summaries. Do NOT include any scores.
    """
    
    try:
        response = await model.generate_content_async(prompt, generation_config={"response_mime_type": "application/json"})
        report_from_llm = json.loads(response.text)
        
        final_report = {
            "cultural_compatibility_score": cultural_score,
            "affinity_overlap_score": affinity_score,
            **report_from_llm
        }
        return final_report
        
    except Exception as e:
        logger.error(f"Final report synthesis failed: {e}")
        return {
            "strategic_summary": "Analysis failed during final synthesis. Key data may be missing.",
            "cultural_compatibility_score": cultural_score,
            "affinity_overlap_score": affinity_score,
            "brand_archetype_summary": {"acquirer_archetype": "N/A", "target_archetype": "N/A"},
            "corporate_ethos_summary": {"acquirer_ethos": "N/A", "target_ethos": "N/A"},
            "financial_synthesis": "N/A"
        }

# --- API Endpoints ---
@router.post("/draft", response_model=DraftReportResponse, status_code=status.HTTP_201_CREATED)
@rate_limiter(limit=30, seconds=60)
async def create_draft_report(session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    logger.info(f"User {current_user.email} creating new draft report.")
    new_report = models.Report(user_id=current_user.id, status=models.ReportStatus.DRAFT)
    session.add(new_report)
    await session.commit()
    await session.refresh(new_report)
    logger.success(f"Draft report {new_report.id} created for user {current_user.email}.")
    return new_report

@router.post("/{report_id}/upload_context_file", response_model=FileUploadResponse)
@rate_limiter(limit=30, seconds=60)
async def upload_context_file(report_id: uuid.UUID, file: UploadFile = File(...), session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    report = await session.get(models.Report, report_id)
    if not report or report.user_id != current_user.id:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Report not found or access denied.")
    extracted_text = await process_document_with_docling(file)
    report.extracted_file_context = extracted_text
    session.add(report)
    await session.commit()
    return FileUploadResponse(filename=file.filename, content_type=file.content_type or "application/octet-stream", size_in_bytes=file.size)

@router.post("/{report_id}/generate")
@rate_limiter(limit=30, seconds=60)
async def generate_full_report_stream(report_id: uuid.UUID, payload: ReportGeneratePayload, current_user: models.User = Depends(get_current_user)):
    
    async def event_generator() -> AsyncGenerator[str, None]:
        def format_sse_event(data: dict) -> str:
            raw_status = data.get("status")
            if raw_status in ["action", "observation", "thinking", "qloo_insight"]: return ""
            event_data = {"payload": data.get("payload")}
            if raw_status == "source": event_data['status'] = 'source'
            elif raw_status == "thought": event_data['status'] = 'reasoning'; event_data['message'] = data.get("message", "").replace('**Thought**:', '').strip()
            elif raw_status == "complete": return "" 
            elif raw_status == "error": event_data['status'] = 'error'; event_data['message'] = data.get("message")
            else:
                action_payload = data.get('payload', {}); tool_name = action_payload.get('tool_name')
                if 'qloo' in tool_name: event_data['status'] = 'analysis'; event_data['message'] = "Performing comparative cultural analysis..."
                elif 'persona_expansion_tool' in tool_name: event_data['status'] = 'analysis'; event_data['message'] = "Predicting latent synergies via Persona API..."
                elif 'corporate_culture' in tool_name: event_data['status'] = 'analysis'; event_data['message'] = f"Investigating corporate culture at {action_payload.get('parameters', {}).get('brand_name')}"
                elif 'financial_and_market' in tool_name: event_data['status'] = 'analysis'; event_data['message'] = f"Analyzing market position of {action_payload.get('parameters', {}).get('brand_name')}"
                elif 'web_search' in tool_name: event_data['status'] = 'search'; event_data['message'] = f"Researching: {action_payload.get('parameters', {}).get('query')}"
                else: event_data['status'] = 'info'; event_data['message'] = data.get("message")
            return f"data: {json.dumps(event_data)}\n\n"

        report_to_generate = None
        generation_succeeded = False
        try:
            async with postgres_db.get_session() as session:
                report_to_generate = await session.get(models.Report, report_id)
                if not report_to_generate or report_to_generate.user_id != current_user.id or report_to_generate.status != models.ReportStatus.DRAFT:
                    error_data = json.dumps({'status': 'error', 'message': "Report not found or cannot be generated."})
                    yield f"data: {error_data}\n\n"
                    return

                report_to_generate.acquirer_brand = payload.acquirer_brand
                report_to_generate.target_brand = payload.target_brand
                report_to_generate.title = payload.title
                report_to_generate.status = models.ReportStatus.PENDING
                session.add(report_to_generate)
                await session.commit()
            
            yield f"data: {json.dumps({'status': 'info', 'message': f'Starting analysis for {payload.acquirer_brand} vs. {payload.target_brand}'})}\n\n"

            agent = AlloyReActAgent(report_to_generate.acquirer_brand, report_to_generate.target_brand, (report_to_generate.extracted_file_context or "") + "\n" + (payload.context or ""))
            
            async for event in agent.run_stream():
                sse_event = format_sse_event(event)
                if sse_event: 
                    yield sse_event
                # Explicitly pass the qloo_insight event to the frontend
                if event.get("status") == "qloo_insight":
                    yield f"data: {json.dumps(event)}\n\n"
                if event.get("status") == "complete": 
                    break
            
            agent_final_data = agent.final_data if agent.final_data else {}
            
            yield f"data: {json.dumps({'status': 'synthesis', 'message': 'Synthesizing final report...'})}\n\n"
            final_report_summary = await synthesize_final_report(agent_final_data)

            yield f"data: {json.dumps({'status': 'saving', 'message': 'Saving final analysis to database'})}\n\n"
            async with postgres_db.get_session() as save_session:
                stmt = select(models.Report).where(models.Report.id == report_id).options(
                    selectinload(models.Report.analysis),
                    selectinload(models.Report.culture_clashes),
                    selectinload(models.Report.untapped_growths)
                )
                result = await save_session.execute(stmt)
                save_report = result.scalar_one_or_none()

                if not save_report:
                    raise Exception("Report not found during save operation.")
                
                save_report.analysis = models.ReportAnalysis(
                    report_id=save_report.id, 
                    cultural_compatibility_score=_safe_float(final_report_summary.get('cultural_compatibility_score')),
                    affinity_overlap_score=_safe_float(final_report_summary.get('affinity_overlap_score')),
                    brand_archetype_summary=json.dumps(final_report_summary.get('brand_archetype_summary', {})),
                    corporate_ethos_summary=json.dumps(final_report_summary.get('corporate_ethos_summary', {})),
                    strategic_summary=final_report_summary.get('strategic_summary', 'Analysis failed.'),
                    financial_synthesis=final_report_summary.get('financial_synthesis', 'Analysis failed.'),
                    persona_expansion_summary=json.dumps(agent_final_data.get('persona_expansion', {})),
                    acquirer_corporate_profile=str(agent_final_data.get('acquirer_culture_profile') or ""),
                    target_corporate_profile=str(agent_final_data.get('target_culture_profile') or ""),
                    acquirer_financial_profile=str(agent_final_data.get('acquirer_financial_profile') or ""),
                    target_financial_profile=str(agent_final_data.get('target_financial_profile') or ""),
                    search_sources=agent.all_sources.get('search_sources', []),
                    acquirer_sources=agent.all_sources.get('acquirer_sources', []),
                    target_sources=agent.all_sources.get('target_sources', []),
                    acquirer_culture_sources=agent.all_sources.get('acquirer_culture_sources', []),
                    target_culture_sources=agent.all_sources.get('target_culture_sources', []),
                    acquirer_financial_sources=agent.all_sources.get('acquirer_financial_sources', []),
                    target_financial_sources=agent.all_sources.get('target_financial_sources', [])
                )

                save_report.culture_clashes = [
                    models.CultureClash(report_id=save_report.id, **clash) 
                    for clash in agent_final_data.get('culture_clashes', [])
                ]
                save_report.untapped_growths = [
                    models.UntappedGrowth(report_id=save_report.id, **growth) 
                    for growth in agent_final_data.get('untapped_growths', [])
                ]
                
                save_report.status = models.ReportStatus.COMPLETED
                save_session.add(save_report)
                
                await save_session.commit()
                logger.success(f"Report {report_id}: Final report committed successfully.")
                generation_succeeded = True
            
            yield f"data: {json.dumps({'status': 'complete', 'message': 'Report generated successfully!', 'payload': {'reportId': str(report_id)}})}\n\n"
        except Exception as e:
            logger.error("Error in report generation stream for report {}: {}: {}", report_id, type(e).__name__, e, exc_info=True)
            yield f"data: {json.dumps({'status': 'error', 'message': f'An unexpected error occurred during report generation: {type(e).__name__}'})}\n\n"
        finally:
            if not generation_succeeded and report_to_generate: await mark_report_as_failed(report_id)

    return StreamingResponse(event_generator(), media_type="text/event-stream")

@router.get("/{report_id}/download-pdf")
@rate_limiter(limit=30, seconds=60)
async def download_report_pdf(report_id: uuid.UUID, session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    """Generates and downloads a professional PDF report."""
    logger.info(f"User {current_user.email} requested PDF for report {report_id}")
    
    statement = (
        select(models.Report)
        .where(models.Report.id == report_id, models.Report.user_id == current_user.id)
        .options(
            selectinload(models.Report.analysis),
            selectinload(models.Report.culture_clashes),
            selectinload(models.Report.untapped_growths)
        )
    )
    result = await session.execute(statement)
    report = result.scalar_one_or_none()
    
    if not report or report.status != models.ReportStatus.COMPLETED or not report.analysis:
        raise HTTPException(status.HTTP_404_NOT_FOUND, detail="Report not found or not complete.")

    try:
        acquirer_favicon_bytes, target_favicon_bytes = await asyncio.gather(
            fetch_favicon_bytes(report.acquirer_brand),
            fetch_favicon_bytes(report.target_brand)
        )

        llm_summary = {
            "strategic_summary": report.analysis.strategic_summary,
            "financial_synthesis": report.analysis.financial_synthesis,
            "brand_archetypes": json.loads(report.analysis.brand_archetype_summary) if report.analysis.brand_archetype_summary else {},
            "corporate_ethos": json.loads(report.analysis.corporate_ethos_summary) if report.analysis.corporate_ethos_summary else {}
        }
        
        pdf_bytes = create_report_pdf(
            report, 
            llm_summary,
            acquirer_favicon_bytes,
            target_favicon_bytes
        )
        
        filename = f"Alloy_Report_{report.acquirer_brand}_vs_{report.target_brand}.pdf"
        headers = {'Content-Disposition': f'attachment; filename="{filename}"'}
        return Response(content=pdf_bytes, media_type="application/pdf", headers=headers)
        
    except Exception as e:
        logger.error(f"Failed to generate PDF for report {report_id}: {e}", exc_info=True)
        raise HTTPException(status.HTTP_500_INTERNAL_SERVER_ERROR, "Failed to generate PDF report.")

@router.get("")
@rate_limiter(limit=30, seconds=60)
async def get_reports(session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    statement = (
        select(models.Report)
        .where(
            models.Report.user_id == current_user.id,
            models.Report.status != models.ReportStatus.DRAFT,
        )
        .order_by(models.Report.created_at.desc())
        .options(
            selectinload(models.Report.analysis),
            selectinload(models.Report.culture_clashes),
            selectinload(models.Report.untapped_growths),
        )
    )
    result = await session.execute(statement)
    db_reports = result.scalars().all()
    
    pydantic_reports = [models.ReportRead.model_validate(report) for report in db_reports]
    return [report.model_dump() for report in pydantic_reports]


@router.get("/{report_id}")
@rate_limiter(limit=30, seconds=60)
async def get_report(report_id: uuid.UUID, session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    statement = select(models.Report).where(models.Report.id == report_id, models.Report.user_id == current_user.id).options(selectinload(models.Report.analysis), selectinload(models.Report.culture_clashes), selectinload(models.Report.untapped_growths))
    result = await session.execute(statement)
    report = result.scalar_one_or_none()
    if not report or (report.status == models.ReportStatus.DRAFT and report.user_id != current_user.id): raise HTTPException(status.HTTP_404_NOT_FOUND, detail="Report not found")

    pydantic_report = models.ReportRead.model_validate(report)
    return pydantic_report.model_dump()


@router.delete("/{report_id}", status_code=status.HTTP_204_NO_CONTENT)
@rate_limiter(limit=30, seconds=60)
async def delete_report(report_id: uuid.UUID, session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    report_to_delete = await session.get(models.Report, report_id)
    if not report_to_delete or report_to_delete.user_id != current_user.id: raise HTTPException(status.HTTP_404_NOT_FOUND, detail="Report not found")
    await session.delete(report_to_delete); await session.commit()

@router.post("/{report_id}/chat", response_class=StreamingResponse)
@rate_limiter(limit=30, seconds=60)
async def chat_with_report(report_id: uuid.UUID, payload: ReportChatPayload, session: AsyncSession = Depends(get_session), current_user: models.User = Depends(get_current_user)):
    report = await session.get(models.Report, report_id)
    if not report or report.user_id != current_user.id: raise HTTPException(status.HTTP_404_NOT_FOUND, detail="Report not found.")
    async def stream_response():
        try:
            async for chunk in generate_chat_response(payload.messages, payload.context): yield chunk
        except Exception as e:
            logger.error(f"Error during chat stream for report {report_id}: {e}")
            yield "Sorry, I encountered an error while processing your request."
    return StreamingResponse(stream_response(), media_type="text/event-stream")-e 
-e

File: backend/src/api/__init__.py
-e 
-e

File: backend/src/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from src.core.settings import get_settings
from src.api.v1 import router as api_router
from src.utils import lifespan

settings = get_settings()

# --- FastAPI App Initialization ---
app = FastAPI(
    title="Alloy API",
    version="1.0.0",
    description="Backend services for the Alloy Cultural Due Diligence Platform.",
    lifespan=lifespan,
)

# --- CORS Middleware ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- API Routers ---
app.include_router(api_router, prefix="/api/v1", tags=["System"])-e 
-e

File: backend/src/services/react_agent.py
import httpx
import google.generativeai as genai
from typing import List, Dict, Any, AsyncGenerator, Optional, Tuple, Set
from loguru import logger
import json
import asyncio

from src.core.settings import get_settings
from src.services.search import web_search

settings = get_settings()
genai.configure(api_key=settings.GEMINI_API_KEY)

# --- Agent Tool Helpers ---

async def _summarize_with_gemini(context: str, query: str) -> str:
    """Summarizes a text context using Gemini, tailored to a specific query."""
    if not context.strip():
        return "No information found from web search."
    try:
        model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
        prompt = f"""
        Based *only* on the following text from a web search, provide a concise summary that directly answers the user's query.
        Focus on the most relevant facts, entities, and data points.

        USER QUERY: "{query}"

        SEARCH RESULTS CONTEXT:
        ---
        {context}
        ---

        CONCISE SUMMARY FOR AGENT:
        """
        response = await model.generate_content_async(prompt)
        return response.text.strip()
    except Exception as e:
        logger.error(f"Error during Gemini summarization: {e}")
        return "Could not summarize the search results due to an internal error."

async def _extract_cultural_proxies(context: str, brand_name: str) -> List[str]:
    """Uses an LLM to identify 3-5 key cultural products/properties from a text."""
    logger.info(f"Extracting cultural proxies for {brand_name}...")
    if not context.strip():
        return []
    try:
        model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
        prompt = f"""
        Based *only* on the provided text about '{brand_name}', identify the 3 to 5 most famous and culturally significant **named entities** associated with them.
        Focus on concrete, searchable items:
        - Specific products (e.g., "iPhone 15", "Air Jordan", "Model S")
        - Hit movies, TV shows, or video games (e.g., "Stranger Things", "Call of Duty")
        - Famous public figures or spokespeople (e.g., "Michael Jordan", "Taylor Swift")
        - Well-known sub-brands (e.g., "Pixar", "Marvel Studios")

        Do NOT return abstract concepts like "innovation" or "brand loyalty".

        CONTEXT:
        ---
        {context}
        ---

        Return a single JSON array of strings. If no specific items are found, return an empty array. Example: ["Famous Product A", "Popular Show B"]
        """
        response = await model.generate_content_async(prompt, generation_config={"response_mime_type": "application/json"})
        proxies = json.loads(response.text)
        logger.success(f"Extracted proxies for {brand_name}: {proxies}")
        return proxies
    except Exception as e:
        logger.error(f"Error during cultural proxy extraction for {brand_name}: {e}")
        return []


# FIXED: Updated Qloo API functions based on actual API structure
async def _find_qloo_id(client: httpx.AsyncClient, entity_name: str) -> Optional[Tuple[str, str]]:
    """
    FIXED VERSION: Uses correct Qloo API structure based on hackathon documentation.
    The API appears to use different endpoints and authentication methods.
    """
    headers = {
        "accept": "application/json",
        "x-api-key": settings.QLOO_API_KEY
    }
    
    base_url = "https://hackathon.api.qloo.com/v2"
    
    entity_variations = list(set([
        entity_name,
        entity_name.title(),
        entity_name.capitalize(),
        entity_name.lower()
    ]))

    for variation in entity_variations:
        if not variation: continue
            
        try:
            search_payload = {
                "query": variation,
                "filter": {
                    "type": [
                        "urn:entity:artist", "urn:entity:book", "urn:entity:brand",
                        "urn:entity:destination", "urn:entity:movie", "urn:entity:person",
                        "urn:entity:place", "urn:entity:podcast", "urn:entity:tv_show",
                        "urn:entity:video_game",
                    ]
                },
                "take": 1
            }
            resp = await client.get(f"{base_url}/search", params=search_payload, headers=headers, timeout=10.0)
            
            if resp.status_code == 200:
                data = resp.json()
                results = data.get("data", [])
                if results:
                    result = results[0]
                    qloo_id = result.get("id")
                    found_name = result.get("name", variation)
                    if qloo_id:
                        logger.success(f"Found Qloo match for '{variation}': '{found_name}' (ID: {qloo_id})")
                        return qloo_id, found_name
            elif resp.status_code == 429:
                logger.warning(f"Rate limited by Qloo API. Waiting...")
                await asyncio.sleep(2)
            else:
                logger.warning(f"Qloo search for '{variation}' returned status {resp.status_code}: {resp.text[:200]}")
                    
        except Exception as e:
            logger.error(f"Qloo API request failed for '{variation}': {e}")
            continue
                
    logger.warning(f"Could not find any Qloo entity for search term: '{entity_name}'")
    return None


async def _get_qloo_tastes(client: httpx.AsyncClient, qloo_id: str) -> List[Dict]:
    """
    FIXED VERSION: Updated to handle different API response formats and endpoints.
    """
    headers = {
        "accept": "application/json", 
        "x-api-key": settings.QLOO_API_KEY
    }
    
    base_url = "https://hackathon.api.qloo.com/v2"
    
    try:
        insights_payload = {"id": [qloo_id], "take": 50}
        resp = await client.get(f"{base_url}/insights", params=insights_payload, headers=headers, timeout=15.0)
        
        if resp.status_code == 200:
            data = resp.json()
            tastes = data.get("data", [])
            if tastes:
                logger.success(f"Successfully fetched {len(tastes)} tastes for ID {qloo_id}")
                return tastes
        elif resp.status_code == 429:
            logger.warning("Rate limited on tastes endpoint")
            await asyncio.sleep(2)
        else:
            logger.warning(f"Tastes endpoint returned {resp.status_code}: {resp.text[:200]}")
                    
    except Exception as e:
        logger.error(f"Failed to fetch Qloo tastes for ID {qloo_id}: {e}")
            
    logger.error(f"Could not fetch tastes for ID {qloo_id}")
    return []


async def _get_tastes_for_term(client: httpx.AsyncClient, term: str) -> Tuple[Optional[str], Set[str]]:
    """Updated version using fixed Qloo functions."""
    qloo_info = await _find_qloo_id(client, term)
    if qloo_info:
        qloo_id = qloo_info[0]
        tastes = await _get_qloo_tastes(client, qloo_id)
        if tastes:
            logger.info(f"Found {len(tastes)} tastes for '{term}' (ID: {qloo_id})")
            taste_names = {t.get('name') for t in tastes if t.get('name')}
            return qloo_id, taste_names
        else:
            logger.warning(f"Found Qloo ID for '{term}' but it has no taste data.")
    return None, set()


# --- Updated Agent Tools ---

async def _web_search_tool(query: str) -> Dict[str, Any]:
    """Performs a web search, summarizes results, and returns summary and sources."""
    logger.info(f"AGENT TOOL: Web Search with query: '{query}'")
    search_result = await web_search(query)
    summary = await _summarize_with_gemini(search_result['context_str'], query)
    return {"context_str": summary, "sources": search_result["sources"]}

async def _corporate_culture_tool(brand_name: str) -> Dict[str, Any]:
    """Researches the corporate culture, values, leadership, and workplace environment of a brand."""
    logger.info(f"AGENT TOOL: Corporate Culture search for brand: '{brand_name}'")
    query = f"corporate culture, values, leadership, and workplace environment for {brand_name}"
    search_result = await web_search(query)
    summary = await _summarize_with_gemini(search_result['context_str'], query)
    return {"context_str": summary, "sources": search_result["sources"]}

async def _financial_and_market_tool(brand_name: str) -> Dict[str, Any]:
    """Researches the financial profile, market position, and recent financial news of a brand."""
    logger.info(f"AGENT TOOL: Financial/Market search for brand: '{brand_name}'")
    query = f"financial profile, market position, revenue, and recent financial news for {brand_name}"
    search_result = await web_search(query)
    summary = await _summarize_with_gemini(search_result['context_str'], query)
    return {"context_str": summary, "sources": search_result["sources"]}


async def intelligent_cultural_analysis_tool(acquirer_brand_name: str, target_brand_name: str) -> Dict[str, Any]:
    """
    FIXED VERSION: Updated with proper error handling and fallback strategies for Qloo API issues.
    """
    logger.info(f"AGENT TOOL: INTELLIGENT Cultural Analysis for '{acquirer_brand_name}' vs '{target_brand_name}'")

    # Helper to perform the analysis on any two sets of tastes
    def _analyze_tastes(acquirer_tastes: Set[str], target_tastes: Set[str], method: str, proxies: dict) -> dict:
        shared_tastes = list(acquirer_tastes.intersection(target_tastes))
        union_size = len(acquirer_tastes.union(target_tastes))
        unique_to_acquirer = list(acquirer_tastes - target_tastes)
        unique_to_target = list(target_tastes - acquirer_tastes)

        culture_clashes = []
        for interest in unique_to_acquirer[:5]:
            culture_clashes.append({
                "topic": interest, 
                "description": "The Acquirer's audience ecosystem shows a strong affinity for this, a taste not shared by the Target's.", 
                "severity": "MEDIUM"
            })
        for interest in unique_to_target[:5]:
            culture_clashes.append({
                "topic": interest, 
                "description": "The Target's audience ecosystem shows a strong affinity for this, a taste not shared by the Acquirer's.", 
                "severity": "HIGH"
            })
            
        untapped_growths = []
        for interest in shared_tastes[:5]:
            untapped_growths.append({
                "description": f"Both audience ecosystems show a strong affinity for '{interest}'. This shared passion could be a key pillar for joint marketing campaigns.", 
                "potential_impact_score": 8
            })

        return {
            "context_str": json.dumps({
                "affinity_overlap_score": round((len(shared_tastes) / union_size * 100), 2) if union_size > 0 else 0,
                "shared_affinities_top_5": shared_tastes[:5],
                "acquirer_unique_tastes_top_5": unique_to_acquirer[:5],
                "target_unique_tastes_top_5": unique_to_target[:5],
                "analysis_method": method,
                "analysis_proxies": proxies,
            }),
            "qloo_insights_for_stream": { 
                "shared": shared_tastes[:5], 
                "acquirer_unique": unique_to_acquirer[:5], 
                "target_unique": unique_to_target[:5] 
            },
            "culture_clashes": culture_clashes,
            "untapped_growths": untapped_growths,
        }

    timeout_config = httpx.Timeout(connect=10.0, read=30.0, write=10.0, pool=30.0)
    async with httpx.AsyncClient(timeout=timeout_config) as client:
        acquirer_profile_result = await _web_search_tool(f"famous products and cultural properties of {acquirer_brand_name}")
        target_profile_result = await _web_search_tool(f"famous products and cultural properties of {target_brand_name}")
            
        try:
            acquirer_proxies = await _extract_cultural_proxies(acquirer_profile_result['context_str'], acquirer_brand_name)
            target_proxies = await _extract_cultural_proxies(target_profile_result['context_str'], target_brand_name)
            
            acquirer_search_terms = list(set([acquirer_brand_name] + acquirer_proxies))
            target_search_terms = list(set([target_brand_name] + target_proxies))
            
            logger.info(f"Primary Analysis - Acquirer Terms: {acquirer_search_terms}")
            logger.info(f"Primary Analysis - Target Terms: {target_search_terms}")

            semaphore = asyncio.Semaphore(2)
            async def _get_tastes_with_retry(term):
                async with semaphore:
                    await asyncio.sleep(0.5)
                    _, tastes = await _get_tastes_for_term(client, term)
                    return tastes

            acquirer_tasks = [_get_tastes_with_retry(term) for term in acquirer_search_terms]
            target_tasks = [_get_tastes_with_retry(term) for term in target_search_terms]
            
            primary_acquirer_results, primary_target_results = await asyncio.gather(
                asyncio.gather(*acquirer_tasks), 
                asyncio.gather(*target_tasks)
            )
            
            aggregated_acquirer_tastes = set().union(*[r for r in primary_acquirer_results if r])
            aggregated_target_tastes = set().union(*[r for r in primary_target_results if r])

            if aggregated_acquirer_tastes and aggregated_target_tastes:
                logger.success("Primary analysis successful with aggregated proxy data.")
                analysis = _analyze_tastes(aggregated_acquirer_tastes, aggregated_target_tastes, "Intelligent Proxy", {"acquirer": acquirer_search_terms, "target": target_search_terms})
                return {**analysis, "sources": acquirer_profile_result.get('sources', []) + target_profile_result.get('sources', [])}

            logger.warning("Primary proxy analysis failed. Attempting direct brand-to-brand fallback.")
            fallback_acquirer_tastes, fallback_target_tastes = await asyncio.gather(_get_tastes_with_retry(acquirer_brand_name), _get_tastes_with_retry(target_brand_name))

            if fallback_acquirer_tastes and fallback_target_tastes:
                logger.success("Fallback analysis successful with direct brand data.")
                analysis = _analyze_tastes(fallback_acquirer_tastes, fallback_target_tastes, "Direct Brand Fallback", {"acquirer": [acquirer_brand_name], "target": [target_brand_name]})
                return {**analysis, "sources": acquirer_profile_result.get('sources', []) + target_profile_result.get('sources', [])}

        except Exception as e:
            logger.error(f"Critical error in cultural analysis: {e}")

    logger.warning("Qloo API unavailable. Falling back to web-search-based cultural analysis.")
    return await _web_search_cultural_fallback(acquirer_brand_name, target_brand_name, acquirer_profile_result, target_profile_result)
    

async def _web_search_cultural_fallback(acquirer_brand: str, target_brand: str, acquirer_profile: dict, target_profile: dict) -> Dict[str, Any]:
    """
    NEW: Fallback cultural analysis using only web search data when Qloo API fails.
    """
    try:
        model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
        prompt = f"""
        Based on the following information about two companies, perform a cultural analysis for a potential acquisition.
        
        ACQUIRER: {acquirer_brand}
        Profile: {acquirer_profile.get('context_str', 'No data available')}
        
        TARGET: {target_brand}  
        Profile: {target_profile.get('context_str', 'No data available')}
        
        Provide a JSON response with:
        1. "affinity_overlap_score": A number from 0-100 representing how well you estimate the brands' cultures and target audiences align.
        2. "shared_affinities_top_5": A list of 5 shared cultural elements, values, or audience characteristics.
        3. "acquirer_unique_tastes_top_5": A list of 5 unique aspects of the acquirer's culture or audience.
        4. "target_unique_tastes_top_5": A list of 5 unique aspects of the target's culture or audience.
        5. "analysis_method": A string with the value "Web Search Fallback".
        
        Focus on cultural values, audience demographics, brand positioning, and market presence.
        """
        
        response = await model.generate_content_async(prompt, generation_config={"response_mime_type": "application/json"})
        analysis_data = json.loads(response.text)
        
        shared = analysis_data.get("shared_affinities_top_5", [])
        acquirer_unique = analysis_data.get("acquirer_unique_tastes_top_5", [])
        target_unique = analysis_data.get("target_unique_tastes_top_5", [])
        
        culture_clashes = [{"topic": item, "description": f"Unique cultural aspect of {acquirer_brand}", "severity": "MEDIUM"} for item in acquirer_unique[:3]] + \
                          [{"topic": item, "description": f"Unique cultural aspect of {target_brand}", "severity": "HIGH"} for item in target_unique[:3]]
        
        untapped_growths = [{"description": f"Both brands share '{item}' as a cultural element", "potential_impact_score": 7} for item in shared[:3]]
        
        return {
            "context_str": json.dumps(analysis_data),
            "qloo_insights_for_stream": {"shared": shared, "acquirer_unique": acquirer_unique, "target_unique": target_unique},
            "culture_clashes": culture_clashes,
            "untapped_growths": untapped_growths,
            "sources": acquirer_profile.get('sources', []) + target_profile.get('sources', [])
        }
        
    except Exception as e:
        logger.error(f"Web search fallback analysis failed: {e}")
        return {"context_str": json.dumps({"error": "Cultural analysis unavailable", "affinity_overlap_score": 0, "analysis_method": "Failed Fallback"}), "culture_clashes": [], "untapped_growths": [], "sources": []}


async def _persona_expansion_fallback(acquirer_brand: str, target_brand: str, acquirer_profile: dict, target_profile: dict) -> Dict[str, Any]:
    """
    NEW: Fallback for persona expansion using only web search data.
    """
    logger.warning("Qloo Persona API unavailable. Falling back to web-search-based expansion analysis.")
    try:
        model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
        prompt = f"""
        Based on the provided company profiles, analyze the potential for audience expansion if the acquirer buys the target.

        ACQUIRER: {acquirer_brand}
        Profile: {acquirer_profile.get('context_str', 'No data available')}
        
        TARGET: {target_brand}  
        Profile: {target_profile.get('context_str', 'No data available')}

        Provide a JSON response with:
        1. "expansion_score": An estimated score (0-100) of how well the target's audience and products could be adopted by the acquirer's audience.
        2. "latent_synergies": A list of the top 3-5 specific products, services, or brand attributes from the target that are most likely to appeal to the acquirer's audience.
        3. "analysis": A brief text summary explaining your reasoning for the score and synergies.
        """
        response = await model.generate_content_async(prompt, generation_config={"response_mime_type": "application/json"})
        return {"context_str": response.text}
    except Exception as e:
        logger.error(f"Persona expansion fallback analysis failed: {e}")
        return {"context_str": json.dumps({"error": "Persona expansion analysis unavailable.", "expansion_score": 0, "latent_synergies": []})}

async def persona_expansion_tool(acquirer_brand_name: str, target_brand_name: str) -> Dict[str, Any]:
    """
    FIXED VERSION: Updated persona expansion with better error handling and fallback strategies.
    """
    logger.info(f"AGENT TOOL: PERSONA EXPANSION for '{acquirer_brand_name}' vs '{target_brand_name}'")

    timeout_config = httpx.Timeout(connect=10.0, read=60.0, write=10.0, pool=60.0)
    async with httpx.AsyncClient(timeout=timeout_config) as client:
        acquirer_profile = await _web_search_tool(f"famous products and cultural properties of {acquirer_brand_name}")
        target_profile = await _web_search_tool(f"famous products and cultural properties of {target_brand_name}")
        
        try:
            acquirer_proxies = await _extract_cultural_proxies(acquirer_profile['context_str'], acquirer_brand_name)
            acquirer_search_terms = list(set([acquirer_brand_name] + acquirer_proxies))

            target_proxies = await _extract_cultural_proxies(target_profile['context_str'], target_brand_name)
            target_search_terms = list(set([target_brand_name] + target_proxies))

            semaphore = asyncio.Semaphore(2)
            async def get_tastes_with_limit(term: str) -> Tuple[Optional[str], Set[str]]:
                async with semaphore:
                    await asyncio.sleep(0.5)
                    return await _get_tastes_for_term(client, term)

            acquirer_tasks = [get_tastes_with_limit(term) for term in acquirer_search_terms]
            target_tasks = [get_tastes_with_limit(term) for term in target_search_terms]
            
            acquirer_results, target_results = await asyncio.gather(asyncio.gather(*acquirer_tasks), asyncio.gather(*target_tasks))

            acquirer_ids = [res[0] for res in acquirer_results if res[0]]
            target_actual_tastes = set().union(*(res[1] for res in target_results if res[1]))
            
            if not acquirer_ids or not target_actual_tastes:
                return await _persona_expansion_fallback(acquirer_brand_name, target_brand_name, acquirer_profile, target_profile)

            logger.info(f"Building Acquirer Persona from IDs: {acquirer_ids}")
            
            headers = {"accept": "application/json", "x-api-key": settings.QLOO_API_KEY}
            base_url = "https://hackathon.api.qloo.com/v2"
            
            persona_payload = {"include": {"id": acquirer_ids}, "category": ["tv_show", "movie", "brand", "person", "music_artist", "video_game"], "take": 100}
            resp = await client.get(f"{base_url}/persona/tastes", params=persona_payload, headers=headers, timeout=30.0)
            
            if resp.status_code != 200:
                logger.warning(f"Persona API failed with status {resp.status_code}, using fallback.")
                return await _persona_expansion_fallback(acquirer_brand_name, target_brand_name, acquirer_profile, target_profile)
            
            persona_tastes = resp.json().get("data", [])
            acquirer_predicted_tastes = {t['name'] for t in persona_tastes if 'name' in t}
            
            latent_synergy = acquirer_predicted_tastes.intersection(target_actual_tastes)
            expansion_score = round((len(latent_synergy) / len(target_actual_tastes)) * 100, 2) if target_actual_tastes else 0
            
            result = {
                "expansion_score": expansion_score,
                "latent_synergies": list(latent_synergy)[:10],
                "analysis": f"The acquirer's audience shows a predicted affinity for {len(latent_synergy)} of the target's core cultural products, indicating an expansion potential of {expansion_score}%.",
            }
            return {"context_str": json.dumps(result)}

        except Exception as e:
            logger.error(f"Critical error in persona expansion tool: {e}")
            return await _persona_expansion_fallback(acquirer_brand_name, target_brand_name, acquirer_profile, target_profile)

# --- The Stateful ReAct Agent ---
class AlloyReActAgent:
    PROMPT_TEMPLATE = """
    You are a sophisticated strategic analyst AI for a financial firm specializing in M&A cultural analysis.
    Your job is to execute a strategic sequence of tool calls to gather comprehensive data about two companies and their cultural overlap, synergies, and expansion potential.
    Do not synthesize or generate the final report yourself. Simply gather the data methodically and pass it to the 'finish' tool.

    **STRATEGIC ANALYSIS WORKFLOW:**
    1.  **Basic Profiling**: Use `web_search` for both the acquirer and target to get a general company profile.
    2.  **Corporate Culture**: Use `corporate_culture_tool` for both companies to understand their internal values and work environment.
    3.  **Financial Analysis**: Use `financial_and_market_tool` for both companies to assess their financial health and market position.
    4.  **Deep Cultural Analysis**: Use `intelligent_cultural_analysis_tool` once to perform a deep comparison using Qloo data. This is a critical step.
    5.  **Persona Expansion**: After the cultural analysis, use `persona_expansion_tool` once to analyze latent synergies and predictive growth.
    6.  **Finish**: Once all data is gathered, call the `finish` tool.

    **AVAILABLE TOOLS:**
    - `web_search(query: str)`: For general company profile research. Use a query like "Apple Inc. company profile".
    - `corporate_culture_tool(brand_name: str)`: To get specific information on a company's culture, values, and leadership.
    - `financial_and_market_tool(brand_name: str)`: To get specific information on a company's financial health and market position.
    - `intelligent_cultural_analysis_tool(acquirer_brand_name: str, target_brand_name: str)`: For deep cultural analysis.
    - `persona_expansion_tool(acquirer_brand_name: str, target_brand_name: str)`: For predictive analysis of latent synergies.
    - `finish(gathered_data: dict)`: Use this ONLY when all strategic analysis steps are complete.

    **RESPONSE FORMAT (JSON ONLY):**
    You MUST respond with a single JSON object containing a "thought" and an "action".
    
    Example:
    ```json
    {{
      "thought": "I have completed the basic profiling for the acquirer. Now I will do the same for the target.",
      "action": {{
        "tool_name": "web_search",
        "parameters": {{
          "query": "{target_brand} company profile"
        }}
      }}
    }}
    ```

    **CURRENT TASK:**
    Conduct a comprehensive strategic analysis for the acquisition of target **{target_brand}** by acquirer **{acquirer_brand}**.
    User-provided context: {user_context}

    **COMPLETED STEPS:**
    {completed_steps}
    
    **PREVIOUS ACTIONS LOG:**
    {scratchpad}

    Based on the completed steps and previous actions, what is the next logical strategic analysis action? Focus on completing the workflow systematically. Return ONLY the JSON object.
    """

    def __init__(self, acquirer_brand: str, target_brand: str, user_context: str | None = None):
        self.acquirer_brand = acquirer_brand
        self.target_brand = target_brand
        self.user_context = user_context or "None"
        self.model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
        self.completed_steps: Set[str] = set()
        self.scratchpad = "" 
        self.gathered_data = {} 
        self.final_data = None
        self.tools = {
            "web_search": _web_search_tool,
            "intelligent_cultural_analysis_tool": intelligent_cultural_analysis_tool,
            "persona_expansion_tool": persona_expansion_tool,
            "corporate_culture_tool": _corporate_culture_tool,
            "financial_and_market_tool": _financial_and_market_tool
        }
        self.all_sources: Dict[str, List[Dict[str, str]]] = {
            'acquirer_sources': [], 'target_sources': [], 'search_sources': [],
            'acquirer_culture_sources': [], 'target_culture_sources': [],
            'acquirer_financial_sources': [], 'target_financial_sources': []
        }

    def _build_prompt(self) -> str:
        completed_steps_str = "\n".join(f"- {step}" for step in sorted(list(self.completed_steps))) or "None"
        scratchpad_log = "\n".join(self.scratchpad.splitlines()[-10:])
        return self.PROMPT_TEMPLATE.format(
            acquirer_brand=self.acquirer_brand,
            target_brand=self.target_brand,
            user_context=self.user_context,
            completed_steps=completed_steps_str,
            scratchpad=scratchpad_log
        )

    async def run_stream(self) -> AsyncGenerator[Dict[str, Any], None]:
        max_turns = 12
        for i in range(max_turns):
            yield {"status": "thinking", "message": f"Strategic analysis step {i+1}/{max_turns}"}
            
            prompt = self._build_prompt()
            response_text = await self._get_llm_response(prompt)
            
            try:
                response_json = json.loads(response_text)
                thought = response_json.get("thought", "No thought provided.")
                action_json = response_json.get("action", {})
                yield {"status": "thought", "message": thought}
                yield {"status": "action", "payload": action_json}
            except (json.JSONDecodeError, AttributeError) as e:
                logger.error(f"Agent response was not valid JSON: {e}. Raw response: {response_text}")
                observation = f"Error: The previous response was not valid JSON. Correct the format. Error: {e}"
                self.scratchpad += f"\n**Observation**: {observation}"
                continue

            tool_name, params = action_json.get("tool_name"), action_json.get("parameters", {})
            
            if not tool_name:
                observation = "Error: Your action JSON is missing the 'tool_name' key."
            elif tool_name == "finish":
                self.final_data = self.gathered_data
                yield {"status": "complete"}
                return
            elif tool_name not in self.tools:
                observation = f"Error: Unknown tool '{tool_name}'."
            else:
                try:
                    tool_function = self.tools[tool_name]
                    tool_result = await tool_function(**params)
                    
                    observation = tool_result.get('context_str', f"Tool {tool_name} ran successfully.")
                    sources = tool_result.get('sources', [])

                    if tool_name == "intelligent_cultural_analysis_tool" and "qloo_insights_for_stream" in tool_result:
                        yield {"status": "qloo_insight", "payload": {"type": "cultural_analysis", **tool_result["qloo_insights_for_stream"]}}

                    # --- State and Data Management ---
                    query = params.get('query', '').lower()
                    brand_name_param = params.get('brand_name', '')
                    is_acquirer = self.acquirer_brand.lower() in query or self.acquirer_brand == brand_name_param
                    is_target = self.target_brand.lower() in query or self.target_brand == brand_name_param

                    if tool_name == "web_search":
                        if is_acquirer:
                            self.completed_steps.add("searched_acquirer_profile")
                            self.gathered_data['acquirer_profile'] = observation
                            self.all_sources['acquirer_sources'].extend(sources)
                        elif is_target:
                            self.completed_steps.add("searched_target_profile")
                            self.gathered_data['target_profile'] = observation
                            self.all_sources['target_sources'].extend(sources)
                    elif tool_name == "corporate_culture_tool":
                        if is_acquirer:
                            self.completed_steps.add("searched_acquirer_culture")
                            self.gathered_data['acquirer_culture_profile'] = observation
                            self.all_sources['acquirer_culture_sources'].extend(sources)
                        elif is_target:
                            self.completed_steps.add("searched_target_culture")
                            self.gathered_data['target_culture_profile'] = observation
                            self.all_sources['target_culture_sources'].extend(sources)
                    elif tool_name == "financial_and_market_tool":
                        if is_acquirer:
                            self.completed_steps.add("searched_acquirer_financial")
                            self.gathered_data['acquirer_financial_profile'] = observation
                            self.all_sources['acquirer_financial_sources'].extend(sources)
                        elif is_target:
                            self.completed_steps.add("searched_target_financial")
                            self.gathered_data['target_financial_profile'] = observation
                            self.all_sources['target_financial_sources'].extend(sources)
                    elif tool_name == "intelligent_cultural_analysis_tool":
                        self.completed_steps.add("performed_intelligent_qloo_analysis")
                        self.all_sources['search_sources'].extend(sources)
                        try:
                            self.gathered_data['qloo_analysis'] = json.loads(observation)
                            self.gathered_data['culture_clashes'] = tool_result.get('culture_clashes', [])
                            self.gathered_data['untapped_growths'] = tool_result.get('untapped_growths', [])
                        except (json.JSONDecodeError, TypeError): self.gathered_data['qloo_analysis'] = {"error": observation}
                    elif tool_name == "persona_expansion_tool":
                        self.completed_steps.add("performed_persona_expansion")
                        try: self.gathered_data['persona_expansion'] = json.loads(observation)
                        except (json.JSONDecodeError, TypeError): self.gathered_data['persona_expansion'] = {"error": observation}
                    
                    for source in sources: yield {"status": "source", "payload": source}

                except Exception as e:
                    logger.error(f"Error executing tool '{tool_name}': {e}", exc_info=True)
                    observation = f"Error: {e}"

            self.scratchpad += f"\nAction: {json.dumps(action_json)}\nObservation: {observation}"
            yield {"status": "observation", "message": f"Completed {tool_name}"}

        logger.warning("Agent exceeded maximum turns.")
        self.final_data = self.gathered_data
        yield {"status": "complete"}

    async def _get_llm_response(self, prompt) -> str:
        try:
            generation_config = {"response_mime_type": "application/json"}
            response = await self.model.generate_content_async(prompt, generation_config=generation_config)
            return response.text
        except Exception as e:
            logger.error(f"Gemini API call failed: {e}")
            return json.dumps({"thought": "A critical error occurred with the LLM. I must finish now.", "action": {"tool_name": "finish", "parameters": {"gathered_data": self.gathered_data}}})-e 
-e

File: backend/src/services/docling.py
from fastapi import UploadFile, HTTPException, status
from loguru import logger
import openpyxl # type: ignore
from pypdf import PdfReader
import io

async def process_document_with_docling(file: UploadFile) -> str:
    """
    Simulates a "Docling" service.
    Processes an uploaded file (PDF, XLSX, TXT, MD) and extracts text content.
    """
    content_type = file.content_type
    logger.info(f"Processing file '{file.filename}' with content type: {content_type}")
    
    file_bytes = await file.read()
    text_content = ""
    
    try:
        if content_type == "application/pdf":
            reader = PdfReader(io.BytesIO(file_bytes))
            for page in reader.pages:
                text_content += page.extract_text() or ""
        
        elif content_type in ["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "application/vnd.ms-excel"]:
            workbook = openpyxl.load_workbook(io.BytesIO(file_bytes), data_only=True)
            for sheet_name in workbook.sheetnames:
                sheet = workbook[sheet_name]
                text_content += f"\n--- Sheet: {sheet_name} ---\n"
                for row in sheet.iter_rows():
                    row_text = "\t".join([str(cell.value) if cell.value is not None else "" for cell in row])
                    text_content += row_text + "\n"

        elif content_type in ["text/plain", "text/markdown"]:
            text_content = file_bytes.decode("utf-8", errors="ignore")

        else:
            raise HTTPException(
                status_code=status.HTTP_415_UNSUPPORTED_MEDIA_TYPE,
                detail=f"Unsupported file type: {content_type}. Please upload PDF, Excel, TXT, or MD files."
            )
            
        logger.success(f"Successfully extracted text from '{file.filename}'.")
        return text_content.strip()

    except Exception as e:
        logger.error(f"Failed to process file '{file.filename}': {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to process file: {str(e)}"
        )-e 
-e

File: backend/src/services/pdf_generator.py
import google.generativeai as genai
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer
from reportlab.lib.units import inch
from reportlab.lib import colors
from datetime import datetime
import io
import json
from loguru import logger
from typing import Optional

from src.db import models
from src.core.settings import get_settings
from src.services.pdf_layouts import (
    get_pdf_styles,
    create_header,
    create_title_section,
    create_key_metrics_table,
    create_corporate_culture_section,
    create_financial_analysis_section,
    create_clashes_table,
    create_growth_table,
    create_brand_archetypes_section
)

settings = get_settings()
genai.configure(api_key=settings.GEMINI_API_KEY)


def create_report_pdf(
    report: models.Report, 
    llm_summary: dict,
    acquirer_favicon_bytes: Optional[bytes],
    target_favicon_bytes: Optional[bytes]
) -> bytes:
    """
    Assembles the PDF from static templates and LLM-generated content using reportlab.
    """
    logger.info(f"Assembling PDF for report {report.id} using ReportLab.")
    
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer,
                            rightMargin=0.75*inch,
                            leftMargin=0.75*inch,
                            topMargin=0.75*inch,
                            bottomMargin=1.0*inch,
                            title=report.title) # Set the document title metadata
    
    styles = get_pdf_styles()
    story = []

    story.extend(create_header(styles))
    # THE FIX: Pass the favicon bytes to the title section layout function.
    story.extend(create_title_section(report, styles, acquirer_favicon_bytes, target_favicon_bytes))
    story.extend(create_key_metrics_table(report, doc.width, styles))
    
    # --- Main Qualitative Summaries ---
    story.append(Paragraph("Strategic Summary", styles['h2']))
    story.append(Paragraph(llm_summary.get("strategic_summary", "N/A").replace('\n', '<br/>'), styles['default']))
    story.append(Spacer(1, 0.3*inch))
    
    # Add the new sections
    story.extend(create_financial_analysis_section(llm_summary, styles))
    story.extend(create_corporate_culture_section(report, llm_summary, doc.width, styles, acquirer_favicon_bytes, target_favicon_bytes))
    story.extend(create_brand_archetypes_section(report, llm_summary, styles, acquirer_favicon_bytes, target_favicon_bytes))

    # --- Detailed Data Tables ---
    story.extend(create_clashes_table(report, doc.width, styles))
    story.extend(create_growth_table(report, doc.width, styles))
    
    def on_page(canvas, doc):
        canvas.saveState()
        canvas.setFont('Helvetica', 8)
        canvas.setFillColor(colors.grey)
        footer_text = f"Report ID: {report.id} | Confidential & Proprietary  {datetime.now().year} Alloy"
        canvas.drawCentredString(doc.width/2 + doc.leftMargin, 0.5 * inch, footer_text)
        canvas.restoreState()

    doc.build(story, onFirstPage=on_page, onLaterPages=on_page)
    
    pdf_bytes = buffer.getvalue()
    buffer.close()
    logger.success(f"Successfully assembled PDF for report {report.id}.")
    return pdf_bytes-e 
-e

File: backend/src/services/report_generator.py
import google.generativeai as genai
from typing import List, Dict, Any, AsyncGenerator
from loguru import logger
import json

from src.core.settings import get_settings
from src.services.search import web_search

settings = get_settings()
genai.configure(api_key=settings.GEMINI_API_KEY)
QLOO_BASE_URL = "https://hackathon.api.qloo.com"

async def get_corporate_profile_via_search(brand_name: str) -> Dict[str, Any]:
    """
    Performs a Tavily search and returns the entire result object,
    including the context string and the list of sources.
    """
    logger.info(f"Performing Tavily search for corporate profile of '{brand_name}'")
    query = f"Corporate profile, brand identity, key products, and target audience for '{brand_name}'"
    search_result = await web_search(query)
    return search_result


# --- Analysis Functions (Unchanged) ---
def calculate_affinity_overlap(acquirer_data: List[Dict], target_data: List[Dict]) -> float:
    if not acquirer_data or not target_data: return 0.0
    acquirer_interests = {item.get('name') for item in acquirer_data if item.get('name')}
    target_interests = {item.get('name') for item in target_data if item.get('name')}
    intersection = len(acquirer_interests.intersection(target_interests))
    union = len(acquirer_interests.union(target_interests))
    return round((intersection / union) * 100, 2) if union > 0 else 0.0
def find_culture_clashes(acquirer_data: List[Dict], target_data: List[Dict]) -> List[Dict[str, Any]]:
    acquirer_interests = {item.get('name') for item in acquirer_data if item.get('name')}
    target_interests = {item.get('name') for item in target_data if item.get('name')}
    unique_to_acquirer = acquirer_interests - target_interests
    unique_to_target = target_interests - acquirer_interests
    clashes = []
    for interest in list(unique_to_acquirer)[:5]:
        clashes.append({"topic": interest, "description": "Audience shows strong affinity for this, a taste not shared by the Target's audience.", "severity": "MEDIUM"})
    for interest in list(unique_to_target)[:5]:
         clashes.append({"topic": interest, "description": "Audience shows strong affinity for this, a taste not shared by the Acquirer's audience.", "severity": "HIGH"})
    return clashes
def find_untapped_growth(acquirer_data: List[Dict], target_data: List[Dict]) -> List[Dict[str, Any]]:
    #...
    acquirer_interests = {item.get('name') for item in acquirer_data if item.get('name')}
    target_interests = {item.get('name') for item in target_data if item.get('name')}
    shared_interests = acquirer_interests.intersection(target_interests)
    opportunities = []
    for interest in list(shared_interests)[:5]:
        opportunities.append({"description": f"Both audiences show a strong affinity for '{interest}'. This shared passion point could be a key pillar for joint marketing campaigns and product integrations post-acquisition.", "potential_impact_score": 8})
    return opportunities


async def generate_chat_response(messages: List[Dict[str, Any]], report_context: str) -> AsyncGenerator[str, None]:
    """
    Generates a conversational response from the LLM, maintaining chat history.
    """
    model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
    
    # Map our role names ('assistant') to Gemini's ('model')
    gemini_history = []
    for msg in messages:
        role = "model" if msg["role"] in ["assistant", "bot"] else "user"
        gemini_history.append({'role': role, 'parts': [msg['content']]})

    # The system prompt and report context are prepended to the very first user message
    # to give the model its instructions and the necessary data context for the entire conversation.
    if gemini_history and gemini_history[0]['role'] == 'user':
        first_user_content = gemini_history[0]['parts'][0]
        system_and_report_context = f"""
You are an expert M&A analyst acting as a follow-up assistant. Your sole task is to answer questions based *only* on the provided report context and the ongoing conversation. Do not use any outside knowledge or make up information. If the answer is not in the context, state that clearly. Provide concise, professional answers. Format your response using Markdown.
---
**REPORT CONTEXT:**
{report_context}
---
**USER'S FIRST QUESTION:**
{first_user_content}
"""
        gemini_history[0]['parts'] = [system_and_report_context]
    
    # The last message is the new query, the rest is history
    history_for_chat = gemini_history[:-1]
    new_query_content = gemini_history[-1]['parts'][0] if gemini_history else ""

    if not new_query_content:
        yield "I'm sorry, I didn't receive a question. Please try again."
        return

    try:
        chat = model.start_chat(history=history_for_chat)
        response_stream = await chat.send_message_async(new_query_content, stream=True)
        async for chunk in response_stream:
            yield chunk.text
    except Exception as e:
        logger.error(f"Gemini chat stream failed: {e}")
        yield "There was an error processing your request. Please try again."-e 
-e

File: backend/src/services/search.py
from tavily import TavilyClient
from src.core.settings import get_settings
from loguru import logger
from typing import Dict, List, Any, TypedDict, Optional
import google.generativeai as genai
from urllib.parse import urlparse

settings = get_settings()
if settings.GEMINI_API_KEY:
    genai.configure(api_key=settings.GEMINI_API_KEY)


class TavilySearchToolOutput(TypedDict):
    context_str: str
    sources: List[Dict[str, str]]

async def web_search(query: str) -> TavilySearchToolOutput:
    """
    Performs a search using the Tavily API and returns a structured dictionary
    containing the formatted results for an LLM and a list of sources.
    """
    if not settings.TAVILY_API_KEY:
        logger.warning("Tavily API key is not set. Skipping search.")
        return {
            "context_str": "Tavily search was not performed because the API key is missing.",
            "sources": []
        }

    try:
        client = TavilyClient(api_key=settings.TAVILY_API_KEY)
        response = client.search(
            query=query,
            search_depth="advanced",
            max_results=5
        )

        # Format the results into a string for the LLM prompt
        context_str = "\n\n".join(
            [f"Title: {res['title']}\nURL: {res['url']}\nContent: {res['content']}" for res in response['results']]
        )
        
        # Extract sources for storage and display
        sources = [{"title": res.get("title", ""), "url": res.get("url", "")} for res in response.get('results', [])]
        
        logger.success(f"Tavily search successful for query: '{query}'")
        return {
            "context_str": context_str,
            "sources": sources
        }

    except Exception as e:
        logger.error(f"An error occurred during Tavily search: {e}")
        return {
            "context_str": f"An error occurred during the search: {str(e)}",
            "sources": []
        }

async def find_official_website(brand_name: str) -> Optional[str]:
    """
    Uses Gemini to find the most likely official website for a given brand name.
    """
    if not settings.GEMINI_API_KEY:
        logger.warning("Gemini API key is not set. Skipping website search.")
        return None

    try:
        model = genai.GenerativeModel(settings.GEMINI_MODEL_NAME)
        prompt = f"""
        You are a research assistant. Your only task is to find the official homepage URL for a given company.
        Return ONLY the URL and nothing else. Do not add any explanatory text, markdown, or greetings.
        If you cannot find a definitive official website, return the text "NOT_FOUND".
    
        Company Name: "{brand_name}"
        Official URL:
        """
        
        response = await model.generate_content_async(prompt)
        
        # CORE FIX: Use a more robust check for safety-blocked responses.
        # Check if the response is empty and if there are safety ratings indicating a block.
        if not response.parts and response.prompt_feedback.safety_ratings:
            logger.warning(f"Gemini response for '{brand_name}' was blocked by safety settings. Ratings: {response.prompt_feedback.safety_ratings}")
            return None

        url_candidate = response.text.strip()
        
        logger.info(f"Gemini proposed URL for '{brand_name}': '{url_candidate}'")

        if "NOT_FOUND" in url_candidate or not url_candidate:
            logger.warning(f"Gemini could not find a website for '{brand_name}'.")
            return None
        
        parsed_url = urlparse(url_candidate)
        if parsed_url.scheme and parsed_url.netloc:
            logger.success(f"Successfully found and validated website for '{brand_name}': {url_candidate}")
            return url_candidate
        else:
            logger.warning(f"Gemini returned an invalid URL format for '{brand_name}': '{url_candidate}'")
            return None

    except Exception as e:
        # Catch specific "Invalid operation" error when .text is accessed on an empty response
        if "Invalid operation" in str(e) and "none were returned" in str(e):
             logger.warning(f"Gemini returned an empty response for '{brand_name}', likely due to safety filters.")
             return None
        logger.error(f"An error occurred during Gemini website search for '{brand_name}': {e}")
        return None-e 
-e

File: backend/src/services/pdf_layouts.py
from reportlab.platypus import Paragraph, Spacer, Table, TableStyle, Image, Flowable
from reportlab.lib.styles import ParagraphStyle, getSampleStyleSheet
from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.lib.enums import TA_LEFT, TA_CENTER, TA_RIGHT
from typing import Optional, List
import io

def get_pdf_styles():
    """Returns a dictionary of styled reportlab ParagraphStyle objects."""
    base_styles = getSampleStyleSheet()
    styles = {
        'default': ParagraphStyle(name='default', fontName='Helvetica', fontSize=10, leading=14),
        'h1': ParagraphStyle(name='h1', fontName='Helvetica-Bold', fontSize=20, alignment=TA_CENTER, spaceAfter=6),
        'h2': ParagraphStyle(name='h2', fontName='Helvetica-Bold', fontSize=14, spaceAfter=12, textColor=colors.HexColor('#0d47a1')),
        'h3': ParagraphStyle(name='h3', fontName='Helvetica-Bold', fontSize=11, spaceAfter=6),
        'center': ParagraphStyle(name='center', parent=base_styles['Normal'], alignment=TA_CENTER),
        'right': ParagraphStyle(name='right', parent=base_styles['Normal'], alignment=TA_RIGHT),
        'small_grey': ParagraphStyle(name='small_grey', fontSize=8, fontName='Helvetica', textColor=colors.grey),
    }
    styles['center_bold'] = ParagraphStyle(name='center_bold', parent=styles['center'], fontName='Helvetica-Bold')
    return styles

def _create_brand_header_flowable(brand_name: str, favicon_bytes: Optional[bytes], style: ParagraphStyle) -> List[Flowable]:
    """Creates a list of Flowables (Image + Text) for a brand header."""
    content = []
    if favicon_bytes:
        try:
            img = Image(io.BytesIO(favicon_bytes), width=12, height=12)
            img.hAlign = 'LEFT'
            content.append(img)
        except Exception: # Handle potential PIL errors for invalid image data
            pass
    content.append(Paragraph(f"<b>{brand_name}</b>", style))
    
    # Use a tiny table to force horizontal alignment
    table = Table([content], colWidths=[14, None])
    table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('LEFTPADDING', (0, 0), (-1, -1), 0),
        ('RIGHTPADDING', (0, 0), (0, 0), 2),
    ]))
    return [table]

def create_header(styles):
    """Creates the header section of the PDF."""
    return [
        Paragraph("Alloy - Cultural Due Diligence Report", styles['right']),
        Spacer(1, 0.1 * inch)
    ]

def create_title_section(report, styles, acquirer_favicon_bytes, target_favicon_bytes):
    """Creates the main title section of the PDF, now with favicons."""
    title_paragraph = Paragraph(report.title, styles['h1'])
    
    acquirer_image = Image(io.BytesIO(acquirer_favicon_bytes), width=24, height=24) if acquirer_favicon_bytes else Spacer(24, 24)
    target_image = Image(io.BytesIO(target_favicon_bytes), width=24, height=24) if target_favicon_bytes else Spacer(24, 24)

    title_data = [[acquirer_image, title_paragraph, target_image]]
    
    title_table = Table(title_data, colWidths=[0.5*inch, None, 0.5*inch])
    title_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),
        ('ALIGN', (2, 0), (2, 0), 'CENTER'),
    ]))

    return [
        title_table,
        Paragraph(f"<i>Generated: {report.created_at.strftime('%B %d, %Y')}</i>", styles['center']),
        Spacer(1, 0.3 * inch)
    ]

def create_key_metrics_table(report, doc_width, styles):
    """Creates the top-line metrics table."""
    cultural_score_display = f"<font size=24>{report.analysis.cultural_compatibility_score:.0f}</font>/100" if report.analysis.cultural_compatibility_score > 0 else "<font size=24>--</font>/100"
    affinity_score_display = f"<font size=24>{report.analysis.affinity_overlap_score:.1f}%</font>" if report.analysis.affinity_overlap_score > 0 else "<font size=24>--</font>%"
    
    score_data = [
        [
            Paragraph(cultural_score_display, styles['center']),
            Paragraph(affinity_score_display, styles['center'])
        ],
        [
            Paragraph("<b>Cultural Compatibility Score</b>", styles['center_bold']),
            Paragraph("<b>Audience Affinity Overlap</b>", styles['center_bold'])
        ]
    ]
    table = Table(score_data, colWidths=[doc_width / 2.0, doc_width / 2.0], rowHeights=0.6 * inch)
    table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('BOX', (0, 0), (-1, -1), 1, colors.darkgrey),
        ('INNERGRID', (0, 0), (-1, -1), 0.5, colors.lightgrey),
    ]))
    return [table, Spacer(1, 0.3 * inch)]

def create_corporate_culture_section(report, llm_summary, doc_width, styles, acquirer_favicon_bytes, target_favicon_bytes):
    """Creates the corporate culture analysis section with favicons."""
    corporate_ethos = llm_summary.get("corporate_ethos", {})
    acquirer_ethos_text = corporate_ethos.get('acquirer_ethos', '')
    target_ethos_text = corporate_ethos.get('target_ethos', '')

    if not acquirer_ethos_text and not target_ethos_text:
        return []

    acquirer_ethos = acquirer_ethos_text.replace('\n', '<br/>')
    target_ethos = target_ethos_text.replace('\n', '<br/>')

    story = []
    story.append(Paragraph("Corporate Culture & Ethos", styles['h2']))
    
    ethos_data = [
        [_create_brand_header_flowable(report.acquirer_brand, acquirer_favicon_bytes, styles['h3']),
         _create_brand_header_flowable(report.target_brand, target_favicon_bytes, styles['h3'])],
        [Paragraph(acquirer_ethos, styles['default']), Paragraph(target_ethos, styles['default'])]
    ]
    ethos_table = Table(ethos_data, colWidths=[doc_width / 2.0 - 5, doc_width / 2.0 - 5])
    ethos_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('BOX', (0, 0), (-1, -1), 1, colors.lightgrey),
        ('INNERGRID', (0, 0), (-1, -1), 0.5, colors.lightgrey),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
        ('TOPPADDING', (0, 0), (-1, -1), 6),
    ]))
    return [ethos_table, Spacer(1, 0.3*inch)]

def create_brand_archetypes_section(report, llm_summary, styles, acquirer_favicon_bytes, target_favicon_bytes):
    """Creates the brand archetypes section with favicons."""
    story = []
    archetypes = llm_summary.get("brand_archetypes", {})
    
    story.append(Paragraph("Brand Archetypes", styles['h2']))
    story.extend(_create_brand_header_flowable(report.acquirer_brand, acquirer_favicon_bytes, styles['h3']))
    story.append(Paragraph(archetypes.get('acquirer_archetype', 'N/A'), styles['default']))
    story.append(Spacer(1, 0.1*inch))
    story.extend(_create_brand_header_flowable(report.target_brand, target_favicon_bytes, styles['h3']))
    story.append(Paragraph(archetypes.get('target_archetype', 'N/A'), styles['default']))
    story.append(Spacer(1, 0.3*inch))
    return story

def create_financial_analysis_section(llm_summary, styles):
    """Creates the financial and market analysis summary section."""
    financial_synthesis = llm_summary.get("financial_synthesis", "")
    if not financial_synthesis:
        return []
    
    story = []
    story.append(Paragraph("Financial & Market Analysis", styles['h2']))
    story.append(Paragraph(financial_synthesis.replace('\n', '<br/>'), styles['default']))
    story.append(Spacer(1, 0.3 * inch))
    return story

def create_clashes_table(report, doc_width, styles):
    """Creates the culture clashes table."""
    if not report.culture_clashes:
        return []
        
    header = Paragraph("Potential Culture Clashes", styles['h2'])
    
    data = [['Topic', 'Description', 'Severity']]
    for clash in report.culture_clashes:
        data.append([
            Paragraph(clash.topic, styles['default']),
            Paragraph(clash.description, styles['default']),
            Paragraph(clash.severity, styles['default'])
        ])
        
    table = Table(data, colWidths=[doc_width * 0.2, doc_width * 0.6, doc_width * 0.2])
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#263238')), 
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 10),
        ('TOPPADDING', (0, 0), (-1, 0), 10),
        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.HexColor('#f5f5f5'), colors.white]),
        ('GRID', (0, 0), (-1, -1), 1, colors.lightgrey)
    ]))
    return [header, table, Spacer(1, 0.3 * inch)]

def create_growth_table(report, doc_width, styles):
    """Creates the untapped growth opportunities table."""
    if not report.untapped_growths:
        return []

    header = Paragraph("Untapped Growth Opportunities", styles['h2'])

    data = [['Opportunity', 'Potential Impact']]
    for growth in report.untapped_growths:
        data.append([
            Paragraph(growth.description, styles['default']),
            Paragraph(f"<b>{growth.potential_impact_score}/10</b>", styles['center'])
        ])

    table = Table(data, colWidths=[doc_width * 0.8, doc_width * 0.2])
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#004d40')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 10),
        ('TOPPADDING', (0, 0), (-1, 0), 10),
        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.HexColor('#f5f5f5'), colors.white]),
        ('GRID', (0, 0), (-1, -1), 1, colors.lightgrey)
    ]))
    return [header, table, Spacer(1, 0.3 * inch)]-e 
-e

File: backend/tests/conftest.py
import pytest_asyncio
import asyncio
from typing import AsyncGenerator, Generator
from httpx import AsyncClient, ASGITransport
from sqlmodel import SQLModel
from sqlalchemy.ext.asyncio import AsyncSession

# Set the environment variable to 'test' BEFORE importing the app
import os
os.environ['ENVIRONMENT'] = 'test'

from src.main import app
from src.db.postgresql import postgres_db
from src.db import models
from src.core.security import get_password_hash, create_access_token

# --- Core Fixtures ---
@pytest_asyncio.fixture(scope="session")
def event_loop() -> Generator[asyncio.AbstractEventLoop, None, None]:
    """Create an instance of the default event loop for each test session."""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()

@pytest_asyncio.fixture(scope="function")
async def db_session() -> AsyncGenerator[asyncio.AbstractEventLoop, None]:
    """
    Fixture to provide a database session for a test.
    This will create all tables before the test and drop them after,
    ensuring a clean slate for each test function.
    """
    # Establish connection and create tables
    async with postgres_db.engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.drop_all) # Drop first to be safe
        await conn.run_sync(SQLModel.metadata.create_all)

    # Yield the session to the test
    async with postgres_db.get_session() as session:
        yield session

    # After the test, drop all tables to ensure isolation
    async with postgres_db.engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.drop_all)
    
    # Dispose the engine to close all connections
    await postgres_db.engine.dispose()


@pytest_asyncio.fixture(scope="function")
async def client(db_session: AsyncSession) -> AsyncGenerator[AsyncClient, None]:
    """
    Fixture to provide an HTTPX client for making requests to the test app.
    It depends on db_session to ensure the database is ready.
    """
    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as c:
        yield c

# --- Test User and Authentication Fixtures ---

@pytest_asyncio.fixture(scope="function")
async def test_user(db_session: AsyncSession) -> models.User:
    """Fixture to create a standard test user in the database."""
    user = models.User(
        email="test@example.com",
        full_name="Test User",
        hashed_password=get_password_hash("testpassword"),
        is_active=True,
    )
    db_session.add(user)
    await db_session.commit()
    await db_session.refresh(user)
    return user

@pytest_asyncio.fixture(scope="function")
def test_user_token(test_user: models.User) -> str:
    """Fixture to create a JWT token for the test user."""
    return create_access_token(data={"sub": test_user.email})

@pytest_asyncio.fixture(scope="function")
async def authorized_client(client: AsyncClient, test_user_token: str) -> AsyncClient:
    """Fixture to provide an authenticated client."""
    client.headers["Authorization"] = f"Bearer {test_user_token}"
    return client-e 
-e

File: backend/tests/core/test_security.py
from src.core.security import verify_password, get_password_hash, create_access_token, decode_token

def test_password_hashing():
    password = "plain_password"
    hashed_password = get_password_hash(password)
    assert hashed_password != password
    assert verify_password(password, hashed_password)
    assert not verify_password("wrong_password", hashed_password)

def test_jwt_token_creation_and_decoding():
    data = {"sub": "test@example.com", "extra_data": "something"}
    token = create_access_token(data)
    decoded_data = decode_token(token)
    assert decoded_data is not None
    assert decoded_data["sub"] == data["sub"]
    assert decoded_data["extra_data"] == data["extra_data"]
    assert "exp" in decoded_data

def test_decode_invalid_token():
    invalid_token = "this.is.not.a.valid.token"
    decoded_data = decode_token(invalid_token)
    assert decoded_data is None-e 
-e

File: backend/tests/core/__init__.py
-e 
-e

File: backend/tests/__init__.py
-e 
-e

File: backend/tests/api/v1/test_auth.py
import pytest
from httpx import AsyncClient
from fastapi import status
from sqlalchemy.ext.asyncio import AsyncSession
from sqlmodel import select

from src.db import models

@pytest.mark.asyncio
async def test_register_user(client: AsyncClient, db_session: AsyncSession):
    # Successful registration
    response = await client.post("/api/v1/auth/register", json={"email": "newuser@example.com", "password": "password123"})
    assert response.status_code == status.HTTP_201_CREATED
    assert response.json() == {"message": "User created successfully"}

    # Verify user is in the database
    user = (await db_session.execute(select(models.User).where(models.User.email == "newuser@example.com"))).scalar_one_or_none()
    assert user is not None
    assert user.email == "newuser@example.com"

    # Test duplicate email registration
    response = await client.post("/api/v1/auth/register", json={"email": "newuser@example.com", "password": "password123"})
    assert response.status_code == status.HTTP_400_BAD_REQUEST
    assert "Email already registered" in response.json()["detail"]

@pytest.mark.asyncio
async def test_login_for_access_token(client: AsyncClient, test_user: models.User):
    # Test successful login
    login_data = {"username": test_user.email, "password": "testpassword"}
    response = await client.post("/api/v1/auth/login", data=login_data)
    assert response.status_code == status.HTTP_200_OK
    token_data = response.json()
    assert "access_token" in token_data
    assert "refresh_token" in token_data
    assert token_data["token_type"] == "bearer"

    # Test incorrect password
    login_data["password"] = "wrongpassword"
    response = await client.post("/api/v1/auth/login", data=login_data)
    assert response.status_code == status.HTTP_401_UNAUTHORIZED

@pytest.mark.asyncio
async def test_guest_login(client: AsyncClient, db_session: AsyncSession):
    response = await client.post("/api/v1/auth/guest")
    assert response.status_code == status.HTTP_200_OK
    token_data = response.json()
    assert "access_token" in token_data
    assert "refresh_token" in token_data

    # Verify a guest user was created
    users = (await db_session.execute(select(models.User).where(models.User.email.like("guest_%@alloy.dev")))).scalars().all()
    assert len(users) > 0

@pytest.mark.asyncio
async def test_get_current_user_dependency(authorized_client: AsyncClient, test_user: models.User):
    # This endpoint doesn't exist directly, but we can test a protected endpoint that uses it.
    # Let's test the /reports/draft endpoint which is protected.
    response = await authorized_client.post("/api/v1/reports/draft")
    assert response.status_code == status.HTTP_201_CREATED
    report_data = response.json()
    assert report_data["user_id"] == test_user.id-e 
-e

File: backend/tests/api/v1/__init__.py
-e 
-e

File: backend/tests/api/v1/test_reports.py
import pytest
from httpx import AsyncClient
from fastapi import status
from sqlalchemy.ext.asyncio import AsyncSession
import json
import uuid

from src.db import models
from src.db.postgresql import postgres_db

@pytest.mark.asyncio
async def test_create_and_get_reports(authorized_client: AsyncClient, test_user: models.User, db_session: AsyncSession):
    # Create a draft report
    response = await authorized_client.post("/api/v1/reports/draft")
    assert response.status_code == status.HTTP_201_CREATED
    draft_report_data = response.json()
    assert draft_report_data["status"] == "DRAFT"
    assert draft_report_data["user_id"] == test_user.id
    # Check that the ID is a valid UUID string
    assert uuid.UUID(draft_report_data["id"])

    # Create a completed report manually for testing GET
    completed_report = models.Report(
        user_id=test_user.id,
        title="Completed Test Report",
        acquirer_brand="Acquirer",
        target_brand="Target",
        status=models.ReportStatus.COMPLETED
    )
    db_session.add(completed_report)
    await db_session.commit()
    await db_session.refresh(completed_report)

    # Get all non-draft reports for the user
    response = await authorized_client.get("/api/v1/reports/")
    assert response.status_code == status.HTTP_200_OK
    reports_list = response.json()
    assert len(reports_list) == 1
    assert reports_list[0]["id"] == str(completed_report.id)
    assert reports_list[0]["title"] == "Completed Test Report"

    # Get a specific report by ID
    response = await authorized_client.get(f"/api/v1/reports/{completed_report.id}")
    assert response.status_code == status.HTTP_200_OK
    assert response.json()["title"] == "Completed Test Report"

@pytest.mark.asyncio
async def test_delete_report(authorized_client: AsyncClient, test_user: models.User, db_session: AsyncSession):
    report_to_delete = models.Report(user_id=test_user.id, status=models.ReportStatus.COMPLETED)
    db_session.add(report_to_delete)
    await db_session.commit()
    await db_session.refresh(report_to_delete)
    report_id = report_to_delete.id

    # Delete the report
    response = await authorized_client.delete(f"/api/v1/reports/{report_id}")
    assert response.status_code == status.HTTP_204_NO_CONTENT

    # Verify it's gone from the database using a new session to avoid cache issues
    async with postgres_db.get_session() as session:
        deleted_report = await session.get(models.Report, report_id)
        assert deleted_report is None

@pytest.mark.asyncio
async def test_generate_report_stream_mocked(authorized_client: AsyncClient, test_user: models.User, db_session: AsyncSession, mocker):
    # --- Mocks Setup ---
    mock_agent_instance = mocker.MagicMock()
    async def mock_run_stream():
        yield {"status": "info", "message": "Agent started"}
        yield {"status": "complete"}

    mock_agent_instance.run_stream.return_value = mock_run_stream()
    mock_agent_instance.final_data = {
        "qloo_analysis": {"affinity_overlap_score": 55.5}, "culture_clashes": [], "untapped_growths": [],
        "acquirer_culture_profile": "Mock culture", "target_culture_profile": "Mock culture",
        "acquirer_financial_profile": "Mock finance", "target_financial_profile": "Mock finance"
    }
    mock_agent_instance.all_sources = {}
    mocker.patch('src.api.v1.reports.AlloyReActAgent', return_value=mock_agent_instance)

    mocker.patch('src.api.v1.reports.synthesize_final_report', return_value={
        "cultural_compatibility_score": 88.0, "affinity_overlap_score": 55.5,
        "strategic_summary": "Mocked summary.", "brand_archetype_summary": {},
        "corporate_ethos_summary": {}, "financial_synthesis": "Mocked financial synthesis."
    })
    
    # --- Test Execution ---
    draft_report = models.Report(user_id=test_user.id, status=models.ReportStatus.DRAFT)
    db_session.add(draft_report)
    await db_session.commit()
    await db_session.refresh(draft_report)
    report_id_to_check = draft_report.id
    
    payload = {"acquirer_brand": "Test Acquirer", "target_brand": "Test Target", "title": "Mock Report"}
    
    events = []
    async with authorized_client.stream("POST", f"/api/v1/reports/{report_id_to_check}/generate", json=payload, timeout=10) as response:
        response.raise_for_status()
        async for line in response.aiter_lines():
            if line.startswith("data:"):
                events.append(json.loads(line[6:]))

    # --- Assertions ---
    final_event = events[-1] if events else {}
    assert final_event.get("status") == "complete", f"Stream did not complete successfully. Last event: {final_event}"
    assert final_event.get("payload", {}).get("reportId") == str(report_id_to_check)

    # Assert the database state was updated correctly using a fresh session
    async with postgres_db.get_session() as session:
        final_report = await session.get(models.Report, report_id_to_check)
        assert final_report is not None
        assert final_report.status == models.ReportStatus.COMPLETED
        # To check analysis, we need to load the relationship
        await session.refresh(final_report, attribute_names=["analysis"])
        assert final_report.analysis is not None
        assert final_report.analysis.cultural_compatibility_score == 88.0-e 
-e

File: backend/tests/api/v1/test_health.py
import pytest
from httpx import AsyncClient
from fastapi import status

@pytest.mark.asyncio
async def test_health_check(client: AsyncClient):
    response = await client.get("/api/v1/health/")
    assert response.status_code == status.HTTP_200_OK
    data = response.json()
    assert data["status"] == "ok"
    assert "version" in data-e 
-e

File: backend/tests/api/__init__.py
-e 
-e

File: web/src/types/report.ts
export interface Report {
  id: string; 
  title: string;
  acquirer_brand: string;
  target_brand: string;
  status: 'PENDING' | 'COMPLETED' | 'FAILED' | 'DRAFT';
  created_at: string;
  updated_at: string;
  user_id: number;
  analysis: ReportAnalysis | null;
  culture_clashes: CultureClash[];
  untapped_growths: UntappedGrowth[];
}

export interface ReportAnalysis {
  id: number;
  cultural_compatibility_score: number;
  affinity_overlap_score: number;
  brand_archetype_summary: string | { acquirer_archetype?: string, target_archetype?: string }; 
  strategic_summary: string;
  report_id: string; 
  persona_expansion_summary?: string | { expansion_score: number; latent_synergies: string[]; analysis: string };
  search_sources?: Array<{ title: string; url: string }>;
  acquirer_sources?: Array<{ title: string; url: string }>;
  target_sources?: Array<{ title: string; url: string }>;

  // Corporate culture fields
  acquirer_corporate_profile?: string;
  target_corporate_profile?: string;
  corporate_ethos_summary?: string | { acquirer_ethos?: string, target_ethos?: string };
  acquirer_culture_sources?: Array<{ title: string; url: string }>;
  target_culture_sources?: Array<{ title:string; url: string }>;
  
  // Financial analysis fields
  acquirer_financial_profile?: string;
  target_financial_profile?: string;
  financial_synthesis?: string;
  acquirer_financial_sources?: Array<{ title: string; url: string }>;
  target_financial_sources?: Array<{ title: string; url: string }>;
}

export type ClashSeverity = 'LOW' | 'MEDIUM' | 'HIGH';

export interface CultureClash {
  id: number;
  topic: string;
  description: string;
  severity: ClashSeverity;
  report_id: string;
}

export interface UntappedGrowth {
  id: number;
  description: string;
  potential_impact_score: number;
  report_id: string;
}-e 
-e

File: web/src/app/(pages)/(authed)/dashboard/settings/page.tsx
"use client";

import React, { useState } from 'react';
import { useAuth } from '@/components/global/providers';
import { useTheme } from 'next-themes';
import { Button } from '@/components/ui/button';
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogClose,
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { Sun, Moon, Laptop } from 'lucide-react';

export default function SettingsPage() {
  const { user } = useAuth();
  const { setTheme } = useTheme();

  // State for forms
  //@ts-ignore
  const [fullName, setFullName] = useState(user?.full_name || '');
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  
  // State for support dialog
  const [supportSubject, setSupportSubject] = useState('');
  const [supportMessage, setSupportMessage] = useState('');
  const [isSupportDialogOpen, setIsSupportDialogOpen] = useState(false);

  const handleProfileSave = (e: React.FormEvent) => {
    e.preventDefault();
    toast.success('Profile updated successfully.');
  };

  const handlePasswordChange = (e: React.FormEvent) => {
    e.preventDefault();
    if (newPassword !== confirmPassword) {
      toast.error('New passwords do not match.');
      return;
    }
    if (newPassword.length < 8) {
      toast.error('New password must be at least 8 characters long.');
      return;
    }
    
    // Simulate API call
    const promise = new Promise((resolve) => setTimeout(resolve, 1500));
    toast.promise(promise, {
      loading: 'Updating password...',
      success: () => {
        setCurrentPassword('');
        setNewPassword('');
        setConfirmPassword('');
        return 'Password updated successfully.';
      },
      error: 'Failed to update password.',
    });
  };

  const handleSupportSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!supportSubject.trim() || !supportMessage.trim()) {
      toast.error("Please fill out both subject and message fields.");
      return;
    }

    // Simulate sending the message
    const promise = () => new Promise((resolve) => setTimeout(resolve, 2000));
    toast.promise(promise, {
      loading: 'Sending your message to our support team...',
      success: () => {
        setIsSupportDialogOpen(false);
        setSupportSubject('');
        setSupportMessage('');
        return "Your message has been sent. We'll get back to you shortly.";
      },
      error: 'Failed to send message. Please try again.',
    });
  };

  return (
    <div className="grid gap-6">
      <div className="flex items-center justify-between">
          <h1 className="text-2xl font-bold">Settings</h1>
      </div>
      
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Profile Card */}
        <Card className="lg:col-span-1">
          <CardHeader>
            <CardTitle>My Profile</CardTitle>
            <CardDescription>Update your personal information.</CardDescription>
          </CardHeader>
          <form onSubmit={handleProfileSave}>
            <CardContent className="space-y-4">
              <div className="space-y-1">
                <Label htmlFor="fullName">Full Name</Label>
                <Input id="fullName" value={fullName} onChange={(e) => setFullName(e.target.value)} />
              </div>
              <div className="space-y-1">
                <Label htmlFor="email">Email</Label>
                <Input id="email" type="email" value={user?.email || ''} disabled />
              </div>
            </CardContent>
            <CardFooter className="border-t px-6 py-4">
              <Button type="submit">Save Changes</Button>
            </CardFooter>
          </form>
        </Card>

        {/* Security Card */}
        <Card className="lg:col-span-2">
          <CardHeader>
            <CardTitle>Security</CardTitle>
            <CardDescription>Manage your password and account security.</CardDescription>
          </CardHeader>
          <form onSubmit={handlePasswordChange}>
            <CardContent className="space-y-4">
               <div className="space-y-1">
                <Label htmlFor="currentPassword">Current Password</Label>
                <Input id="currentPassword" type="password" value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} />
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-1">
                  <Label htmlFor="newPassword">New Password</Label>
                  <Input id="newPassword" type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} />
                </div>
                <div className="space-y-1">
                  <Label htmlFor="confirmPassword">Confirm New Password</Label>
                  <Input id="confirmPassword" type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                </div>
              </div>
            </CardContent>
            <CardFooter className="border-t px-6 py-4">
              <Button type="submit">Update Password</Button>
            </CardFooter>
          </form>
        </Card>

        {/* Interface Card */}
        <Card>
            <CardHeader>
                <CardTitle>Interface</CardTitle>
                <CardDescription>Customize the look and feel of the application.</CardDescription>
            </CardHeader>
            <CardContent className="grid grid-cols-3 gap-2">
                <Button variant="outline" onClick={() => setTheme('light')}><Sun className="mr-2 h-4 w-4" />Light</Button>
                <Button variant="outline" onClick={() => setTheme('dark')}><Moon className="mr-2 h-4 w-4" />Dark</Button>
                <Button variant="outline" onClick={() => setTheme('system')}><Laptop className="mr-2 h-4 w-4" />System</Button>
            </CardContent>
        </Card>

        {/* Support Card */}
        <Card className="lg:col-span-2">
            <CardHeader>
                <CardTitle>Support</CardTitle>
                <CardDescription>Need help? Contact our support team directly.</CardDescription>
            </CardHeader>
            <CardContent>
                <p className="text-sm text-muted-foreground mb-4">
                    If you encounter any issues or have questions about your analysis, please don't hesitate to reach out. Our team of specialists is available to assist you.
                </p>
                <Dialog open={isSupportDialogOpen} onOpenChange={setIsSupportDialogOpen}>
                    <DialogTrigger asChild>
                        <Button>Contact Support</Button>
                    </DialogTrigger>
                    <DialogContent className="sm:max-w-[425px]">
                        <form onSubmit={handleSupportSubmit}>
                            <DialogHeader>
                                <DialogTitle>Contact Support</DialogTitle>
                                <DialogDescription>
                                    Describe your issue below. A support ticket will be created and we'll respond via email.
                                </DialogDescription>
                            </DialogHeader>
                            <div className="grid gap-4 py-4">
                                <div className="space-y-2">
                                    <Label htmlFor="subject" className="text-right">Subject</Label>
                                    <Input id="subject" value={supportSubject} onChange={(e) => setSupportSubject(e.target.value)} placeholder="e.g., Issue with Report #12345" />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="message" className="text-right">Message</Label>
                                    <Textarea id="message" value={supportMessage} onChange={(e) => setSupportMessage(e.target.value)} placeholder="Please provide as much detail as possible..." className="min-h-[120px]" />
                                </div>
                            </div>
                            <DialogFooter>
                                <DialogClose asChild><Button type="button" variant="ghost">Cancel</Button></DialogClose>
                                <Button type="submit">Send Message</Button>
                            </DialogFooter>
                        </form>
                    </DialogContent>
                </Dialog>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}-e 
-e

File: web/src/app/(pages)/(authed)/dashboard/team/page.tsx
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogClose,
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { MoreHorizontal, PlusCircle } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { UserAvatar } from '@/components/global/UserAvatar';
import { useAuth } from '@/components/global/providers';
import { toast } from 'sonner';

const teamMembers = [
  { email: 'founder@alloy.com', name: 'Alex Johnson', role: 'Admin' },
  { email: 'analyst.one@alloy.com', name: 'Samantha Carter', role: 'Member' },
  { email: 'data.lead@alloy.com', name: 'Daniel Jackson', role: 'Member' },
];

export default function TeamPage() {
  const { user } = useAuth();

  const handleInvite = (e: React.FormEvent) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    const email = formData.get('email');
    toast.success(`Invitation sent to ${email}!`);
  };

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <div>
          <CardTitle>Team Members</CardTitle>
          <CardDescription>
            Manage and invite members to your organization.
          </CardDescription>
        </div>
        <Dialog>
            <DialogTrigger asChild>
                <Button>
                    <PlusCircle className="mr-2 h-4 w-4" />
                    Invite Member
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[425px]">
                <form onSubmit={handleInvite}>
                    <DialogHeader>
                        <DialogTitle>Invite a new member</DialogTitle>
                        <DialogDescription>
                            Enter the email and role for your new team member. They will receive an email to join your organization.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="space-y-2">
                            <Label htmlFor="email">Email address</Label>
                            <Input id="email" name="email" type="email" placeholder="name@example.com" required />
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="role">Role</Label>
                             <Select name="role" defaultValue="Member">
                                <SelectTrigger>
                                    <SelectValue placeholder="Select a role" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="Admin">Admin</SelectItem>
                                    <SelectItem value="Member">Member</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>
                    </div>
                    <DialogFooter>
                        <DialogClose asChild><Button type="button" variant="ghost">Cancel</Button></DialogClose>
                        <DialogClose asChild><Button type="submit">Send Invitation</Button></DialogClose>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Member</TableHead>
              <TableHead>Role</TableHead>
              <TableHead className="text-right">Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {teamMembers.map((member) => (
              <TableRow key={member.email}>
                <TableCell>
                  <div className="flex items-center gap-3">
                    <UserAvatar user={{ email: member.email, full_name: member.name }} />
                    <div>
                      <p className="font-medium">{member.name} {member.email === user?.email && "(You)"}</p>
                      <p className="text-sm text-muted-foreground">
                        {member.email}
                      </p>
                    </div>
                  </div>
                </TableCell>
                <TableCell>
                  <Badge variant={member.role === 'Admin' ? 'default' : 'secondary'}>
                    {member.role}
                  </Badge>
                </TableCell>
                <TableCell className="text-right">
                   <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="ghost" size="icon" disabled={member.email === user?.email}>
                        <MoreHorizontal className="h-4 w-4" />
                        <span className="sr-only">Actions</span>
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuLabel>Actions</DropdownMenuLabel>
                      <DropdownMenuItem>Change role</DropdownMenuItem>
                      <DropdownMenuItem className="text-destructive focus:bg-destructive/10 focus:text-destructive">
                        Remove from team
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
}-e 
-e

File: web/src/app/(pages)/(authed)/dashboard/support/page.tsx
"use client";

import React, { useState } from 'react';
import { useAuth } from '@/components/global/providers';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { toast } from 'sonner';
import { LifeBuoy, Send, MessageSquare, BadgeDollarSign, Wrench } from 'lucide-react';

const faqItems = [
  {
    question: "How is the Cultural Compatibility Score calculated?",
    answer: "Our score is generated by analyzing millions of data points from Qloo's cultural AI. We compare the taste profiles of the acquirer's and target's audiences across various domains like music, film, TV, and brands to produce a quantifiable measure of alignment."
  },
  {
    question: "What does 'Grounding' do?",
    answer: "Enabling the 'Grounding' option allows our AI agent to perform live web searches using the Tavily API. This enriches the analysis with up-to-the-minute information, corporate profiles, and recent news, providing a more comprehensive report."
  },
  {
    question: "Can I upload my own data for context?",
    answer: "Yes. You can upload PDF, Excel, TXT, or Markdown files. This is useful for providing internal documents, data room files, or specific research that you want the AI to consider during its analysis."
  },
  {
    question: "Is my data secure?",
    answer: "Absolutely. All data is handled with strict confidentiality. We use robust authentication and encryption protocols. Your uploaded documents and report analyses are private to your account."
  }
];

export default function SupportPage() {
  const { authedFetch } = useAuth();
  const [category, setCategory] = useState('');
  const [subject, setSubject] = useState('');
  const [message, setMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!category || !subject.trim() || !message.trim()) {
      toast.error("All fields are required.");
      return;
    }

    // This endpoint doesn't exist on the backend, but we now use authedFetch.
    // For demo purposes, we'll mock the success case from the 404 response.
    const promise = authedFetch(`/api/v1/utils/support/ticket`, {
        method: 'POST',
        body: JSON.stringify({ category, subject, message }),
    }).then(res => {
        if (!res.ok) {
            // Mocking a successful response for the demo
            if(res.status === 404) return {message: 'Ticket submitted successfully! (Demo)'};
            throw new Error('Failed to submit ticket. Please try again later.');
        }
        return res.json();
    });

    toast.promise(promise, {
      loading: 'Submitting your support ticket...',
      success: (data) => {
        setCategory('');
        setSubject('');
        setMessage('');
        return data.message || 'Ticket submitted successfully!';
      },
      error: (err) => err.message,
    });
  };

  return (
    <div className="grid md:grid-cols-3 gap-6">
      <div className="md:col-span-2">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2"><LifeBuoy className="h-6 w-6" /> Contact Support</CardTitle>
            <CardDescription>
              Have a question or facing an issue? Fill out the form below and our team will get back to you.
            </CardDescription>
          </CardHeader>
          <form onSubmit={handleSubmit}>
            <CardContent className="space-y-6">
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="category">Category</Label>
                  <Select value={category} onValueChange={setCategory} disabled={isLoading}>
                    <SelectTrigger id="category">
                      <SelectValue placeholder="Select a category..." />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="technical-issue"><Wrench className="mr-2 h-4 w-4" />Technical Issue</SelectItem>
                      <SelectItem value="billing-question"><BadgeDollarSign className="mr-2 h-4 w-4" />Billing Question</SelectItem>
                      <SelectItem value="feature-request"><MessageSquare className="mr-2 h-4 w-4" />Feature Request</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                 <div className="space-y-2">
                  <Label htmlFor="subject">Subject</Label>
                  <Input 
                    id="subject" 
                    placeholder="e.g., Report generation failed" 
                    value={subject}
                    onChange={(e) => setSubject(e.target.value)}
                    disabled={isLoading}
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="message">Message</Label>
                <Textarea 
                  id="message" 
                  placeholder="Please describe your issue in detail..." 
                  className="min-h-[150px]"
                  value={message}
                  onChange={(e) => setMessage(e.target.value)}
                  disabled={isLoading}
                />
              </div>
               <div className="flex justify-end">
                <Button type="submit" disabled={isLoading}>
                    {isLoading ? "Submitting..." : "Submit Ticket"}
                    <Send className="ml-2 h-4 w-4" />
                </Button>
            </div>
            </CardContent>
          </form>
        </Card>
      </div>
      <div className="md:col-span-1">
        <Card>
          <CardHeader>
            <CardTitle>FAQs</CardTitle>
            <CardDescription>Quick answers to common questions.</CardDescription>
          </CardHeader>
          <CardContent>
            <Accordion type="single" collapsible className="w-full">
              {faqItems.map((item, index) => (
                <AccordionItem value={`item-${index}`} key={index}>
                  <AccordionTrigger>{item.question}</AccordionTrigger>
                  <AccordionContent className="text-muted-foreground">
                    {item.answer}
                  </AccordionContent>
                </AccordionItem>
              ))}
            </Accordion>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}-e 
-e

File: web/src/app/(pages)/(authed)/dashboard/page.tsx
"use client";

import { useState, useEffect } from "react";
import useSWR from 'swr';
import { PromptInputBox } from "@/components/global/PromptInputBox";
import { DashboardGreeting } from "@/components/global/DashboardGreeting";
import { useAuth } from "@/components/global/providers";
import { useRouter } from "next/navigation";
import { PageLoader } from "@/components/global/PageLoader";
import { Report } from "@/types/report";
import { DemoReportCard } from "@/components/global/DemoReportCard";
import { AnimatePresence, motion } from "framer-motion";

const DEMO_REPORT_TITLE = "Demo Report: Nike vs. Patagonia";
const DEMO_DISMISS_KEY = "alloy_demo_dismissed";

export default function DashboardPage() {
    const { isLoading, accessToken } = useAuth();
    const router = useRouter();
    const [isPristine, setIsPristine] = useState(true);

    // Fetch reports to find the demo
    const { data: reports } = useSWR<Report[]>(accessToken ? `/api/v1/reports` : null);

    const [demoReport, setDemoReport] = useState<Report | null>(null);
    const [showDemoCard, setShowDemoCard] = useState(false);

    useEffect(() => {
        if (reports) {
            const foundDemo = reports.find(r => r.title === DEMO_REPORT_TITLE);
            // Check localStorage only after a slight delay to prevent flash of content on load
            setTimeout(() => {
                const isDismissed = localStorage.getItem(DEMO_DISMISS_KEY) === 'true';
                if (foundDemo && !isDismissed) {
                    setDemoReport(foundDemo);
                    setShowDemoCard(true);
                } else {
                    setDemoReport(null);
                    setShowDemoCard(false);
                }
            }, 200);
        }
    }, [reports]);

    const handleDismissDemo = () => {
        setShowDemoCard(false);
        localStorage.setItem(DEMO_DISMISS_KEY, 'true');
    };

    const onReportCreated = () => {
        // After a report is created, reset the state and redirect
        setIsPristine(true);
        router.push('/dashboard/reports');
    };

    if (isLoading) {
      return <PageLoader />;
    }
    
    return (
        <div className="relative flex flex-col items-center justify-center min-h-[calc(100vh-8rem)] w-full transition-all duration-500 ease-in-out">
            {/* Subtle background pattern */}
            <div 
              className="absolute inset-0 z-[-1] h-full w-full bg-transparent"
              style={{
                backgroundImage: 'linear-gradient(to right, hsl(var(--border) / 0.4) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.4) 1px, transparent 1px)',
                backgroundSize: '36px 36px',
                maskImage: 'radial-gradient(ellipse 80% 50% at 50% 0%, #000 70%, transparent 110%)'
              }}
            />
            
            <div className="w-full max-w-3xl flex flex-col items-center gap-8 px-4 py-8">
                <DashboardGreeting isVisible={isPristine} />
            
                <PromptInputBox 
                  onReportCreated={onReportCreated} 
                  onPristineChange={setIsPristine} 
                />
            </div>

            {/* --- MODIFIED: Floating Demo Card Container in Bottom-Right --- */}
            <AnimatePresence>
                {showDemoCard && demoReport && (
                    <motion.div
                        className="fixed bottom-0 right-0 z-50 p-4 sm:p-6"
                        initial={{ opacity: 0, y: 100 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: 100, transition: { duration: 0.3 } }}
                        transition={{ type: 'spring', stiffness: 120, damping: 20, duration: 0.5 }}
                    >
                        <DemoReportCard report={demoReport} onDismiss={handleDismissDemo} />
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
}-e 
-e

File: web/src/app/(pages)/(authed)/dashboard/reports/[id]/page.tsx
"use client";

import useSWR from 'swr';
import { useAuth } from '@/components/global/providers';
import { ReportView, ReportViewSkeleton } from '@/components/report/ReportView';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { AlertCircle, Download, Loader2 } from 'lucide-react';
import { useParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { useState } from 'react';
import { toast } from 'sonner';
import { Report } from '@/types/report';

export default function ReportPage() {
    const { id } = useParams<{ id: string }>();
    const { accessToken, authedFetch } = useAuth();
    const { data: report, error, isLoading } = useSWR<Report>(
        accessToken ? `/api/v1/reports/${id}` : null
    );
    const [isDownloading, setIsDownloading] = useState(false);

    const handleDownload = async () => {
        if (!report || !accessToken) return;
        setIsDownloading(true);
        try {
            const res = await authedFetch(`/api/v1/reports/${report.id}/download-pdf`);
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || "Failed to download PDF.");
            }
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Alloy_Report_${report.acquirer_brand}_vs_${report.target_brand}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } catch (err: any) {
            toast.error("Download Failed", { description: err.message });
        } finally {
            setIsDownloading(false);
        }
    };

    if (isLoading) {
        return <ReportViewSkeleton />;
    }

    if (error) {
        return (
             <div className="container mx-auto py-10">
                <Alert variant="destructive">
                    <AlertCircle className="h-4 w-4" />
                    <AlertTitle>Error</AlertTitle>
                    <AlertDescription>{error.message}</AlertDescription>
                </Alert>
            </div>
        )
    }

    if (!report) {
        return null;
    }

    return (
        <ReportView report={report}>
            <Button onClick={handleDownload} disabled={isDownloading}>
                {isDownloading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Download className="mr-2 h-4 w-4" />}
                {isDownloading ? 'Preparing...' : 'Download PDF'}
            </Button>
        </ReportView>
    );
}-e 
-e

File: web/src/app/(pages)/(authed)/dashboard/reports/page.tsx
"use client";

import Link from "next/link";
import useSWRMutation from 'swr/mutation';
import { useAuth } from '@/components/global/providers';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Skeleton } from "@/components/ui/skeleton";
import { AlertCircle, CheckCircle, Clock, FileText, PlusCircle, Trash2, XCircle } from "lucide-react";
import { Report } from "@/types/report";
import { toast } from "sonner";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import useSWR from "swr";

async function deleteReport(url: string, { arg }: { arg: { reportId: string, authedFetch: (url: string, options?: RequestInit) => Promise<Response> } }) {
    const response = await arg.authedFetch(`${url}${arg.reportId}`, {
        method: 'DELETE',
    });
    if (!response.ok && response.status !== 204) {
        try {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to delete report.');
        } catch (e) {
            throw new Error('Failed to delete report.');
        }
    }
}

// --- Components ---
const StatusBadge = ({ status }: { status: Report['status'] }) => {
    const config = {
        COMPLETED: { variant: 'default', icon: CheckCircle, text: 'Completed', className: 'bg-green-500/20 text-green-700 border-green-500/30 dark:text-green-400' },
        PENDING: { variant: 'secondary', icon: Clock, text: 'In Progress', className: 'bg-yellow-500/20 text-yellow-700 border-yellow-500/30 dark:text-yellow-400' },
        FAILED: { variant: 'destructive', icon: XCircle, text: 'Failed', className: 'bg-red-500/20 text-red-700 border-red-500/30 dark:text-red-400' },
        DRAFT: { variant: 'outline', icon: FileText, text: 'Draft', className: 'bg-gray-500/20 text-gray-700 border-gray-500/30 dark:text-gray-400' },
    }[status];

    const Icon = config.icon;
    
    return (
        <Badge variant={config.variant as any} className={config.className}>
            <Icon className="w-3 h-3 mr-1" />
            {config.text}
        </Badge>
    );
};

// --- Main Reports Page Component ---
export default function ReportsPage() {
    const { accessToken, authedFetch } = useAuth();
    const { data: reports, error, mutate, isLoading } = useSWR<Report[]>(
        accessToken ? `/api/v1/reports` : null
    );
    const { trigger: triggerDelete } = useSWRMutation(`/api/v1/reports/`, deleteReport);

    const handleDelete = async (reportId: string) => {
        toast.info("Deleting report...");
        try {
            await triggerDelete({ reportId, authedFetch });
            toast.success("Report deleted successfully.");
            mutate(reports?.filter(r => r.id !== reportId), false);
        } catch (err: any) {
            toast.error("Deletion Failed", { description: err.message });
        }
    };

    const renderContent = () => {
        if (isLoading) {
            return (
                <Table>
                    <TableHeader><TableRow><TableHead>Report</TableHead><TableHead>Score</TableHead><TableHead>Status</TableHead><TableHead>Date</TableHead><TableHead><span className="sr-only">Actions</span></TableHead></TableRow></TableHeader>
                    <TableBody>{[...Array(5)].map((_, i) => (<TableRow key={i}><TableCell><Skeleton className="h-5 w-48" /></TableCell><TableCell><Skeleton className="h-5 w-12" /></TableCell><TableCell><Skeleton className="h-6 w-20" /></TableCell><TableCell><Skeleton className="h-5 w-32" /></TableCell><TableCell className="flex gap-2"><Skeleton className="h-8 w-20" /><Skeleton className="h-8 w-8" /></TableCell></TableRow>))}</TableBody>
                </Table>
            );
        }

        if (error) {
            return <Alert variant="destructive"><AlertCircle className="h-4 w-4" /><AlertTitle>Error Loading Reports</AlertTitle><AlertDescription>{error.message}</AlertDescription></Alert>;
        }

        if (reports && reports.length === 0) {
            return (
                <div className="text-center py-16"><h3 className="text-xl font-semibold">No reports found</h3><p className="text-muted-foreground mt-2 mb-4">Get started by creating your first cultural analysis.</p><Button asChild><Link href="/dashboard"><PlusCircle className="mr-2 h-4 w-4" />Create New Report</Link></Button></div>
            );
        }

        if (reports) {
            return (
                <Table>
                    <TableHeader><TableRow><TableHead className="w-[40%]">Report</TableHead><TableHead>Score</TableHead><TableHead>Status</TableHead><TableHead>Date</TableHead><TableHead className="text-right">Actions</TableHead></TableRow></TableHeader>
                    <TableBody>
                        {reports.map((report) => (
                            <TableRow key={report.id}>
                                <TableCell className="font-medium">{report.title}</TableCell>
                                <TableCell className="font-semibold">{report.analysis?.cultural_compatibility_score ?? '--'}</TableCell>
                                <TableCell><StatusBadge status={report.status} /></TableCell>
                                <TableCell className="text-muted-foreground">{new Date(report.created_at).toLocaleDateString()}</TableCell>
                                <TableCell className="text-right space-x-2">
                                    <Button asChild variant="outline" size="sm"><Link href={`/dashboard/reports/${report.id}`}>View</Link></Button>
                                    <AlertDialog>
                                        <AlertDialogTrigger asChild><Button variant="ghost" size="icon" className="text-muted-foreground hover:text-destructive"><Trash2 className="h-4 w-4" /></Button></AlertDialogTrigger>
                                        <AlertDialogContent>
                                            <AlertDialogHeader><AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle><AlertDialogDescription>This action cannot be undone. This will permanently delete the report for "{report.title}".</AlertDialogDescription></AlertDialogHeader>
                                            <AlertDialogFooter><AlertDialogCancel>Cancel</AlertDialogCancel><AlertDialogAction onClick={() => handleDelete(report.id)} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">Delete Report</AlertDialogAction></AlertDialogFooter>
                                        </AlertDialogContent>
                                    </AlertDialog>
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            );
        }

        return null;
    };

    return (
        <Card>
            <CardHeader className="flex flex-row items-center justify-between">
                <div><CardTitle>My Reports</CardTitle><CardDescription>A complete history of all generated cultural analyses.</CardDescription></div>
                <Button asChild><Link href="/dashboard"><PlusCircle className="mr-2 h-4 w-4" />Create New Report</Link></Button>
            </CardHeader>
            <CardContent>{renderContent()}</CardContent>
        </Card>
    );
}-e 
-e

File: web/src/app/(pages)/(authed)/layout.tsx
"use client";

import { useRouter } from "next/navigation";
import { useEffect } from "react";
import { useAuth } from "@/components/global/providers";
import { Sidebar } from "@/components/global/Sidebar";
import { ThemeProvider as NextThemesProvider } from "next-themes";
import { Header } from "@/components/global/Header";
import { PageLoader } from "@/components/global/PageLoader";

export default function AuthedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const { isAuthenticated, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.replace('/login');
    }
  }, [isLoading, isAuthenticated, router]);

  if (isLoading || !isAuthenticated) {
    return <PageLoader />;
  }

  return (
    <NextThemesProvider
        attribute="class"
        defaultTheme="system"
        enableSystem
        disableTransitionOnChange
    >
        <div className="flex min-h-screen w-full flex-col bg-background">
            <Sidebar />
            <div className="flex flex-col sm:pl-14">
                <Header />
                <main className="grid flex-1 items-start gap-4 p-4 sm:px-6 sm:py-4 md:gap-8">
                    {children}
                </main>
            </div>
        </div>
    </NextThemesProvider>
  );
}-e 
-e

File: web/src/app/(pages)/(auth)/token/page.tsx
"use client";

import { useSearchParams, useRouter } from 'next/navigation';
import { useEffect } from 'react';
import { useAuth } from '@/components/global/providers';

export default function TokenPage() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { login } = useAuth();

  useEffect(() => {
    const accessToken = searchParams.get('access_token');
    const refreshToken = searchParams.get('refresh_token');

    if (accessToken && refreshToken) {
      login(accessToken, refreshToken);
      // Clean the URL and redirect to the dashboard
      router.replace('/dashboard');
    } else {
      // Handle error case, maybe redirect to login with an error message
      router.replace('/login?error=auth_failed');
    }
  }, [searchParams, router, login]);

  return (
    <div className="flex h-screen w-full items-center justify-center bg-background">
      <div className="text-center">
        <p className="text-lg text-foreground">Finalizing authentication...</p>
        <p className="text-sm text-muted-foreground">Please wait, you will be redirected shortly.</p>
      </div>
    </div>
  );
}-e 
-e

File: web/src/app/(pages)/(auth)/register/page.tsx
"use client";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import Link from "next/link";
import { useState, FormEvent } from "react";
import { FaGoogle } from "react-icons/fa";
import Logo from "@/components/global/Logo";
import { useAuth } from "@/components/global/providers";
import { useRouter } from 'next/navigation';

export default function RegisterPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const { login, apiUrl } = useAuth();
  const router = useRouter();

  const handleRegister = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);

    if (password !== confirmPassword) {
      setError("Passwords do not match.");
      return;
    }

    const formData = new URLSearchParams();
    formData.append('username', email);
    formData.append('password', password);

    try {
      // 1. Register the user
      const res = await fetch(`/api/v1/auth/register`, {
        method: 'POST',
        body: JSON.stringify({ email, password, full_name: "" }),
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        const errorData = await res.json();
        setError(errorData.detail || "Registration failed.");
        return;
      }
      
      // 2. Log the user in to get tokens
      const loginRes = await fetch(`/api/v1/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData.toString(),
      })

      if (!loginRes.ok) {
        throw new Error("Registration successful, but login failed. Please log in manually.");
      }

      const tokens = await loginRes.json();
      login(tokens.access_token, tokens.refresh_token);
      router.push("/dashboard");

    } catch (err) {
      setError(err instanceof Error ? err.message : "An unexpected error occurred. Please try again.");
    }
  };
  
  // The Google Auth URL MUST be absolute and include the /api/v1 prefix.
  const googleAuthUrl = `${apiUrl}/api/v1/auth/google/authorize`;

  return (
    <Card className="w-full max-w-sm">
      <CardHeader className="text-center">
        <Logo className="mx-auto" />
        <CardTitle className="text-2xl">Create an Account</CardTitle>
        <CardDescription>
          Get started with your data-driven Cultural Compatibility Score.
        </CardDescription>
      </CardHeader>
      <CardContent>
        {error && <p className="mb-4 text-center text-sm text-destructive">{error}</p>}
        <form onSubmit={handleRegister} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              placeholder="analyst@firm.com"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="password">Password</Label>
            <Input
              id="password"
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
           <div className="space-y-2">
            <Label htmlFor="confirm-password">Confirm Password</Label>
            <Input
              id="confirm-password"
              type="password"
              required
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
            />
          </div>
          <Button type="submit" className="w-full">
            Sign Up
          </Button>
        </form>
        <div className="my-4 flex items-center">
          <div className="flex-grow border-t border-muted" />
          <span className="mx-4 text-xs text-muted-foreground">OR</span>
          <div className="flex-grow border-t border-muted" />
        </div>
        <div className="space-y-2">
          <Button variant="outline" className="w-full" asChild>
            <a href={googleAuthUrl}>
              <FaGoogle className="mr-2" /> Sign up with Google
            </a>
          </Button>
        </div>
      </CardContent>
      <CardFooter className="flex justify-center text-sm">
        <p className="text-muted-foreground">
          Already have an account?{" "}
          <Link href="/login" className="text-primary hover:underline font-medium">
            Log In
          </Link>
        </p>
      </CardFooter>
    </Card>
  );
}-e 
-e

File: web/src/app/(pages)/(auth)/layout.tsx
"use client";

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/components/global/providers';
import { AuthVisual } from "@/components/auth/AuthVisual";
import Logo from "@/components/global/Logo";
import Link from "next/link";
import { PageLoader } from '@/components/global/PageLoader';

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const { isAuthenticated, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    // Wait for the auth state to be determined
    if (!isLoading && isAuthenticated) {
      // If user is authenticated, redirect them to the dashboard
      router.replace('/dashboard');
    }
  }, [isLoading, isAuthenticated, router]);

  // While loading or if authenticated (and about to be redirected), show a loading screen
  if (isLoading || isAuthenticated) {
    return <PageLoader />;
  }

  // Only show the auth layout if the user is not authenticated
  return (
    <div className="bg-background text-foreground relative flex min-h-screen w-full font-sans">
      <div className="absolute top-6 left-6 z-10">
        <Logo className="text-black" hideText={false}/>
      </div>
      
      <div className="flex flex-1 flex-col justify-center items-center gap-6 p-4 lg:p-8">
        <main className="w-full max-w-sm">{children}</main>
        <footer className="w-full max-w-sm text-center text-muted-foreground text-xs">
          <Link href="#" className="hover:text-foreground">
            Terms of Service
          </Link>
          {" | "}
          <Link href="#" className="hover:text-foreground">
            Privacy Policy
          </Link>
        </footer>
      </div>
      <div className="hidden lg:flex lg:flex-1">
        <AuthVisual />
      </div>
    </div>
  );
}-e 
-e

File: web/src/app/(pages)/(auth)/login/page.tsx
"use client";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import Link from "next/link";
import { useState } from "react";
import { FaGoogle } from "react-icons/fa";
import { useAuth } from '@/components/global/providers';
import { useRouter, useSearchParams } from 'next/navigation';

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [isLoggingIn, setIsLoggingIn] = useState(false);
  const [isGuestLoading, setIsGuestLoading] = useState(false);
  const { login, apiUrl } = useAuth(); // Get apiUrl from context
  const router = useRouter();
  const searchParams = useSearchParams();
  const isLoading = isLoggingIn || isGuestLoading;

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setIsLoggingIn(true);

    const formData = new URLSearchParams();
    formData.append('username', email);
    formData.append('password', password);

    try {
      // Use relative path for fetch, it will be handled by the rewrite proxy
      const res = await fetch(`/api/v1/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString(),
      });

      if (!res.ok) {
        const errorData = await res.json();
        setError(errorData.detail || "Login failed. Please check your credentials.");
        return;
      }
      
      const tokens = await res.json();
      login(tokens.access_token, tokens.refresh_token);
      router.push("/dashboard");

    } catch (err) {
      setError(err instanceof Error ? err.message : "An unexpected error occurred. Please try again.");
    } finally {
        setIsLoggingIn(false);
    }
  };

  const handleGuestLogin = async () => {
    setError(null);
    setIsGuestLoading(true);
    try {
       // Use relative path for fetch
      const res = await fetch(`/api/v1/auth/guest`, {
        method: 'POST',
      });

      if (!res.ok) {
        const errorData = await res.json();
        setError(errorData.detail || "Guest login failed. Please try again.");
        return;
      }

      const tokens = await res.json();
      login(tokens.access_token, tokens.refresh_token);
      router.push("/dashboard");
    } catch (err) {
        setError(err instanceof Error ? err.message : "An unexpected error occurred. Please try again.");
    } finally {
        setIsGuestLoading(false);
    }
  };

  // The Google Auth URL MUST be absolute and include the /api/v1 prefix.
  const googleAuthUrl = `${apiUrl}/api/v1/auth/google/authorize`;

  return (
    <Card className="w-full max-w-sm">
      <CardHeader className="text-center">
        <CardTitle className="text-2xl">Log In to Alloy</CardTitle>
        <CardDescription>
          Enter your credentials to access your dashboard.
        </CardDescription>
      </CardHeader>
      <CardContent>
        {error && <p className="mb-4 text-center text-sm text-destructive">{error}</p>}
        {searchParams.get('error') && <p className="mb-4 text-center text-sm text-destructive">Authentication failed. Please try again.</p>}
        <form onSubmit={handleLogin} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              placeholder="analyst@firm.com"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="password">Password</Label>
            <Input
              id="password"
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoggingIn ? "Logging In..." : "Log In"}
          </Button>
        </form>
        <div className="my-4 flex items-center">
          <div className="flex-grow border-t border-muted" />
          <span className="mx-4 text-xs text-muted-foreground">OR</span>
          <div className="flex-grow border-t border-muted" />
        </div>
        <div className="space-y-2">
            <Button variant="outline" className="w-full" asChild disabled={isLoading}>
                <a href={googleAuthUrl}>
                    <FaGoogle className="mr-2"/> Log in with Google
                </a>
            </Button>
            <Button variant="secondary" className="w-full" onClick={handleGuestLogin} disabled={isLoading}>
              {isGuestLoading ? "Entering..." : "Continue as Guest"}
            </Button>
        </div>
      </CardContent>
      <CardFooter className="flex justify-center text-sm">
        <p className="text-muted-foreground">
          Don't have an account?{" "}
          <Link href="/register" className="text-primary hover:underline font-medium">
            Sign Up
          </Link>
        </p>
      </CardFooter>
    </Card>
  );
}-e 
-e

File: web/src/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { AppProviders } from "@/components/global/providers";
import { Toaster } from "@/components/ui/sonner";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Alloy",
  description: "The Cultural Due Diligence Platform",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  // This is a Server Component, so it can safely access process.env at runtime.
  // We use the same variable name for consistency.
  const apiUrl = process.env.NEXT_PUBLIC_API_URL;

  if (!apiUrl) {
    // This will cause an error page in production if the env var is missing,
    // which is better than a broken app.
    throw new Error("FATAL: NEXT_PUBLIC_API_URL environment variable is not set.");
  }

  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <AppProviders apiUrl={apiUrl}>{children}</AppProviders>
      <Toaster richColors position="bottom-right" />
      </body>
    </html>
  );
}-e 
-e

File: web/src/app/page.tsx
"use client"

import { AlloyHeroSection, FeaturesSection } from '@/components/global/Hero'
import React from 'react'
import Footer from '@/components/global/Footer'

function page() {

    const footerLeftLinks = [
      { href: "#", label: "Affinity Overlap Score" },
      { href: "#", label: "Culture Clash Report" },
      { href: "#", label: "Untapped Growth Analysis" },
      { href: "#", label: "AI-Powered Brand Archetyping" },
    ];
    const footerRightLinks = [
      { href: "/login", label: "Log In" },
      { href: "/login", label: "Request a Demo" },
      { href: "https://qloo-hackathon.devpost.com", label: "Devpost Hackathon Submission" },
    ];
    const problemStatement = "M&A failures are costly, often rooted in unforeseen cultural clashes. Billions are lost when executive 'gut feel' misses the mark on brand incompatibility.";
    const solutionStatement = "Alloy replaces guesswork with data. We provide a quantifiable Cultural Compatibility Score by analyzing audience taste profiles, de-risking acquisitions and illuminating the human element of a deal.";
  
  return (
    <>
      <AlloyHeroSection />
      <FeaturesSection />
      <Footer
        leftLinks={footerLeftLinks}
        rightLinks={footerRightLinks}
        copyrightText="The Cultural Due Diligence Platform."
        problemStatement={problemStatement}
        solutionStatement={solutionStatement}
      />
    </>
  )
}

export default page-e 
-e

File: web/src/components/ui/alert-dialog.tsx
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
-e 
-e

File: web/src/components/ui/tabs.tsx
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
-e 
-e

File: web/src/components/ui/card.tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
-e 
-e

File: web/src/components/ui/chart.tsx
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"]
}) {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean
    hideIndicator?: boolean
    indicator?: "line" | "dot" | "dashed"
    nameKey?: string
    labelKey?: string
  }) {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      )
    }

    if (!value) {
      return null
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== "dot"

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload.map((item, index) => {
          const key = `${nameKey || item.name || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)
          const indicatorColor = color || item.payload.fill || item.color

          return (
            <div
              key={item.dataKey}
              className={cn(
                "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                indicator === "dot" && "items-center"
              )}
            >
              {formatter && item?.value !== undefined && item.name ? (
                formatter(item.value, item.name, item, index, item.payload)
              ) : (
                <>
                  {itemConfig?.icon ? (
                    <itemConfig.icon />
                  ) : (
                    !hideIndicator && (
                      <div
                        className={cn(
                          "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                          {
                            "h-2.5 w-2.5": indicator === "dot",
                            "w-1": indicator === "line",
                            "w-0 border-[1.5px] border-dashed bg-transparent":
                              indicator === "dashed",
                            "my-0.5": nestLabel && indicator === "dashed",
                          }
                        )}
                        style={
                          {
                            "--color-bg": indicatorColor,
                            "--color-border": indicatorColor,
                          } as React.CSSProperties
                        }
                      />
                    )
                  )}
                  <div
                    className={cn(
                      "flex flex-1 justify-between leading-none",
                      nestLabel ? "items-end" : "items-center"
                    )}
                  >
                    <div className="grid gap-1.5">
                      {nestLabel ? tooltipLabel : null}
                      <span className="text-muted-foreground">
                        {itemConfig?.label || item.name}
                      </span>
                    </div>
                    {item.value && (
                      <span className="text-foreground font-mono font-medium tabular-nums">
                        {item.value.toLocaleString()}
                      </span>
                    )}
                  </div>
                </>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}

const ChartLegend = RechartsPrimitive.Legend

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean
    nameKey?: string
  }) {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className
      )}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || "value"}`
        const itemConfig = getPayloadConfigFromPayload(config, item, key)

        return (
          <div
            key={item.value}
            className={cn(
              "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3"
            )}
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        )
      })}
    </div>
  )
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
-e 
-e

File: web/src/components/ui/sheet.tsx
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function SheetContent({
  className,
  children,
  side = "right",
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left"
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  )
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  )
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  )
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  )
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
-e 
-e

File: web/src/components/ui/scroll-area.tsx
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }
-e 
-e

File: web/src/components/ui/resizable.tsx
"use client"

import * as React from "react"
import { GripVerticalIcon } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        "bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        <div className="bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border">
          <GripVerticalIcon className="size-2.5" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
-e 
-e

File: web/src/components/ui/label.tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }
-e 
-e

File: web/src/components/ui/sonner.tsx
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner, ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
-e 
-e

File: web/src/components/ui/accordion.tsx
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn("border-b last:border-b-0", className)}
      {...props}
    />
  )
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
          className
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  )
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn("pt-0 pb-4", className)}>{children}</div>
    </AccordionPrimitive.Content>
  )
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
-e 
-e

File: web/src/components/ui/tooltip.tsx
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      data-slot="tooltip-provider"
      delayDuration={delayDuration}
      {...props}
    />
  )
}

function Tooltip({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return (
    <TooltipProvider>
      <TooltipPrimitive.Root data-slot="tooltip" {...props} />
    </TooltipProvider>
  )
}

function TooltipTrigger({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({
  className,
  sideOffset = 0,
  children,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",
          className
        )}
        {...props}
      >
        {children}
        <TooltipPrimitive.Arrow className="bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
-e 
-e

File: web/src/components/ui/alert.tsx
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }
-e 
-e

File: web/src/components/ui/switch.tsx
"use client"

import * as React from "react"
import * as SwitchPrimitive from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
        )}
      />
    </SwitchPrimitive.Root>
  )
}

export { Switch }
-e 
-e

File: web/src/components/ui/breadcrumb.tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

function Breadcrumb({ ...props }: React.ComponentProps<"nav">) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<"ol">) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        "text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5",
        className
      )}
      {...props}
    />
  )
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn("inline-flex items-center gap-1.5", className)}
      {...props}
    />
  )
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn("hover:text-foreground transition-colors", className)}
      {...props}
    />
  )
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("text-foreground font-normal", className)}
      {...props}
    />
  )
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn("[&>svg]:size-3.5", className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  )
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  )
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}
-e 
-e

File: web/src/components/ui/command.tsx
"use client"

import * as React from "react"
import { Command as CommandPrimitive } from "cmdk"
import { SearchIcon } from "lucide-react"

import { cn } from "@/lib/utils"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className
      )}
      {...props}
    />
  )
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string
  description?: string
  className?: string
  showCloseButton?: boolean
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn("overflow-hidden p-0", className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        {...props}
      />
    </div>
  )
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className
      )}
      {...props}
    />
  )
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  )
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className
      )}
      {...props}
    />
  )
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  )
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
-e 
-e

File: web/src/components/ui/avatar.tsx
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }
-e 
-e

File: web/src/components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
-e 
-e

File: web/src/components/ui/badge.tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
-e 
-e

File: web/src/components/ui/sidebar.tsx
"use client"

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, VariantProps } from "class-variance-authority"
import { PanelLeftIcon } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContextProps = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContextProps | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  defaultOpen?: boolean
  open?: boolean
  onOpenChange?: (open: boolean) => void
}) {
  const isMobile = useIsMobile()
  const [openMobile, setOpenMobile] = React.useState(false)

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen)
  const open = openProp ?? _open
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value
      if (setOpenProp) {
        setOpenProp(openState)
      } else {
        _setOpen(openState)
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
    },
    [setOpenProp, open]
  )

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)
  }, [isMobile, setOpen, setOpenMobile])

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault()
        toggleSidebar()
      }
    }

    window.addEventListener("keydown", handleKeyDown)
    return () => window.removeEventListener("keydown", handleKeyDown)
  }, [toggleSidebar])

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed"

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
  )

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            "group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",
            className
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  )
}

function Sidebar({
  side = "left",
  variant = "sidebar",
  collapsible = "offcanvas",
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  side?: "left" | "right"
  variant?: "sidebar" | "floating" | "inset"
  collapsible?: "offcanvas" | "icon" | "none"
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

  if (collapsible === "none") {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          "bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col",
          className
        )}
        {...props}
      >
        {children}
      </div>
    )
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    )
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          "relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon)"
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  )
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn("size-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
}

function SidebarRail({ className, ...props }: React.ComponentProps<"button">) {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex",
        "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
}

function SidebarInset({ className, ...props }: React.ComponentProps<"main">) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        "bg-background relative flex w-full flex-1 flex-col",
        "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2",
        className
      )}
      {...props}
    />
  )
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn("bg-background h-8 w-full shadow-none", className)}
      {...props}
    />
  )
}

function SidebarHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
}

function SidebarFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn("bg-sidebar-border mx-2 w-auto", className)}
      {...props}
    />
  )
}

function SidebarContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        "text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn("w-full text-sm", className)}
      {...props}
    />
  )
}

function SidebarMenu({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn("flex w-full min-w-0 flex-col gap-1", className)}
      {...props}
    />
  )
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn("group/menu-item relative", className)}
      {...props}
    />
  )
}

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:p-0!",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = "default",
  size = "default",
  tooltip,
  className,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean
  isActive?: boolean
  tooltip?: string | React.ComponentProps<typeof TooltipContent>
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : "button"
  const { isMobile, state } = useSidebar()

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  )

  if (!tooltip) {
    return button
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    }
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== "collapsed" || isMobile}
        {...tooltip}
      />
    </Tooltip>
  )
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean
  showOnHover?: boolean
}) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0",
        className
      )}
      {...props}
    />
  )
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        "text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<"div"> & {
  showIcon?: boolean
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-(--skeleton-width) flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        "border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn("group/menu-sub-item relative", className)}
      {...props}
    />
  )
}

function SidebarMenuSubButton({
  asChild = false,
  size = "md",
  isActive = false,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean
  size?: "sm" | "md"
  isActive?: boolean
}) {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}
-e 
-e

File: web/src/components/ui/table.tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
-e 
-e

File: web/src/components/ui/separator.tsx
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }
-e 
-e

File: web/src/components/ui/button.tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
-e 
-e

File: web/src/components/ui/collapsible.tsx
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  )
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  )
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
-e 
-e

File: web/src/components/ui/dropdown-menu.tsx
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
-e 
-e

File: web/src/components/ui/select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
-e 
-e

File: web/src/components/ui/textarea.tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }
-e 
-e

File: web/src/components/ui/input.tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }
-e 
-e

File: web/src/components/ui/skeleton.tsx
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }
-e 
-e

File: web/src/components/auth/AuthVisual.tsx
"use client";

import { motion } from "framer-motion";

export const AuthVisual = () => {
  return (
    <div className="relative flex h-full w-full items-center justify-center overflow-hidden bg-gray-950">
      <div
        className="absolute inset-0 h-full w-full"
        style={{
          backgroundImage:
            "linear-gradient(to right, hsl(var(--border)) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border)) 1px, transparent 1px)",
          backgroundSize: "3rem 3rem",
        }}
      />
      <div className="relative h-full w-full">
        <motion.div
          animate={{
            x: ["-20%", "20%", "-20%"],
            y: ["-20%", "30%", "-20%"],
            rotate: [0, 180, 0],
          }}
          transition={{
            duration: 40,
            repeat: Infinity,
            repeatType: "reverse",
            ease: "easeInOut",
          }}
          className="absolute -top-1/4 -left-1/4 h-1/2 w-1/2 rounded-full bg-gradient-to-br from-blue-500/50 to-purple-600/50 blur-3xl filter"
        />
        <motion.div
          animate={{
            x: ["20%", "-20%", "20%"],
            y: ["20%", "-30%", "20%"],
            rotate: [0, -180, 0],
          }}
          transition={{
            duration: 35,
            repeat: Infinity,
            repeatType: "reverse",
            ease: "easeInOut",
          }}
          className="absolute -bottom-1/4 -right-1/4 h-2/3 w-2/3 rounded-full bg-gradient-to-tl from-cyan-400/40 to-indigo-500/40 blur-3xl filter"
        />
      </div>
      <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/20 p-8 text-center text-white">
        <h1 className="mb-4 text-3xl font-bold tracking-tight">
          Where Culture Meets Capital.
        </h1>
        <p className="max-w-md text-lg text-white/80">
          Alloy is a financial-grade intelligence platform that de-risks acquisitions by replacing gut feeling with a data-driven Cultural Compatibility Score.
        </p>
      </div>
    </div>
  );
};-e 
-e

File: web/src/components/report/AIAnalystChat.tsx
"use client";

import React, { useState, useRef, useEffect } from 'react';
import { useAuth } from '@/components/global/providers';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import ReactMarkdown from "react-markdown";
import { ScrollArea } from '@/components/ui/scroll-area';
import { motion, AnimatePresence } from 'framer-motion';
import { Bot, User, CornerDownLeft, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Report } from '@/types/report';
import { toast } from 'sonner';
import Logo from '../global/Logo';

interface Message {
  id: string;
  sender: 'user' | 'bot';
  text: string;
}

interface AIAnalystChatProps {
  report: Report;
}

export const AIAnalystChat = ({ report }: AIAnalystChatProps) => {
  const { accessToken } = useAuth();
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    // Scroll to bottom when new messages are added
    if (scrollAreaRef.current) {
      scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' });
    }
  }, [messages]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const userMessage: Message = { id: `user-${Date.now()}`, sender: 'user', text: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setIsLoading(true);

    const historyForApi = [...messages, userMessage].map(msg => ({
        role: msg.sender === 'bot' ? 'assistant' : 'user', // Match backend/service expectation
        content: msg.text
    }));

    const botMessageId = `bot-${Date.now()}`;
    setMessages(prev => [...prev, { id: botMessageId, sender: 'bot', text: '...' }]);

    try {
        const reportContext = `
        Report Title: ${report.title}
        Acquirer: ${report.acquirer_brand}
        Target: ${report.target_brand}
        Compatibility Score: ${report.analysis?.cultural_compatibility_score}
        Strategic Summary: ${report.analysis?.strategic_summary}
        Culture Clashes: ${report.culture_clashes.map(c => `- ${c.topic}: ${c.description} (Severity: ${c.severity})`).join('\n')}
        Untapped Growth: ${report.untapped_growths.map(g => `- ${g.description} (Impact: ${g.potential_impact_score})`).join('\n')}
      `;

      const res = await fetch(`/api/v1/reports/${report.id}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({ messages: historyForApi, context: reportContext })
      });

      if (!res.ok || !res.body) {
        throw new Error('Failed to get chat response from server.');
      }
      
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      setMessages(prev => prev.map(msg => msg.id === botMessageId ? { ...msg, text: '' } : msg)); // Clear the "..."
      let done = false;

      while (!done) {
        const { value, done: readerDone } = await reader.read();
        done = readerDone;
        const chunk = decoder.decode(value);
        setMessages(prev => prev.map(msg => 
            msg.id === botMessageId ? { ...msg, text: msg.text + chunk } : msg
        ));
      }

    } catch (error: any) {
        const errorMessage = "I'm sorry, I encountered an error. Please try again.";
        toast.error("Chat Error", { description: error.message || "An unknown error occurred." });
        setMessages(prev => prev.map(msg => 
            msg.id === botMessageId ? { ...msg, text: errorMessage } : msg
        ));
        setMessages(prev => prev.filter(msg => msg.id !== botMessageId));
    } finally {
        setIsLoading(false);
    }
  };

  return (
    <div className="flex flex-col h-full bg-background/50 border-l border-border">
      <div className="p-4 border-b border-border">
        <h3 className="font-semibold text-lg text-foreground">AI Analyst Chat</h3>
        <p className="text-sm text-muted-foreground">Ask questions about this report.</p>
      </div>
      <ScrollArea className="flex-grow p-4" ref={scrollAreaRef}>
        <div className="space-y-6">
            <AnimatePresence>
            {messages.length === 0 && (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="text-center text-muted-foreground text-sm pt-8">
                    Ask a follow-up question like "Summarize the key risks" or "Expand on the opportunity with [topic]".
                </motion.div>
            )}
            {messages.map(message => (
                <motion.div
                    key={message.id}
                    layout
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3 }}
                    className={cn(
                        "flex items-start gap-3 w-full",
                        message.sender === 'user' ? "justify-end" : "justify-start"
                    )}
                >
                    {message.sender === 'bot' && <div className="flex-shrink-0 bg-muted rounded-full p-2"><Logo className="h-4 w-4" /></div>}
                    <div className={cn(
                        "max-w-md rounded-lg px-4 py-2 text-sm prose prose-sm dark:prose-invert prose-p:my-2",
                        message.sender === 'bot' ? 'bg-muted rounded-bl-none' : 'bg-primary text-primary-foreground rounded-br-none'
                    )}>
                        <ReactMarkdown>{message.text}</ReactMarkdown>
                        {isLoading && message.id.startsWith('bot-') && messages[messages.length-1].id === message.id && <span className="inline-block w-2 h-4 bg-foreground ml-1 animate-pulse" />}
                    </div>
                    {message.sender === 'user' && <div className="flex-shrink-0 bg-primary/20 rounded-full p-2"><User className="h-4 w-4" /></div>}
                </motion.div>
            ))}
            </AnimatePresence>
        </div>
      </ScrollArea>
      <div className="p-4 border-t border-border bg-background">
        <form onSubmit={handleSubmit} className="relative">
          <Textarea
            value={input}
            onChange={e => setInput(e.target.value)}
            onKeyDown={(e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    handleSubmit(e);
                }
            }}
            placeholder="Ask a follow-up..."
            className="pr-12 min-h-[40px] max-h-48"
            disabled={isLoading}
          />
          <Button type="submit" size="icon" className="absolute right-2 bottom-1.5 h-8 w-8" disabled={isLoading || !input.trim()}>
            {isLoading ? <Loader2 className="h-4 w-4 animate-spin"/> : <CornerDownLeft className="h-4 w-4" />}
          </Button>
        </form>
      </div>
    </div>
  );
};-e 
-e

File: web/src/components/report/ReportView.tsx
"use client";

import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "../ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { AlertTriangle, TrendingUp, Zap, Link as LinkIcon, Globe, Users, Target, Scale, Briefcase, BarChart3, CheckCircle } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";
import { Report, ClashSeverity, ReportAnalysis } from "@/types/report";
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { AIAnalystChat } from "./AIAnalystChat";
import Image from "next/image";
import Link from "next/link";
import { Bar, BarChart, ResponsiveContainer, XAxis, YAxis, Tooltip, RadialBar, RadialBarChart, PolarAngleAxis } from 'recharts';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ChartContainer } from "../ui/chart";
import { ScrollArea } from "../ui/scroll-area";
import { Tooltip as TooltipPrimitive, TooltipContent as TooltipContentPrimitive, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { cn } from "@/lib/utils";
import React, { useMemo } from "react";
import ReactMarkdown from "react-markdown";

interface ReportViewProps {
  report: Report;
  children?: React.ReactNode; 
}

// --- Helper Functions and Components ---
const useParsedReport = (report: Report) => {
    return useMemo(() => {
        const parsedReport = { ...report };
        if (report.analysis) {
            const mutableAnalysis = { ...report.analysis };
            const keys_to_parse = ['brand_archetype_summary', 'corporate_ethos_summary', 'persona_expansion_summary'];
            for (const key of keys_to_parse) {
                if (typeof (mutableAnalysis as any)[key] === 'string') {
                    try {
                        (mutableAnalysis as any)[key] = JSON.parse((mutableAnalysis as any)[key]);
                    } catch (e) {
                        console.error(`Failed to parse ${key}:`, (mutableAnalysis as any)[key]);
                        (mutableAnalysis as any)[key] = {};
                    }
                }
            }
            parsedReport.analysis = mutableAnalysis;
        }
        return parsedReport;
    }, [report]);
};

const CompanyLogo = ({ brandName, size = 'large' }: { brandName: string, size?: 'large' | 'small' }) => {
    const faviconUrl = `/api/v1/utils/favicon?brandName=${encodeURIComponent(brandName)}`;
    const config = {
        large: { dim: 40, text: 'text-xl', padding: 'p-1', gap: 'gap-3' },
        small: { dim: 24, text: 'text-base', padding: 'p-0.5', gap: 'gap-2' },
    }[size];

    return (
        <div className={cn("flex items-center", config.gap)}>
            <Image src={faviconUrl} alt={`${brandName} logo`} width={config.dim} height={config.dim} className={cn("rounded-lg border bg-background", config.padding)} unoptimized priority={false}/>
            <span className={cn("font-semibold", config.text)}>{brandName}</span>
        </div>
    );
};

const SeverityBadge = ({ severity }: { severity: ClashSeverity }) => {
  const config = {
    HIGH: { text: "High", className: "bg-red-200 text-red-800 border-red-300 dark:bg-red-900/50 dark:text-red-300 dark:border-red-700" },
    MEDIUM: { text: "Medium", className: "bg-yellow-200 text-yellow-800 border-yellow-300 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-700" },
    LOW: { text: "Low", className: "bg-blue-200 text-blue-800 border-blue-300 dark:bg-blue-900/50 dark:text-blue-300 dark:border-blue-700" },
  };
  const { text, className } = config[severity] || config.LOW;
  return <Badge className={`font-semibold ${className}`}>{text}</Badge>;
};

const SourcePill = ({ url }: { url: string }) => {
    try {
        const domain = new URL(url).hostname?.replace('www.', '');
        const faviconUrl = `/api/v1/utils/favicon?url=${encodeURIComponent(url)}`;
        return (
            <Link href={url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 rounded-full border bg-secondary/50 px-3 py-1 text-sm text-secondary-foreground transition-colors hover:bg-secondary">
                <Image src={faviconUrl} alt={`${domain} favicon`} width={16} height={16} className="rounded-full" unoptimized/>
                {domain}
            </Link>
        )
    } catch (error) {
        return <Link href={url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 rounded-full border bg-secondary/50 px-3 py-1 text-sm text-secondary-foreground transition-colors hover:bg-secondary"><LinkIcon className="h-4 w-4" />{url}</Link>
    }
}

const DimensionItem = ({ text, icon: Icon, colorClass, tooltipContent }: { text: string; icon: React.ElementType; colorClass: string; tooltipContent: string; }) => (
    <TooltipProvider>
        <TooltipPrimitive>
            <TooltipTrigger asChild>
                <div className="flex items-start gap-3 p-2 rounded-md transition-colors hover:bg-muted/50 w-full text-left">
                    <div className={cn("flex-shrink-0 mt-1 w-4 h-4 flex items-center justify-center rounded-full", colorClass)}>
                        <Icon className="h-2.5 w-2.5 text-white" />
                    </div>
                    <p className="text-sm text-foreground truncate">{text}</p>
                </div>
            </TooltipTrigger>
            <TooltipContentPrimitive side="top" align="start" className="max-w-xs">
                <p>{tooltipContent}</p>
            </TooltipContentPrimitive>
        </TooltipPrimitive>
    </TooltipProvider>
);

const CulturalDimensionsVisual = ({ report }: { report: Report }) => {
    const acquirerUnique = report.culture_clashes.filter(c => c.description.includes("Acquirer"));
    const targetUnique = report.culture_clashes.filter(c => c.description.includes("Target"));
    const shared = report.untapped_growths;

    const columnHeaderClasses = "font-semibold text-foreground flex items-center gap-2 mb-3";

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Users /> Cultural Taste Dimensions</CardTitle>
                <CardDescription>A breakdown of unique and shared affinities between the two brand audiences.</CardDescription>
            </CardHeader>
            <CardContent className="grid md:grid-cols-3 gap-px bg-border border rounded-lg overflow-hidden">
                <div className="p-4 bg-card"><div className={columnHeaderClasses}><CompanyLogo brandName={report.acquirer_brand} size="small"/><span>Unique</span></div>
                    <ScrollArea className="h-64 pr-3"><div className="space-y-1">
                        {acquirerUnique.length > 0 ? acquirerUnique.map(clash => (<DimensionItem key={clash.id} text={clash.topic} icon={AlertTriangle} colorClass="bg-blue-500" tooltipContent={clash.description}/>)) : <p className="text-sm text-muted-foreground p-2">No unique tastes identified.</p>}
                    </div></ScrollArea>
                </div>
                <div className="p-4 bg-card"><div className={columnHeaderClasses}><Zap className="text-green-500" /><span>Shared Affinities</span></div>
                    <ScrollArea className="h-64 pr-3"><div className="space-y-1">
                        {shared.length > 0 ? shared.map(growth => (<DimensionItem key={growth.id} text={growth.description.match(/'([^']*)'/)?.[1] || "Growth Opportunity"} icon={TrendingUp} colorClass="bg-green-500" tooltipContent={growth.description}/>)) : <p className="text-sm text-muted-foreground p-2">No shared affinities identified.</p>}
                    </div></ScrollArea>
                </div>
                <div className="p-4 bg-card"><div className={columnHeaderClasses}><CompanyLogo brandName={report.target_brand} size="small"/><span>Unique</span></div>
                    <ScrollArea className="h-64 pr-3"><div className="space-y-1">
                        {targetUnique.length > 0 ? targetUnique.map(clash => (<DimensionItem key={clash.id} text={clash.topic} icon={AlertTriangle} colorClass="bg-purple-500" tooltipContent={clash.description}/>)) : <p className="text-sm text-muted-foreground p-2">No unique tastes identified.</p>}
                    </div></ScrollArea>
                </div>
            </CardContent>
        </Card>
    );
};


// --- Main View Sections ---

const ReportHeader = ({ report, children }: { report: Report, children?: React.ReactNode }) => (
    <div className="space-y-4">
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <CompanyLogo brandName={report.acquirer_brand} />
            <span className="h-8 w-8 text-muted-foreground flex-shrink-0">
                ACQUIRING
            </span>
            <CompanyLogo brandName={report.target_brand} />
        </div>
        <Card>
            <CardHeader className='flex-row items-center justify-between'>
                <div>
                    <CardTitle className="text-3xl">{report.title}</CardTitle>
                    <CardDescription>Cultural due diligence report generated on {new Date(report.created_at).toLocaleString()}.</CardDescription>
                </div>
                <div className="flex-shrink-0">{children}</div>
            </CardHeader>
        </Card>
    </div>
);

const ScoreAndArchetypes = ({ report }: { report: Report }) => {
    const analysis = report.analysis;
    if (!analysis) return null;

    const archetypes = (analysis.brand_archetype_summary || {}) as { acquirer_archetype?: string, target_archetype?: string };
    const chartData = [{ name: 'Score', value: analysis.cultural_compatibility_score, fill: 'hsl(var(--primary))' }];
    
    return (
        <div className="grid md:grid-cols-2 gap-6">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><Scale />Cultural Compatibility Score</CardTitle>
                    <CardDescription>Overall alignment based on audience taste.</CardDescription>
                </CardHeader>
                <CardContent className="flex items-center justify-center">
                    <ChartContainer config={{}} className="mx-auto aspect-square h-[200px] w-[200px]">
                        <RadialBarChart
                            data={chartData} 
                            cx="50%"
                            cy="50%"
                            startAngle={90} 
                            endAngle={-270} 
                            innerRadius="80%" 
                            outerRadius="100%" 
                            barSize={30}
                        >
                            <PolarAngleAxis type="number" domain={[0, 100]} tick={false} />
                            <RadialBar dataKey="value" background={{ fill: 'hsl(var(--muted))' }} cornerRadius={15} />
                            <text x="50%" y="50%" textAnchor="middle" dominantBaseline="middle" className="fill-foreground text-5xl font-bold">
                                {analysis.cultural_compatibility_score.toFixed(0)}
                            </text>
                            <text x="50%" y="65%" textAnchor="middle" dominantBaseline="middle" className="fill-muted-foreground text-sm">
                                / 100
                            </text>
                        </RadialBarChart>
                    </ChartContainer>
                </CardContent>
            </Card>
            <Card>
                <CardHeader>
                    <CardTitle>Brand Archetypes</CardTitle>
                    <CardDescription>AI-generated personalities from taste data.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4 h-[200px] overflow-y-auto">
                    <div>
                        <h3 className="font-semibold text-foreground flex items-center gap-2"><Users className="h-4 w-4" />{report.acquirer_brand}</h3>
                        <p className="text-muted-foreground text-sm whitespace-pre-wrap">{archetypes.acquirer_archetype || "Analysis not available."}</p>
                    </div>
                    <Separator />
                    <div>
                        <h3 className="font-semibold text-foreground flex items-center gap-2"><Target className="h-4 w-4" />{report.target_brand}</h3>
                        <p className="text-muted-foreground text-sm whitespace-pre-wrap">{archetypes.target_archetype || "Analysis not available."}</p>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
};

const AffinityAnalysis = ({ report }: { report: Report }) => {
    if (!report.analysis) return null
    const shared = report.untapped_growths.slice(0, 5).map(g => ({ name: g.description.match(/'([^']*)'/)?.[1] || g.description.substring(0,20), score: g.potential_impact_score * 10 }));
    const acquirer_unique = report.culture_clashes.filter(c => c.description.includes("Acquirer")).slice(0, 5).map(c => ({ name: c.topic, score: 75 }));
    const target_unique = report.culture_clashes.filter(c => c.description.includes("Target")).slice(0, 5).map(c => ({ name: c.topic, score: 75 }));;

    const chartData = [
        { name: report.acquirer_brand, value: acquirer_unique.length, fill: '#3b82f6' },
        { name: 'Shared Affinity', value: shared.length, fill: 'hsl(var(--primary))' },
        { name: report.target_brand, value: target_unique.length, fill: '#8b5cf6' },
    ];

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <div className="flex justify-between items-start">
                        <div>
                            <CardTitle>Affinity Overlap</CardTitle>
                            <CardDescription>Number of distinct vs. shared cultural markers identified.</CardDescription>
                        </div>
                        <div className="text-right"><div className="text-2xl font-bold">{report.analysis.affinity_overlap_score.toFixed(1)}%</div><div className="text-xs text-muted-foreground">Taste Overlap</div></div>
                    </div>
                </CardHeader>
                <CardContent className="h-[250px]">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData} layout="vertical" barCategoryGap="20%">
                            <XAxis type="number" hide />
                            <YAxis type="category" dataKey="name" hide />
                            <Tooltip cursor={{ fill: 'transparent' }} contentStyle={{backgroundColor: 'hsl(var(--background))', border: '1px solid hsl(var(--border))', borderRadius: 'var(--radius)'}}/>
                            <Bar dataKey="value" radius={5}>
                                {chartData.map((entry, index) => (
                                    <text
                                        key={`label-${index}`}
                                        x={10}
                                        y={index * (250 / chartData.length) + (250 / chartData.length) / 2}
                                        dy={5}
                                        fill="white"
                                        className="text-sm font-medium"
                                    >
                                        {entry.name}
                                    </text>
                                ))}
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                </CardContent>
            </Card>
            <CulturalDimensionsVisual report={report} />
        </div>
    );
};

const CorporateCultureAnalysis = ({ report }: { report: Report }) => {
    const analysis = report.analysis;
    if (!analysis || (!analysis.acquirer_corporate_profile && !analysis.target_corporate_profile)) {
        return <div className="text-center py-8 text-muted-foreground">No corporate culture analysis was performed for this report.</div>;
    }

    const ethos = (analysis.corporate_ethos_summary || {}) as { acquirer_ethos?: string, target_ethos?: string };

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><Briefcase /> Corporate Ethos Synthesis</CardTitle>
                    <CardDescription>A comparative analysis of leadership, values, and work culture.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div>
                        <h3 className="font-semibold text-foreground flex items-center gap-2"><Users className="h-4 w-4" />{report.acquirer_brand}</h3>
                        <p className="text-muted-foreground text-sm whitespace-pre-wrap">{ethos.acquirer_ethos || "Analysis not available."}</p>
                    </div>
                    <Separator />
                    <div>
                        <h3 className="font-semibold text-foreground flex items-center gap-2"><Target className="h-4 w-4" />{report.target_brand}</h3>
                        <p className="text-muted-foreground text-sm whitespace-pre-wrap">{ethos.target_ethos || "Analysis not available."}</p>
                    </div>
                </CardContent>
            </Card>

            <div className="grid md:grid-cols-2 gap-6">
                <Card>
                    <CardHeader>
                        <CardTitle>Acquirer Culture Profile</CardTitle>
                        <CardDescription>Raw intelligence gathered on {report.acquirer_brand}.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <ScrollArea className="h-48">
                            {/* --- THE FIX IS HERE --- */}
                            <div className="text-sm text-muted-foreground whitespace-pre-wrap prose prose-sm dark:prose-invert prose-p:my-2">
                                <ReactMarkdown>{analysis.acquirer_corporate_profile || "No data found."}</ReactMarkdown>
                            </div>
                        </ScrollArea>
                        {analysis.acquirer_culture_sources && analysis.acquirer_culture_sources.length > 0 && <div><h4 className="text-xs font-semibold uppercase text-muted-foreground mb-2">Sources</h4><div className="flex flex-wrap gap-2">{analysis.acquirer_culture_sources.map(s => <SourcePill key={s.url} url={s.url} />)}</div></div>}
                    </CardContent>
                </Card>
                 <Card>
                    <CardHeader>
                        <CardTitle>Target Culture Profile</CardTitle>
                        <CardDescription>Raw intelligence gathered on {report.target_brand}.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <ScrollArea className="h-48">
                            {/* --- THE FIX IS HERE --- */}
                             <div className="text-sm text-muted-foreground whitespace-pre-wrap prose prose-sm dark:prose-invert prose-p:my-2">
                                <ReactMarkdown>{analysis.target_corporate_profile || "No data found."}</ReactMarkdown>
                            </div>
                        </ScrollArea>
                        {analysis.target_culture_sources && analysis.target_culture_sources.length > 0 && <div><h4 className="text-xs font-semibold uppercase text-muted-foreground mb-2">Sources</h4><div className="flex flex-wrap gap-2">{analysis.target_culture_sources.map(s => <SourcePill key={s.url} url={s.url} />)}</div></div>}
                    </CardContent>
                </Card>
            </div>
        </div>
    );
};

const FinancialAnalysis = ({ report }: { report: Report }) => {
    const analysis = report.analysis;
    if (!analysis || (!analysis.acquirer_financial_profile && !analysis.target_financial_profile)) {
        return <div className="text-center py-8 text-muted-foreground">No financial & market analysis was performed for this report.</div>;
    }

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><BarChart3 /> Financial & Market Synthesis</CardTitle>
                    <CardDescription>A comparative summary of financial health and market positioning.</CardDescription>
                </CardHeader>
                <CardContent>
                    <p className="text-muted-foreground text-sm whitespace-pre-wrap">{analysis.financial_synthesis || "Analysis not available."}</p>
                </CardContent>
            </Card>

            <div className="grid md:grid-cols-2 gap-6">
                <Card>
                    <CardHeader>
                        <CardTitle>Acquirer Financial Profile</CardTitle>
                        <CardDescription>Raw intelligence gathered on {report.acquirer_brand}.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <ScrollArea className="h-48">
                            {/* --- THE FIX IS HERE --- */}
                             <div className="text-sm text-muted-foreground whitespace-pre-wrap prose prose-sm dark:prose-invert prose-p:my-2">
                                <ReactMarkdown>{analysis.acquirer_financial_profile || "No data found."}</ReactMarkdown>
                            </div>
                        </ScrollArea>
                        {analysis.acquirer_financial_sources && analysis.acquirer_financial_sources.length > 0 && <div><h4 className="text-xs font-semibold uppercase text-muted-foreground mb-2">Sources</h4><div className="flex flex-wrap gap-2">{analysis.acquirer_financial_sources.map(s => <SourcePill key={s.url} url={s.url} />)}</div></div>}
                    </CardContent>
                </Card>
                 <Card>
                    <CardHeader>
                        <CardTitle>Target Financial Profile</CardTitle>
                        <CardDescription>Raw intelligence gathered on {report.target_brand}.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <ScrollArea className="h-48">
                           {/* --- THE FIX IS HERE --- */}
                            <div className="text-sm text-muted-foreground whitespace-pre-wrap prose prose-sm dark:prose-invert prose-p:my-2">
                                <ReactMarkdown>{analysis.target_financial_profile || "No data found."}</ReactMarkdown>
                            </div>
                        </ScrollArea>
                        {analysis.target_financial_sources && analysis.target_financial_sources.length > 0 && <div><h4 className="text-xs font-semibold uppercase text-muted-foreground mb-2">Sources</h4><div className="flex flex-wrap gap-2">{analysis.target_financial_sources.map(s => <SourcePill key={s.url} url={s.url} />)}</div></div>}
                    </CardContent>
                </Card>
            </div>
        </div>
    );
};

const ExpansionPotentialCard = ({ report }: { report: Report }) => {
    if (!report.analysis?.persona_expansion_summary) return null;

    const expansionData = report.analysis.persona_expansion_summary as { expansion_score: number; latent_synergies: string[]; analysis: string };

    if (!expansionData || expansionData.expansion_score === undefined) return null;

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Zap className="text-yellow-400"/>Audience Expansion Potential</CardTitle>
                <CardDescription>Predicted synergies based on Qloo's Persona API, revealing latent growth opportunities.</CardDescription>
            </CardHeader>
            <CardContent className="grid md:grid-cols-2 gap-6 items-center">
                <div className="flex flex-col items-center justify-center">
                    <div className="text-6xl font-bold text-yellow-400">{expansionData.expansion_score.toFixed(1)}%</div>
                    <div className="text-sm font-medium text-muted-foreground mt-1">Latent Synergy Score</div>
                </div>
                <div>
                    <h4 className="font-semibold mb-2">Top Predicted Affinities</h4>
                    <p className="text-sm text-muted-foreground mb-3">{expansionData.analysis}</p>
                    <div className="space-y-2">
                        {expansionData.latent_synergies.map(item => (
                            <div key={item} className="flex items-center gap-2 text-xs text-foreground">
                                <CheckCircle className="h-3 w-3 text-green-500" />
                                {item}
                            </div>
                        ))}
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}

export const ReportView = ({ report, children }: ReportViewProps) => {
    const parsedReport = useParsedReport(report);

    if (parsedReport.status === "FAILED") {
        return <div className="flex h-full items-center justify-center p-8 text-center">
            <div>
                <AlertTriangle className="mx-auto h-12 w-12 text-destructive" />
                <h2 className="mt-4 text-2xl font-bold">Report Generation Failed</h2>
                <p className="mt-2 text-muted-foreground">We were unable to generate this report. This can happen due to issues with source data availability. Please try again or create a new report with different brands.</p>
            </div>
        </div>
    }

    const allSources = [
        ...(parsedReport.analysis?.acquirer_sources || []),
        ...(parsedReport.analysis?.target_sources || []),
        ...(parsedReport.analysis?.search_sources || []),
        ...(parsedReport.analysis?.acquirer_culture_sources || []),
        ...(parsedReport.analysis?.target_culture_sources || []),
        ...(parsedReport.analysis?.acquirer_financial_sources || []),
        ...(parsedReport.analysis?.target_financial_sources || []),
    ];
    const uniqueSources = Array.from(new Set(allSources.map(s => s.url))).map(url => allSources.find(s => s.url === url)!);


    return (
        <ResizablePanelGroup direction="horizontal" className="h-full max-h-[calc(100vh-8rem)] w-full rounded-none border-0 sm:rounded-lg sm:border">
            <ResizablePanel defaultSize={65} minSize={50}>
                <ScrollArea className="h-full p-4 md:p-6">
                    <div className="space-y-6">
                        <ReportHeader report={parsedReport} children={children} />
                        <ScoreAndArchetypes report={parsedReport} />
                        <ExpansionPotentialCard report={parsedReport} />

                        <Tabs defaultValue="affinity">
                            <TabsList>
                                <TabsTrigger value="affinity">Audience Affinity</TabsTrigger>
                                <TabsTrigger value="corporate">Corporate Culture</TabsTrigger>
                                <TabsTrigger value="financial">Financial & Market</TabsTrigger>
                                <TabsTrigger value="sources">Sources</TabsTrigger>
                            </TabsList>
                            <TabsContent value="affinity" className="mt-4">
                                <AffinityAnalysis report={parsedReport} />
                            </TabsContent>
                            <TabsContent value="corporate" className="mt-4">
                                <CorporateCultureAnalysis report={parsedReport} />
                            </TabsContent>
                            <TabsContent value="financial" className="mt-4">
                                <FinancialAnalysis report={parsedReport} />
                            </TabsContent>
                             <TabsContent value="sources" className="mt-4">
                                 {uniqueSources.length > 0 ? (
                                    <Card>
                                        <CardHeader><CardTitle className="flex items-center gap-2"><Globe className="h-5 w-5 text-blue-500" />Grounding Sources</CardTitle><CardDescription>Web sources used for analysis.</CardDescription></CardHeader>
                                        <CardContent>
                                            <div className="columns-1 md:columns-2 lg:columns-3 gap-4 space-y-2">
                                                {uniqueSources.map(source => <SourcePill key={source.url} url={source.url} />)}
                                            </div>
                                        </CardContent>
                                    </Card>
                                  ) : <p className="text-muted-foreground text-center py-8">No external sources were used for this analysis.</p>}
                             </TabsContent>
                        </Tabs>
                        <div className="text-center text-xs text-muted-foreground pt-8">
                            <p>Report ID: {parsedReport.id}</p>
                            <p>Cultural taste data powered by <Link href="https://qloo.com" target="_blank" className="underline hover:text-foreground">Qloo, the AI for Culture and Taste</Link>.</p>
                        </div>
                    </div>
                </ScrollArea>
            </ResizablePanel>
            <ResizableHandle withHandle />
            <ResizablePanel defaultSize={35} minSize={25}>
                <AIAnalystChat report={parsedReport} />
            </ResizablePanel>
        </ResizablePanelGroup>
    );
};


export const ReportViewSkeleton = () => {
  return (
    <div className="h-full w-full animate-pulse p-6 space-y-6">
      <div className="flex justify-between items-center"><Skeleton className="h-10 w-48" /><Skeleton className="h-10 w-48" /></div>
      <Skeleton className="h-24 w-full" />
      <div className="grid md:grid-cols-2 gap-6">
        <Skeleton className="h-64 w-full" />
        <Skeleton className="h-64 w-full" />
      </div>
      <Skeleton className="h-10 w-64" />
      <Skeleton className="h-80 w-full" />
    </div>
  );
};-e 
-e

File: web/src/components/global/DemoReportCard.tsx
"use client";

import Link from "next/link";
import { Card, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { ArrowRight, FileText, Sparkles, X } from "lucide-react";
import { Report } from "@/types/report";
import Logo from "./Logo";

interface DemoReportCardProps {
  report: Report;
  onDismiss: () => void;
}

export const DemoReportCard = ({ report, onDismiss }: DemoReportCardProps) => {
  return (
    // MODIFIED: Changed max-width to create a "tall" rectangle
    <div className="w-full max-w-sm">
      <Card className="relative overflow-hidden border-primary/20 bg-card shadow-2xl">
        <div className="absolute -top-1/2 -right-1/4 h-full w-1/2 bg-primary/5 rounded-full blur-3xl -z-10" />
        <CardHeader>
            <div className="flex items-start justify-between">
                <div>
                    <CardTitle className="flex items-center gap-2">
                        <Logo className="h-5 w-5 text-primary" />
                        Your First Analysis is Ready
                    </CardTitle>
                    <CardDescription className="mt-1">
                        We've prepared a demo report to showcase Alloy's capabilities.
                    </CardDescription>
                </div>
                <Button variant="ghost" size="icon" className="h-7 w-7 flex-shrink-0" onClick={onDismiss}>
                    <X className="h-4 w-4" />
                </Button>
            </div>
        </CardHeader>
        {/* MODIFIED: Changed to a vertical flex layout */}
        <div className="flex flex-col items-start gap-4 p-6 pt-0">
             <div className="flex items-center gap-3 text-sm font-medium">
                <FileText className="h-5 w-5 text-primary/80"/>
                <span className="text-foreground">{report.title}</span>
            </div>
            <div className="w-full flex justify-end">
                <Button asChild>
                    <Link href={`/dashboard/reports/${report.id}`}>
                        View Report <ArrowRight className="ml-2 h-4 w-4" />
                    </Link>
                </Button>
            </div>
        </div>
      </Card>
    </div>
  );
};-e 
-e

File: web/src/components/global/Hero.tsx
import React, { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import Link from 'next/link';
import Logo from './Logo';
import { BarChart, AlertTriangle, Zap, BrainCircuit, ShieldCheck, Code2 } from 'lucide-react';
import { LinesPatternCard, LinesPatternCardBody } from './LinesPatternCard';


// Helper component for glowing feature tags
interface FeatureItemProps {
  name: string;
  value: string;
  position: string;
}

const FeatureItem: React.FC<FeatureItemProps> = ({ name, value, position }) => {
  return (
    <div className={`absolute ${position} z-10 group transition-all duration-300 hover:scale-110`}>
      <div className="flex items-center gap-2 relative">
        <div className="relative">
          <div className="w-2 h-2 bg-white rounded-full group-hover:animate-pulse"></div>
          <div className="absolute -inset-1 bg-white/30 rounded-full blur-sm opacity-70 group-hover:opacity-100 transition-opacity duration-300"></div>
        </div>
        <div className="text-white relative">
          <div className="font-medium group-hover:text-white transition-colors duration-300">{name}</div>
          <div className="text-white/70 text-sm group-hover:text-white/80 transition-colors duration-300">{value}</div>
          <div className="absolute -inset-2 bg-white/10 rounded-lg blur-md opacity-70 group-hover:opacity-100 transition-opacity duration-300 -z-10"></div>
        </div>
      </div>
    </div>
  );
};

// The WebGL Lightning component (unchanged internally)
interface LightningProps {
  hue?: number;
  xOffset?: number;
  speed?: number;
  intensity?: number;
  size?: number;
}

const Lightning: React.FC<LightningProps> = ({
  hue = 230,
  xOffset = 0,
  speed = 1,
  intensity = 1,
  size = 1,
}) => {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    let animationFrameId: number;
    const resizeCanvas = () => {
      if (!canvas) return;
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    };
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    const gl = canvas.getContext("webgl");
    if (!gl) {
      console.error("WebGL not supported");
      return;
    }

    const vertexShaderSource = `
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `;

    const fragmentShaderSource = `
      precision mediump float;
      uniform vec2 iResolution;
      uniform float iTime;
      uniform float uHue;
      uniform float uXOffset;
      uniform float uSpeed;
      uniform float uIntensity;
      uniform float uSize;
      
      #define OCTAVE_COUNT 10

      vec3 hsv2rgb(vec3 c) {
          vec3 rgb = clamp(abs(mod(c.x * 6.0 + vec3(0.0,4.0,2.0), 6.0) - 3.0) - 1.0, 0.0, 1.0);
          return c.z * mix(vec3(1.0), rgb, c.y);
      }

      float hash11(float p) {
          p = fract(p * .1031);
          p *= p + 33.33;
          p *= p + p;
          return fract(p);
      }

      float hash12(vec2 p) {
          vec3 p3 = fract(vec3(p.xyx) * .1031);
          p3 += dot(p3, p3.yzx + 33.33);
          return fract((p3.x + p3.y) * p3.z);
      }

      mat2 rotate2d(float theta) {
          float c = cos(theta);
          float s = sin(theta);
          return mat2(c, -s, s, c);
      }

      float noise(vec2 p) {
          vec2 ip = floor(p);
          vec2 fp = fract(p);
          float a = hash12(ip);
          float b = hash12(ip + vec2(1.0, 0.0));
          float c = hash12(ip + vec2(0.0, 1.0));
          float d = hash12(ip + vec2(1.0, 1.0));
          
          vec2 t = smoothstep(0.0, 1.0, fp);
          return mix(mix(a, b, t.x), mix(c, d, t.x), t.y);
      }

      float fbm(vec2 p) {
          float value = 0.0;
          float amplitude = 0.5;
          for (int i = 0; i < OCTAVE_COUNT; ++i) {
              value += amplitude * noise(p);
              p *= rotate2d(0.45);
              p *= 2.0;
              amplitude *= 0.5;
          }
          return value;
      }

      void mainImage( out vec4 fragColor, in vec2 fragCoord ) {
          vec2 uv = fragCoord / iResolution.xy;
          uv = 2.0 * uv - 1.0;
          uv.x *= iResolution.x / iResolution.y;
          uv.x += uXOffset;
          
          uv += 2.0 * fbm(uv * uSize + 0.8 * iTime * uSpeed) - 1.0;
          
          float dist = abs(uv.x);
          vec3 baseColor = hsv2rgb(vec3(uHue / 360.0, 0.7, 0.8));
          vec3 col = baseColor * pow(mix(0.0, 0.07, hash11(iTime * uSpeed)) / dist, 1.0) * uIntensity;
          col = pow(col, vec3(1.0));
          fragColor = vec4(col, 1.0);
      }

      void main() {
          mainImage(gl_FragColor, gl_FragCoord.xy);
      }
    `;

    const compileShader = (source: string, type: number): WebGLShader | null => {
      const shader = gl.createShader(type);
      if (!shader) return null;
      gl.shaderSource(shader, source);
      gl.compileShader(shader);
      if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
        console.error("Shader compile error:", gl.getShaderInfoLog(shader));
        gl.deleteShader(shader);
        return null;
      }
      return shader;
    };

    const vertexShader = compileShader(vertexShaderSource, gl.VERTEX_SHADER);
    const fragmentShader = compileShader(fragmentShaderSource, gl.FRAGMENT_SHADER);
    if (!vertexShader || !fragmentShader) return;

    const program = gl.createProgram();
    if (!program) return;
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    gl.linkProgram(program);
    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
      console.error("Program linking error:", gl.getProgramInfoLog(program));
      return;
    }
    gl.useProgram(program);

    const vertices = new Float32Array([-1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1]);
    const vertexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

    const aPosition = gl.getAttribLocation(program, "aPosition");
    gl.enableVertexAttribArray(aPosition);
    gl.vertexAttribPointer(aPosition, 2, gl.FLOAT, false, 0, 0);

    const iResolutionLocation = gl.getUniformLocation(program, "iResolution");
    const iTimeLocation = gl.getUniformLocation(program, "iTime");
    const uHueLocation = gl.getUniformLocation(program, "uHue");
    const uXOffsetLocation = gl.getUniformLocation(program, "uXOffset");
    const uSpeedLocation = gl.getUniformLocation(program, "uSpeed");
    const uIntensityLocation = gl.getUniformLocation(program, "uIntensity");
    const uSizeLocation = gl.getUniformLocation(program, "uSize");

    const startTime = performance.now();
    const render = () => {
      if (!canvasRef.current) return;
      resizeCanvas();
      gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
      gl.uniform2f(iResolutionLocation, gl.canvas.width, gl.canvas.height);
      const currentTime = performance.now();
      gl.uniform1f(iTimeLocation, (currentTime - startTime) / 1000.0);
      gl.uniform1f(uHueLocation, hue);
      gl.uniform1f(uXOffsetLocation, xOffset);
      gl.uniform1f(uSpeedLocation, speed);
      gl.uniform1f(uIntensityLocation, intensity);
      gl.uniform1f(uSizeLocation, size);
      gl.drawArrays(gl.TRIANGLES, 0, 6);
      animationFrameId = requestAnimationFrame(render);
    };
    render();

    return () => {
      window.removeEventListener("resize", resizeCanvas);
      cancelAnimationFrame(animationFrameId);
    };
  }, [hue, xOffset, speed, intensity, size]);

  return <canvas ref={canvasRef} className="w-full h-full relative" />;
};

const featureList = [
  {
    icon: BarChart,
    title: 'Data-Driven Compatibility Score',
    description: 'Go beyond financials. Our core metric quantifies cultural alignment by analyzing millions of taste-based data points from Qloo\'s AI.',
  },
  {
    icon: AlertTriangle,
    title: 'Culture Clash Identification',
    description: 'Proactively identify potential integration risks. We highlight areas of stark cultural divergence between brand audiences before they become post-merger problems.',
  },
  {
    icon: Zap,
    title: 'Untapped Growth Discovery',
    description: 'Uncover hidden synergies. Alloy pinpoints shared cultural passions, revealing immediate opportunities for joint marketing, product bundling, and cross-promotion.',
  },
  {
    icon: BrainCircuit,
    title: 'AI-Powered Brand Archetyping',
    description: 'Understand the "why" behind the data. Gemini generates a deep, qualitative summary of each brand\'s persona and values based on their cultural DNA.',
  },
  {
    icon: ShieldCheck,
    title: 'Secure & Confidential Analysis',
    description: 'Your strategic analysis is sensitive. Our platform ensures end-to-end security, with robust authentication and data handling for peace of mind.',
  },
  {
    icon: Code2,
    title: 'API-First for Seamless Integration',
    description: 'Built for power users. Integrate Alloy\'s cultural intelligence directly into your existing M&A workflows and proprietary models with our robust API.',
  },
];


export const FeaturesSection = () => (
  <section className="bg-black py-20 sm:py-32">
    <div className="mx-auto max-w-7xl px-6 lg:px-8">
      <div className="mx-auto max-w-2xl lg:text-center">
        <h2 className="text-base font-semibold leading-7 text-blue-400">The Alloy Advantage</h2>
        <p className="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">
          De-Risk Deals with Precision Intelligence
        </p>
        <p className="mt-6 text-lg leading-8 text-gray-300">
          Alloy provides a multi-faceted view of cultural compatibility, transforming a traditionally qualitative and high-risk variable into a quantifiable asset.
        </p>
      </div>
      <div className="mx-auto mt-16 max-w-2xl sm:mt-20 lg:mt-24 lg:max-w-none">
        <dl className="grid max-w-xl grid-cols-1 gap-8 lg:max-w-none lg:grid-cols-3">
          {featureList.map((feature) => (
            <LinesPatternCard 
              key={feature.title} 
              className="flex flex-col bg-neutral-950 border-white/10"
              gradientClassName="from-neutral-950/90 via-neutral-950/40 to-neutral-950/10"
            >
              <LinesPatternCardBody>
                <dt className="flex items-center gap-x-3 text-base font-semibold leading-7 text-white">
                  <feature.icon className="h-5 w-5 flex-none text-blue-400" aria-hidden="true" />
                  {feature.title}
                </dt>
                <dd className="mt-4 flex flex-auto flex-col text-base leading-7 text-gray-300">
                  <p className="flex-auto">{feature.description}</p>
                </dd>
              </LinesPatternCardBody>
            </LinesPatternCard>
          ))}
        </dl>
      </div>
    </div>
  </section>
);


// The main Alloy Hero Component
export const AlloyHeroSection: React.FC = () => {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.2,
        delayChildren: 0.1
      }
    }
  };

  const itemVariants = {
    hidden: { y: 20, opacity: 0 },
    visible: {
      y: 0,
      opacity: 1,
      transition: {
        duration: 0.5,
        ease: "easeOut"
      }
    }
  };

  return (
    <div className="relative w-full min-h-screen bg-black text-white overflow-hidden">
      <div className="relative z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 h-full flex flex-col">
        {/* Navigation */}
        <motion.nav
          initial={{ y: -20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="px-4 backdrop-blur-3xl bg-black/50 rounded-full py-3 flex justify-between items-center"
        >
          <Logo hideText={false} className="text-white"/>
          <div className="flex items-center space-x-4">
            <Link href="/login">
              <button className="hidden md:block px-4 py-2 text-sm text-gray-300 hover:text-white transition-colors">Log In</button>
            </Link>
            <Link href="/login">
              <button className="px-4 py-2 bg-white/10 backdrop-blur-sm rounded-full text-sm hover:bg-white/20 transition-colors">De-Risk Your Deal</button>
            </Link>
            <button
              className="md:hidden p-2 rounded-md focus:outline-none"
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
            >
              {mobileMenuOpen ? (
                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
              ) : (
                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
              )}
            </button>
          </div>
        </motion.nav>

        {/* Mobile menu */}
        <AnimatePresence>
          {mobileMenuOpen && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="md:hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-lg">
              <div className="flex flex-col items-center justify-center h-full space-y-6 text-lg">
                <button className="absolute top-6 right-6 p-2" onClick={() => setMobileMenuOpen(false)}>
                  <svg className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <button className="px-6 py-3">Features</button>
                <button className="px-6 py-3">Pricing</button>
                <button className="px-6 py-3">Case Studies</button>
                <button className="px-6 py-3">Contact</button>
                <Link href="/login" className="px-6 py-3">
                  Log In
                </Link>
                <Link href="/login" className="px-6 py-3 bg-white/10 backdrop-blur-sm rounded-full">
                  De-Risk Your Deal
                </Link>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
        
        {/* Main hero content */}
        <div className="flex-grow flex flex-col items-center justify-center text-center">
          <motion.div
            variants={containerVariants}
            initial="hidden"
            animate="visible"
            className="relative z-30 flex flex-col items-center max-w-4xl mx-auto"
          >
            <motion.div
              //@ts-ignore
              variants={itemVariants}
              className="flex items-center space-x-2 px-4 py-2 mt-10 bg-white/5 hover:bg-white/10 backdrop-blur-sm rounded-full text-sm mb-6 transition-all duration-300 group"
            >
              <span>The New Paradigm of Cultural Due Diligence</span>
            </motion.div>

            <motion.h1
              //@ts-ignore
              variants={itemVariants}
              className="text-5xl md:text-7xl font-light mb-2 tracking-tighter"
            >
              Where Culture Meets Capital
            </motion.h1>

            <motion.h2
              //@ts-ignore
              variants={itemVariants}
              className="text-3xl md:text-5xl pb-3 font-light bg-gradient-to-r from-gray-200 via-gray-300 to-gray-400 bg-clip-text text-transparent"
            >
              Quantify Brand Compatibility
            </motion.h2>

            <motion.p
              //@ts-ignore
              variants={itemVariants}
              className="text-gray-400 mb-9 max-w-2xl mt-4"
            >
              Alloy is a financial-grade intelligence platform that de-risks multi-billion dollar acquisitions by replacing gut feeling with a data-driven Cultural Compatibility Score.
            </motion.p>

            <Link href="/login">
              <motion.button
                //@ts-ignore
              variants={itemVariants}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="px-8 py-3 bg-white text-black font-semibold rounded-full hover:bg-gray-200 transition-colors"
              >
                De-Risk Your Deal
              </motion.button>
            </Link>
          </motion.div>
        </div>
      </div>

      {/* Background elements */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 1.5 }}
        className="absolute inset-0 z-0"
      >
        <div className="absolute inset-0 bg-black/80"></div>
        <div className="absolute top-[55%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[900px] h-[900px] rounded-full bg-gradient-to-b from-blue-900/20 to-purple-900/10 blur-3xl"></div>
        
        {/* THE VISUAL METAPHOR: Two distinct data streams representing the two companies being analyzed */}
        <div className="absolute top-0 w-full left-1/2 transform -translate-x-1/2 h-full">
          {/* Stream 1: The Acquirer */}
          <Lightning
            hue={210} // A corporate blue
            xOffset={-0.5}
            speed={0.8}
            intensity={0.4}
            size={2.5}
          />
          {/* Stream 2: The Target */}
          <Lightning
            hue={280} // A different, more creative purple
            xOffset={0.5}
            speed={0.8}
            intensity={0.4}
            size={2.5}
          />
        </div>
      </motion.div>
    </div>
  );
};-e 
-e

File: web/src/components/global/LinesPatternCard.tsx
import { cn } from '@/lib/utils'
import { motion } from "framer-motion"

interface LinesPatternCardProps {
  children: React.ReactNode
  className?: string
  patternClassName?: string
  gradientClassName?: string
}

export function LinesPatternCard({ 
  children, 
  className,
  patternClassName,
  gradientClassName
}: LinesPatternCardProps) {
  return (
    <motion.div
      className={cn(
        "border w-full rounded-md overflow-hidden",
        "bg-background",
        "border-border",
        "p-3",
        className
      )}
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.8, ease: "easeOut" }}
    >
      <div className={cn(
        "size-full bg-repeat bg-[length:30px_30px]",
        "bg-lines-pattern-light dark:bg-lines-pattern",
        patternClassName
      )}>
        <div className={cn(
          "size-full bg-gradient-to-tr",
          "from-background/90 via-background/40 to-background/10",
          gradientClassName
        )}>
          {children}
        </div>
      </div>
    </motion.div>
  )
}

export function LinesPatternCardBody({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div 
      className={cn("text-left p-4 md:p-6", className)} 
      {...props} 
    />
  )
}-e 
-e

File: web/src/components/global/DashboardGreeting.tsx
"use client";

import { motion } from "framer-motion";
import { cn } from "@/lib/utils";

interface DashboardGreetingProps {
  isVisible: boolean;
}

const greetings = [
    { title: "Let's de-risk your next deal.", subtitle: "Enter the acquirer and target to begin your cultural analysis." },
   // { title: "Ready for analysis?", subtitle: "Quantify the cultural fit for your next M&A." },
];

// A simple hash function to pick a greeting based on the day
const getDailyGreeting = () => {
    const day = new Date().getDate();
    return greetings[day % greetings.length];
};

export const DashboardGreeting = ({ isVisible }: DashboardGreetingProps) => {
  const greeting = getDailyGreeting();

  return (
    <motion.div
      initial={{ opacity: 0, y: -10 }}
      animate={{ opacity: isVisible ? 1 : 0, y: isVisible ? 0 : -10 }}
      transition={{ duration: 0.5, ease: "easeInOut" }}
      className={cn("text-center mb-8", !isVisible && "pointer-events-none")}
    >
      <h1 className="text-3xl md:text-4xl font-semibold text-foreground tracking-tight">{greeting.title}</h1>
      <p className="mt-2 text-base text-muted-foreground">{greeting.subtitle}</p>
    </motion.div>
  );
};
-e 
-e

File: web/src/components/global/CommandPalette.tsx
"use client";

import React, { useCallback } from 'react';
import { useRouter } from 'next/navigation';
import {
  CommandDialog,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from "@/components/ui/command";
import { FileText, Home, Settings, Users } from 'lucide-react';

interface CommandPaletteProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

const navItems = [
  { href: "/dashboard", icon: Home, label: "Dashboard" },
  { href: "/dashboard/reports", icon: FileText, label: "My Reports" },
  { href: "/dashboard/team", icon: Users, label: "Team Members" },
  { href: "/dashboard/settings", icon: Settings, label: "Settings" },
];

export function CommandPalette({ open, onOpenChange }: CommandPaletteProps) {
  const router = useRouter();

  const runCommand = useCallback((command: () => unknown) => {
    onOpenChange(false);
    command();
  }, [onOpenChange]);

  return (
    <CommandDialog open={open} onOpenChange={onOpenChange}>
      <CommandInput placeholder="Type a command or search..." />
      <CommandList>
        <CommandEmpty>No results found.</CommandEmpty>
        <CommandGroup heading="Navigation">
          {navItems.map((item) => (
            <CommandItem
              key={item.href}
              onSelect={() => runCommand(() => router.push(item.href))}
            >
              <item.icon className="mr-2 h-4 w-4" />
              <span>{item.label}</span>
            </CommandItem>
          ))}
        </CommandGroup>
      </CommandList>
    </CommandDialog>
  );
}   -e 
-e

File: web/src/components/global/Breadcrumbs.tsx
"use client";

import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { ChevronRightIcon, HomeIcon } from 'lucide-react';
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb';

export const DynamicBreadcrumb = () => {
  const pathname = usePathname();
  const pathSegments = pathname.split('/').filter(segment => segment);

  // Capitalize first letter of a string
  const capitalize = (s: string) => s.charAt(0).toUpperCase() + s.slice(1);

  return (
    <Breadcrumb>
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink asChild>
            <Link href="/dashboard" className="flex items-center gap-1">
              <HomeIcon className="h-4 w-4" />
              <span className="sr-only">Home</span>
            </Link>
          </BreadcrumbLink>
        </BreadcrumbItem>
        {pathSegments.map((segment, index) => {
          const href = `/${pathSegments.slice(0, index + 1).join('/')}`;
          const isLast = index === pathSegments.length - 1;
          const decodedSegment = capitalize(decodeURIComponent(segment));

          // Don't show "Dashboard" as it's represented by the Home icon
          if (decodedSegment.toLowerCase() === 'dashboard') {
            return null;
          }

          return (
            <React.Fragment key={href}>
              <BreadcrumbSeparator>
                <ChevronRightIcon />
              </BreadcrumbSeparator>
              <BreadcrumbItem>
                {isLast ? (
                  <BreadcrumbPage>{decodedSegment}</BreadcrumbPage>
                ) : (
                  <BreadcrumbLink asChild>
                    <Link href={href}>{decodedSegment}</Link>
                  </BreadcrumbLink>
                )}
              </BreadcrumbItem>
            </React.Fragment>
          );
        })}
      </BreadcrumbList>
    </Breadcrumb>
  );
};-e 
-e

File: web/src/components/global/PromptInputBox.tsx
"use client";

import React, { useState, useRef, useEffect } from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";
import { ArrowUp, Paperclip, X, Search, Bot, Database, BrainCircuit, CheckCircle, AlertTriangle, Link as LinkIcon, Sparkles, Loader2, Microscope, MessageSquareQuote, Zap, TrendingUp } from "lucide-react";
import { cn } from "@/lib/utils";
import { Button } from "../ui/button";
import { Input } from "../ui/input";
import { Textarea } from "../ui/textarea";
import { toast } from "sonner";
import { useAuth } from "./providers";
import useSWRMutation from 'swr/mutation';
import { motion, AnimatePresence } from "framer-motion";
import { ScrollArea } from "../ui/scroll-area";
import { Switch } from "../ui/switch";
import { Label } from "../ui/label";
import Image from "next/image";
import Link from "next/link";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "../ui/collapsible";
import { Separator } from "../ui/separator";

// API MUTATION
const createDraftReport = async (url: string, { arg }: { arg: { token: string }}) => {
    const res = await fetch(url, { method: 'POST', headers: { 'Authorization': `Bearer ${arg.token}` } });
    if (!res.ok) throw new Error('Failed to create draft session.');
    return res.json();
}

// TYPES
interface Step {
  id: string;
  status: 'info' | 'search' | 'source' | 'analysis' | 'reasoning' | 'synthesis' | 'saving' | 'complete' | 'error' | 'qloo_insight';
  message?: string;
  payload?: any;
}

interface UploadedFileStatus {
    id: string;
    name: string;
    status: 'uploading' | 'success' | 'error';
    message?: string;
}

interface QlooInsights {
    shared: string[];
    acquirer_unique: string[];
    target_unique: string[];
}

interface PromptInputBoxProps {
  onReportCreated: () => void;
  onPristineChange: (isPristine: boolean) => void;
  className?: string;
}

// --- CHILD COMPONENTS ---

const TooltipProvider = TooltipPrimitive.Provider;
const Tooltip = TooltipPrimitive.Root;
const TooltipTrigger = TooltipPrimitive.Trigger;
const TooltipContent = React.forwardRef<React.ElementRef<typeof TooltipPrimitive.Content>, React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content ref={ref} sideOffset={sideOffset} className={cn("z-50 overflow-hidden rounded-md border border-border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0", className)} {...props} />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

const QlooInsightsPanel = ({ insights, acquirer, target }: { insights: QlooInsights, acquirer: string, target: string }) => (
    <motion.div
        layout
        initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }}
        className="p-4 my-3 rounded-lg border bg-accent/50"
    >
        <h3 className="font-semibold text-sm mb-3 text-foreground flex items-center gap-2"><Sparkles className="h-4 w-4 text-purple-400" />Qloo Cultural Insights</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <h4 className="font-medium text-xs text-muted-foreground flex items-center gap-1.5 mb-2"><TrendingUp className="h-3 w-3 text-green-500" />Shared Affinities</h4>
                <div className="space-y-1">{insights.shared.map(item => <p key={item} className="text-xs text-foreground truncate" title={item}>{item}</p>)}</div>
            </div>
            <div className="md:border-l md:pl-4">
                <h4 className="font-medium text-xs text-muted-foreground mb-2">{acquirer} Unique Tastes</h4>
                <div className="space-y-1">{insights.acquirer_unique.map(item => <p key={item} className="text-xs text-foreground truncate" title={item}>{item}</p>)}</div>
            </div>
             <div className="md:border-l md:pl-4">
                <h4 className="font-medium text-xs text-muted-foreground mb-2">{target} Unique Tastes</h4>
                <div className="space-y-1">{insights.target_unique.map(item => <p key={item} className="text-xs text-foreground truncate" title={item}>{item}</p>)}</div>
            </div>
        </div>
    </motion.div>
);


const SourceItem = ({ source }: { source: { url: string, title?: string }}) => {
    const domain = new URL(source.url).hostname?.replace('www.', '');
    const { apiUrl } = useAuth();
    const faviconUrl = `${apiUrl}/api/v1/utils/favicon?url=${encodeURIComponent(source.url)}`;
    return (
        <Link href={source.url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 group">
            <Image src={faviconUrl} alt="source favicon" width={16} height={16} className="rounded-full" unoptimized/>
            <span className="truncate group-hover:underline text-blue-600 dark:text-blue-400">{source.title || source.url}</span>
        </Link>
    );
};

const FaviconPreview = ({ url }: { url: string }) => {
    const { apiUrl } = useAuth();
    const faviconUrl = `${apiUrl}/api/v1/utils/favicon?url=${encodeURIComponent(url)}`;
    return <Image src={faviconUrl} alt="favicon" width={16} height={16} className="rounded-full" unoptimized/>;
}

const StepItem = ({ step }: { step: Step }) => {
    const ICONS = {
        info: <Bot className="h-4 w-4 text-primary" />,
        search: <Search className="h-4 w-4 text-blue-500" />,
        source: <LinkIcon className="h-4 w-4 text-muted-foreground" />,
        analysis: <Microscope className="h-4 w-4 text-purple-500" />,
        reasoning: <MessageSquareQuote className="h-4 w-4 text-gray-500" />,
        synthesis: <BrainCircuit className="h-4 w-4 text-amber-500" />,
        saving: <Database className="h-4 w-4 text-green-500" />,
        complete: <CheckCircle className="h-4 w-4 text-green-500" />,
        error: <AlertTriangle className="h-4 w-4 text-destructive" />,
        qloo_insight: <Sparkles className="h-4 w-4 text-purple-400"/>
    };

    const renderContent = () => {
        if (step.status === 'source' && step.payload) {
            return <SourceItem source={step.payload} />;
        }
        return step.message;
    };

    return (
        <motion.div layout initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} transition={{ duration: 0.3 }} className="flex items-start gap-3 text-sm">
            <div className="flex-shrink-0 mt-0.5">{ICONS[step.status] || <Sparkles className="h-4 w-4" />}</div>
            <div className={cn("flex-grow", 
                step.status === 'error' && "text-destructive font-medium",
                step.status === 'reasoning' && "text-muted-foreground italic"
            )}>{renderContent()}</div>
        </motion.div>
    );
};

// --- MAIN COMPONENT ---
export const PromptInputBox = React.forwardRef<HTMLDivElement, PromptInputBoxProps>(
  ({ onReportCreated, onPristineChange, className }, ref) => {
    const { accessToken, apiUrl } = useAuth();
    const API_URL = apiUrl;

    const [draftReportId, setDraftReportId] = useState<string | null>(null);
    const [acquirer, setAcquirer] = useState("");
    const [target, setTarget] = useState("");
    const [notes, setNotes] = useState("");
    const [uploadedFile, setUploadedFile] = useState<UploadedFileStatus | null>(null);
    const [useGrounding, setUseGrounding] = useState(false);
    
    const [logSteps, setLogSteps] = useState<Step[]>([]);
    const [sources, setSources] = useState<Step[]>([]);
    const [qlooInsights, setQlooInsights] = useState<QlooInsights | null>(null);
    const [isGenerating, setIsGenerating] = useState(false);
    const [isCollapsibleOpen, setIsCollapsibleOpen] = useState(true);

    const fileInputRef = useRef<HTMLInputElement>(null);
    const scrollAreaRef = useRef<HTMLDivElement>(null);

    const { trigger: triggerDraft, isMutating: isCreatingDraft } = useSWRMutation(`${API_URL}/api/v1/reports/draft`, createDraftReport);
    const isLoading = isCreatingDraft || isGenerating || uploadedFile?.status === 'uploading';

    useEffect(() => {
        if (accessToken && !draftReportId && !isGenerating) {
            triggerDraft({ token: accessToken })
                .then(data => setDraftReportId(data.id))
                .catch(() => toast.error("Could not start a new session.", { description: "Please refresh the page." }));
        }
    }, [accessToken, draftReportId, triggerDraft, isGenerating]);
    
    useEffect(() => { onPristineChange(!acquirer && !target && !notes && !uploadedFile); }, [acquirer, target, notes, uploadedFile, onPristineChange]);
    useEffect(() => { if (scrollAreaRef.current) scrollAreaRef.current.scrollTo({ top: scrollAreaRef.current.scrollHeight, behavior: 'smooth' }); }, [logSteps, sources, qlooInsights]);

    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file || !draftReportId) return;
        const fileId = `${file.name}-${Date.now()}`;
        setUploadedFile({ id: fileId, name: file.name, status: 'uploading' });
        const formData = new FormData();
        formData.append('file', file);
        try {
            const res = await fetch(`${API_URL}/api/v1/reports/${draftReportId}/upload_context_file`, { method: 'POST', headers: { 'Authorization': `Bearer ${accessToken!}` }, body: formData });
            if (!res.ok) { const errorData = await res.json(); throw new Error(errorData.detail || 'File upload failed'); }
            setUploadedFile({ id: fileId, name: file.name, status: 'success', message: 'Context uploaded' });
            toast.success("Context file uploaded successfully.");
        } catch (error: any) {
            setUploadedFile({ id: fileId, name: file.name, status: 'error', message: error.message });
            toast.error("File Upload Failed", { description: error.message });
        }
    };

    const handleSubmit = async () => {
        if (isLoading || !draftReportId || acquirer.trim().length < 2 || target.trim().length < 2) {
             toast.error("Invalid Input", { description: "Please provide full, official brand names."});
            return;
        }
        setIsGenerating(true); setLogSteps([]); setSources([]); setQlooInsights(null); setIsCollapsibleOpen(true);
        
        try {
            const response = await fetch(`${API_URL}/api/v1/reports/${draftReportId}/generate`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken!}` },
                body: JSON.stringify({ acquirer_brand: acquirer, target_brand: target, title: `${acquirer} vs. ${target}`, context: notes, use_grounding: useGrounding })
            });
            if (!response.ok || !response.body) { throw new Error(response.statusText || "Server response was invalid."); }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedChunks = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                accumulatedChunks += decoder.decode(value, { stream: true });
                const lines = accumulatedChunks.split('\n\n');
                accumulatedChunks = lines.pop() || "";

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonData = JSON.parse(line.substring(6));
                        const newStep: Step = { id: `step-${Date.now()}-${Math.random()}`, ...jsonData };
                        
                        if (newStep.status === 'source') { 
                            setSources(prev => [...prev, newStep]); 
                        } else if (newStep.status === 'qloo_insight') {
                            setQlooInsights(newStep.payload);
                            setLogSteps(prev => [...prev, { ...newStep, message: "Qloo analysis complete." }]);
                        } else { 
                            setLogSteps(prev => [...prev, newStep]); 
                        }
                        
                        if (newStep.status === 'complete') {
                            toast.success("Report generated successfully!");
                            onReportCreated();
                            setTimeout(() => handleReset(false), 1000);
                            return;
                        }
                        if (newStep.status === 'error') {
                            toast.error("Generation Failed", { description: newStep.message });
                            handleReset();
                            return;
                        }
                    }
                }
            }
        } catch (err: any) { toast.error("An error occurred", { description: err.message }); setIsGenerating(false); }
    };
    
    const handleReset = (resetId = true) => {
        setIsGenerating(false); setLogSteps([]); setSources([]); setQlooInsights(null);
        setAcquirer(""); setTarget(""); setNotes(""); setUploadedFile(null);
        if (resetId) setDraftReportId(null);
    }

    const canSubmit = acquirer.trim().length > 1 && target.trim().length > 1 && uploadedFile?.status !== 'uploading';

    if (isGenerating) {
        return <div ref={ref} className={cn("w-full max-w-3xl mx-auto", className)}>
            <motion.div layout className="relative w-full rounded-2xl border border-border bg-card shadow-xl transition-all">
                <div className="p-4"><h3 className="font-semibold text-center text-foreground">Generating Report...</h3><p className="text-center text-sm text-muted-foreground">{acquirer} vs. {target}</p></div>
                <ScrollArea className="h-[30rem] max-h-[60vh] px-4" ref={scrollAreaRef}>
                    <div className="space-y-3 py-4">
                        <AnimatePresence>{logSteps.map((step) => <StepItem key={step.id} step={step} />)}</AnimatePresence>
                        {qlooInsights && <QlooInsightsPanel insights={qlooInsights} acquirer={acquirer} target={target} />}
                        {sources.length > 0 && <Collapsible open={isCollapsibleOpen} onOpenChange={setIsCollapsibleOpen}>
                            <CollapsibleTrigger className="w-full p-2 rounded-md hover:bg-muted/50 text-left">
                                <div className="flex items-center justify-between"><div className="flex items-center gap-2 overflow-hidden"><Search className="h-4 w-4 text-blue-500 flex-shrink-0"/><span className="text-sm font-medium">Found {sources.length} sources</span>
                                <div className="flex items-center -space-x-1 flex-shrink min-w-0">
                                    {sources.map(source => (
                                        <div key={source.id} className="relative flex h-4 w-4 items-center justify-center rounded-full ring-2 ring-background">
                                            <FaviconPreview url={source.payload.url}/>
                                        </div>
                                    ))}
                                </div>
                                </div><span className="text-xs text-muted-foreground">{isCollapsibleOpen ? 'Collapse' : 'Expand'}</span></div>
                            </CollapsibleTrigger>
                            <CollapsibleContent className="space-y-3 pt-2">{sources.map(source => <StepItem key={source.id} step={source} />)}</CollapsibleContent>
                        </Collapsible>}
                    </div>
                </ScrollArea>
                <div className="flex items-center justify-end p-2 border-t border-border"><Button onClick={() => handleReset(true)}>Create New Report</Button></div>
            </motion.div>
        </div>
    }

    return (
        <div ref={ref} className={cn("w-full max-w-3xl mx-auto", className)}>
            <motion.div layout className="relative w-full rounded-2xl border border-border bg-card shadow-xl transition-all">
              <div className="p-4 space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <Input placeholder="Acquirer (e.g., The Walt Disney Company)" value={acquirer} onChange={(e) => setAcquirer(e.target.value)} className="h-10 bg-background" disabled={isLoading} />
                  <Input placeholder="Target (e.g., A24 Films)" value={target} onChange={(e) => setTarget(e.target.value)} className="h-10 bg-background" disabled={isLoading} />
                </div>
                <Textarea placeholder="Add optional notes or a specific query for the AI..." value={notes} onChange={(e) => setNotes(e.target.value)} className="bg-background min-h-[40px] max-h-48" rows={1} disabled={isLoading} />
                 {uploadedFile && <motion.div layout initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex items-center justify-between rounded-lg bg-background p-2">
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                        {uploadedFile.status === 'uploading' && <Loader2 className="h-4 w-4 animate-spin" />}
                        {uploadedFile.status === 'success' && <CheckCircle className="h-4 w-4 text-green-500" />}
                        {uploadedFile.status === 'error' && <AlertTriangle className="h-4 w-4 text-destructive" />}
                        <span className="truncate">{uploadedFile.name}</span>
                    </div>
                    <Button variant="ghost" size="icon" className="h-6 w-6 rounded-full" onClick={() => setUploadedFile(null)}><X className="h-4 w-4" /></Button>
                </motion.div>}
              </div>
              <div className="flex items-center justify-between p-2 border-t border-border">
                <div className="flex items-center gap-1">
                    <TooltipProvider delayDuration={100}>
                        <Tooltip>
                            <TooltipTrigger asChild><Button size="icon" variant="ghost" className="h-8 w-8 text-muted-foreground" onClick={() => fileInputRef.current?.click()} disabled={isLoading}><Paperclip className="h-4 w-4" /></Button></TooltipTrigger>
                            <TooltipContent side="top">Attach Context (.pdf, .xlsx, .txt, .md)</TooltipContent>
                        </Tooltip>
                         <Tooltip>
                            <TooltipTrigger asChild><div className="flex items-center space-x-2 p-2"><Switch id="grounding-switch" checked={useGrounding} onCheckedChange={setUseGrounding} disabled={isLoading} /><Label htmlFor="grounding-switch" className="text-xs text-muted-foreground">Grounding</Label></div></TooltipTrigger>
                            <TooltipContent side="top">Use live web search to enrich analysis</TooltipContent>
                        </Tooltip>
                    </TooltipProvider>
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".pdf,.xlsx,.xls,.txt,.md" className="hidden" disabled={!draftReportId || !!uploadedFile}/>
                </div>
                <Button onClick={handleSubmit} disabled={isLoading || !canSubmit}>
                    {isLoading ? "Processing..." : "Generate Report"}
                    <ArrowUp className="ml-2 h-4 w-4" />
                </Button>
              </div>
            </motion.div>
            <p className="text-center text-xs text-muted-foreground mt-3 px-4">
                Please use full, official brand names for best results. Data provided by Qloo, the AI for culture and taste.
            </p>
        </div>
    );
});
PromptInputBox.displayName = "PromptInputBox";-e 
-e

File: web/src/components/global/Footer.tsx
"use client";
import React, { useEffect, useRef, useState } from "react";
import Logo from "./Logo";

interface LinkItem {
  href: string;
  label: string;
}

interface FooterProps {
  leftLinks: LinkItem[];
  rightLinks: LinkItem[];
  copyrightText: string;
  problemStatement: string;
  solutionStatement: string;
  barCount?: number;
}

const Footer: React.FC<FooterProps> = ({
  leftLinks,
  rightLinks,
  copyrightText,
  problemStatement,
  solutionStatement,
  barCount = 23,
}) => {
  const waveRefs = useRef<(HTMLDivElement | null)[]>([]);
  const footerRef = useRef<HTMLDivElement | null>(null);
  const [isVisible, setIsVisible] = useState(false);
  const animationFrameRef = useRef<number | null>(null);

  const handleBackToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  };

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        setIsVisible(entry.isIntersecting);
      },
      { threshold: 0.1 },
    );

    if (footerRef.current) {
      observer.observe(footerRef.current);
    }

    return () => {
      if (footerRef.current) {
        observer.unobserve(footerRef.current);
      }
      if (animationFrameRef.current) {
        cancelAnimationFrame(animationFrameRef.current);
      }
    };
  }, []);

  useEffect(() => {
    let t = 0;

    const animateWave = () => {
      const waveElements = waveRefs.current;
      let offset = 0;

      waveElements.forEach((element, index) => {
        if (element) {
          offset += Math.max(0, 20 * Math.sin((t + index) * 0.3));
          element.style.transform = `translateY(${index + offset}px)`;
        }
      });

      t += 0.1;
      animationFrameRef.current = requestAnimationFrame(animateWave);
    };

    if (isVisible) {
      animateWave();
    } else if (animationFrameRef.current) {
      cancelAnimationFrame(animationFrameRef.current);
      animationFrameRef.current = null;
    }

    return () => {
      if (animationFrameRef.current) {
        cancelAnimationFrame(animationFrameRef.current);
        animationFrameRef.current = null;
      }
    };
  }, [isVisible]);

  return (
    <footer
      ref={footerRef}
      className="bg-black text-white relative flex flex-col w-full h-full justify-between lg:h-screen select-none"
    >
      <div className="container mx-auto flex flex-col md:flex-row justify-between w-full gap-8 pb-24 pt-16 px-4">
        {/* Left Side */}
        <div className="flex flex-col gap-8 max-w-md">
          <div>
            <h3 className="font-semibold text-lg mb-2">The Problem</h3>
            <p className="text-sm text-gray-400">{problemStatement}</p>
          </div>
          <div>
            <h3 className="font-semibold text-lg mb-2 text-sky-400">The Solution</h3>
            <p className="text-sm text-gray-300">{solutionStatement}</p>
          </div>
          <div className="mt-4">
            <div className="text-sm flex items-center gap-x-1.5">
              <Logo />
              {copyrightText}
            </div>
          </div>
        </div>
        {/* Right Side */}
        <div className="flex flex-col justify-between items-start md:items-end">
          <div className="space-y-4 text-left md:text-right">
             <h3 className="font-semibold text-lg">Features</h3>
            <ul className="flex flex-col items-start md:items-end gap-2">
              {leftLinks.map((link, index) => (
                <li key={index}>
                  <a href={link.href} className="text-sm text-gray-300 hover:text-sky-400">
                    {link.label}
                  </a>
                </li>
              ))}
            </ul>
             <h3 className="font-semibold text-lg mt-4">Company</h3>
            <ul className="flex flex-col items-start md:items-end gap-2">
              {rightLinks.map((link, index) => (
                <li key={index}>
                  <a href={link.href} className="text-sm text-gray-300 hover:text-sky-400" target="_blank" rel="noopener noreferrer">
                    {link.label}
                  </a>
                </li>
              ))}
            </ul>
          </div>
          <button onClick={handleBackToTop} className="text-sm hover:underline mt-8 md:mt-0">
            Back to top 
          </button>
        </div>
      </div>

      <div
        id="waveContainer"
        aria-hidden="true"
        style={{ overflow: "hidden", height: 200 }}
      >
        <div style={{ marginTop: 0 }}>
          {Array.from({ length: barCount }).map((_, index) => (
            <div
              key={index}
              ref={(el) => {
                waveRefs.current[index] = el;
              }}
              className="wave-segment"
              style={{
                height: `${index + 1}px`,
                backgroundColor: "rgb(255, 255, 255)",
                transition: "transform 0.1s ease",
                willChange: "transform",
                marginTop: "-2px",
              }}
            />
          ))}
        </div>
      </div>
    </footer>
  );
};

export default Footer;-e 
-e

File: web/src/components/global/Logo.tsx
"use client";

import React from "react";
import Link from "next/link";
import { Playfair_Display } from "next/font/google";
import { cn } from "@/lib/utils";
import { usePathname } from "next/navigation";

const playfair = Playfair_Display({
  subsets: ["latin"],
  weight: "700",
});

interface LogoProps {
  className?: string;
  hideText?: boolean;
}

export const Logo: React.FC<LogoProps> = ({ className, hideText = true }) => {
  const pathname = usePathname();

  return (
    <Link
      href={pathname.startsWith("/dashboard") ? "/dashboard" : "/"}
      className={cn(
        "group flex items-center gap-2.5 transition-opacity duration-300 hover:opacity-80",
        className,
      )}
      aria-label="Alloy Homepage"
    >
      <div className="h-7 w-7">
        <svg
          viewBox="0 0 40 40"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          className="h-full w-full transition-transform duration-300 ease-in-out group-hover:rotate-[-5deg] group-hover:scale-105"
        >
          <path d="M20 4L36 20L20 36L4 20Z" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
          <path d="M20 12V28M12 20H28" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
        </svg>
      </div>
      {!hideText && (
        <span
          className={cn(
            "text-xl font-bold tracking-tighter text-white",
            playfair.className, className
          )}
        >
          Alloy
        </span>
      )}
    </Link>
  );
};

export default Logo;-e 
-e

File: web/src/components/global/Header.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import React, { useState, useEffect, useMemo } from "react";
import {
  Home,
  Users,
  Settings,
  FileText,
  Search,
  PanelLeft,
  PlusCircle,
  LogOut,
  CreditCard,
  LifeBuoy
} from "lucide-react";

import { DynamicBreadcrumb } from "./Breadcrumbs";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuPortal,
  DropdownMenuSeparator,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuGroup,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet";
import { Logo } from "@/components/global/Logo";
import { useAuth } from "./providers";
import { CommandPalette } from "./CommandPalette";
import { UserAvatar } from "./UserAvatar";

const mobileNavItems = [
  { href: "/dashboard", icon: Home, label: "Dashboard" },
  { href: "/dashboard/reports", icon: FileText, label: "My Reports" },
  { href: "/dashboard/team", icon: Users, label: "Team" },
  //{ href: "/dashboard/billing", icon: CreditCard, label: "Billing" },
  { href: "/dashboard/settings", icon: Settings, label: "Settings" },
  { href: "/dashboard/support", icon: LifeBuoy, label: "Support" },
];

export function Header() {
  const { logout, user } = useAuth();
  const [isCommandOpen, setCommandOpen] = useState(false);
  const pathname = usePathname();

  useEffect(() => {
    const down = (e: KeyboardEvent) => {
      if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        setCommandOpen((open) => !open);
      }
    };
    document.addEventListener("keydown", down);
    return () => document.removeEventListener("keydown", down);
  }, []);
  
  const displayName = useMemo(
    () => user?.full_name || user?.email?.split('@')[0] || "User",
    [user]
  );
  return (
    <>
      <header className="sticky top-0 z-30 flex h-16 items-center justify-between gap-4 border-b bg-background px-4 sm:px-6">
        {/* --- Left Side: Mobile Nav Trigger & Breadcrumbs --- */}
        <div className="flex items-center gap-4">
            <Sheet>
            <SheetTrigger asChild>
                <Button size="icon" variant="outline" className="sm:hidden">
                <PanelLeft className="h-5 w-5" />
                <span className="sr-only">Toggle Menu</span>
                </Button>
            </SheetTrigger>
            <SheetContent side="left" className="sm:max-w-xs">
                <nav className="grid gap-6 text-lg font-medium mt-6">
                <Logo />
                {mobileNavItems.map((item) => {
                    const isActive = pathname.startsWith(item.href) && (item.href !== "/dashboard" || pathname === "/dashboard");
                    return (
                        <Link
                            key={item.href}
                            href={item.href}
                            className={`flex items-center gap-4 px-2.5 ${isActive ? 'text-foreground' : 'text-muted-foreground'} hover:text-foreground`}
                        >
                            <item.icon className="h-5 w-5" />
                            {item.label}
                        </Link>
                    )
                })}
                </nav>
            </SheetContent>
            </Sheet>
            <DynamicBreadcrumb />
        </div>

        {/* --- Right Side: Header Actions --- */}
        <div className="flex items-center gap-2">
           <Button variant="outline" size="icon" className="h-8 w-8" onClick={() => setCommandOpen(true)}>
                <Search className="h-4 w-4" />
                <span className="sr-only">Search</span>
           </Button>
           
           <Button asChild variant="ghost" size="sm" className="h-8 gap-1">
             <Link href="/dashboard/reports">
                <FileText className="h-4 w-4" />
                <span className="hidden sm:inline-block">My Reports</span>
              </Link>
           </Button>

           <Button asChild size="sm" className="h-8 gap-1">
              <Link href="/dashboard">
                <PlusCircle className="h-3.5 w-3.5" />
                <span className="sr-only sm:not-sr-only sm:whitespace-nowrap">
                  New Report
                </span>
              </Link>
            </Button>

          <DropdownMenu>
            <DropdownMenuTrigger asChild>
               <Button variant="ghost" className="relative h-9 w-9 rounded-full"><UserAvatar user={user} /></Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="w-64" align="end" forceMount>
                <DropdownMenuLabel className="font-normal">
                    <div className="flex flex-col space-y-1">
                        <p className="text-sm font-medium leading-none capitalize">{displayName}</p>
                        <p className="text-xs leading-none text-muted-foreground">{user?.email}</p>
                    </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                <DropdownMenuGroup>
                    <DropdownMenuItem asChild><Link href="/dashboard/settings"><Settings className="mr-2 h-4 w-4" />Settings</Link></DropdownMenuItem>
                    {/* <DropdownMenuItem asChild><Link href="/dashboard/billing"><CreditCard className="mr-2 h-4 w-4" />Billing</Link></DropdownMenuItem> */}
                    <DropdownMenuItem asChild><Link href="/dashboard/support"><LifeBuoy className="mr-2 h-4 w-4" />Support</Link></DropdownMenuItem>
                </DropdownMenuGroup>
                <DropdownMenuSeparator />
                <DropdownMenuGroup>
                    <DropdownMenuSub>
                        <DropdownMenuSubTrigger><Users className="mr-2 h-4 w-4" /><span>Switch Organization</span></DropdownMenuSubTrigger>
                        <DropdownMenuPortal><DropdownMenuSubContent>
                                <DropdownMenuLabel>Acme Inc.</DropdownMenuLabel>
                                <DropdownMenuItem>Stark Industries</DropdownMenuItem>
                                <DropdownMenuItem>Wayne Enterprises</DropdownMenuItem>
                                <DropdownMenuSeparator />
                                <DropdownMenuItem><PlusCircle className="mr-2 h-4 w-4" /> Create New</DropdownMenuItem>
                        </DropdownMenuSubContent></DropdownMenuPortal>
                    </DropdownMenuSub>
                </DropdownMenuGroup>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={logout}><LogOut className="mr-2 h-4 w-4" />Logout</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </header>
      <CommandPalette open={isCommandOpen} onOpenChange={setCommandOpen} />
    </>
  );
}-e 
-e

File: web/src/components/global/Sidebar.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useTheme } from "next-themes";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import {
  Home,
  Users,
  Settings,
  FileText,
  Moon,
  Sun,
  Laptop,
  LifeBuoy,
  CreditCard
} from "lucide-react";
import { cn } from "@/lib/utils";
import { Logo } from "@/components/global/Logo";
import { Button } from "../ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "../ui/dropdown-menu";

// Define the navigation items for the sidebar
const mainNavItems = [
  { href: "/dashboard", icon: Home, label: "Dashboard" },
  { href: "/dashboard/reports", icon: FileText, label: "My Reports" },
  { href: "/dashboard/team", icon: Users, label: "Team Members" },
];

const settingsNavItems = [
    { href: "/dashboard/settings", icon: Settings, label: "Settings" },
]

export function Sidebar() {
  const pathname = usePathname();
  const { setTheme } = useTheme();

  return (
    <aside className="fixed inset-y-0 left-0 z-10 hidden w-14 flex-col border-r bg-background sm:flex">
      {/* Top section with logo and main navigation */}
      <nav className="flex flex-col items-center gap-4 px-2 sm:py-5">
        <Logo className="h-7 w-7" />
        <TooltipProvider>
          {mainNavItems.map((item) => {
            const isActive = pathname.startsWith(item.href) && (item.href !== "/dashboard" || pathname === "/dashboard");
            return (
              <Tooltip key={item.href}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      "flex h-9 w-9 items-center justify-center rounded-lg text-muted-foreground transition-colors hover:text-foreground md:h-8 md:w-8",
                      isActive && "bg-accent text-accent-foreground"
                    )}
                  >
                    <item.icon className="h-5 w-5" />
                    <span className="sr-only">{item.label}</span>
                  </Link>
                </TooltipTrigger>
                <TooltipContent side="right">{item.label}</TooltipContent>
              </Tooltip>
            );
          })}
        </TooltipProvider>
      </nav>

      {/* Bottom section with settings and theme switcher */}
      <nav className="mt-auto flex flex-col items-center gap-4 px-2 sm:py-5">
        <TooltipProvider>
          {/* Theme Switcher */}
          <DropdownMenu>
            <Tooltip>
              <TooltipTrigger asChild>
                <DropdownMenuTrigger asChild>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-9 w-9 text-muted-foreground transition-colors hover:text-foreground md:h-8 md:w-8"
                  >
                    <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
                    <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
                    <span className="sr-only">Toggle theme</span>
                  </Button>
                </DropdownMenuTrigger>
              </TooltipTrigger>
              <TooltipContent side="right">Toggle Theme</TooltipContent>
            </Tooltip>
            <DropdownMenuContent side="right">
              <DropdownMenuItem onClick={() => setTheme("light")}>
                <Sun className="mr-2 h-4 w-4" /> Light
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => setTheme("dark")}>
                <Moon className="mr-2 h-4 w-4" /> Dark
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => setTheme("system")}>
                <Laptop className="mr-2 h-4 w-4" /> System
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>

          {/* Settings Link */}
          {settingsNavItems.map((item) => {
            const isActive = pathname.startsWith(item.href);
            return (
              <Tooltip key={item.href}>
                <TooltipTrigger asChild>
                  <Link
                    href={item.href}
                    className={cn(
                      "flex h-9 w-9 items-center justify-center rounded-lg text-muted-foreground transition-colors hover:text-foreground md:h-8 md:w-8",
                      isActive && "bg-accent text-accent-foreground"
                    )}
                  >
                    <item.icon className="h-5 w-5" />
                    <span className="sr-only">{item.label}</span>
                  </Link>
                </TooltipTrigger>
                <TooltipContent side="right">{item.label}</TooltipContent>
              </Tooltip>
            );
          })}
        </TooltipProvider>
      </nav>
    </aside>
  );
}-e 
-e

File: web/src/components/global/PageLoader.tsx
"use client";

import { Loader2 } from "lucide-react";

/**
 * A full-page loader component that displays a centered spinning icon.
 * Ideal for indicating the initial loading state of the application.
 */
export const PageLoader = () => {
  return (
    <div className="flex h-screen w-full items-center justify-center bg-background">
      <Loader2 className="h-8 w-8 animate-spin text-primary" />
    </div>
  );
};-e 
-e

File: web/src/components/global/UserAvatar.tsx
"use client";

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

interface User {
    email: string;
    full_name?: string;
}

interface UserAvatarProps {
  user?: User | null;
}

const getInitials = (name?: string, email?: string): string => {
  if (name) {
    const parts = name.split(" ");
    if (parts.length > 1 && parts[0] && parts[parts.length - 1]) {
      return `${parts[0][0]}${parts[parts.length - 1][0]}`.toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  }
  if (email) {
    return email.charAt(0).toUpperCase();
  }
  return "A";
};

export const UserAvatar = ({ user }: UserAvatarProps) => {
  return (
    <Avatar className="h-9 w-9">
      {/* The backend doesn't provide image URLs yet, so this will always use the fallback */}
      <AvatarImage src="" alt={user?.full_name || user?.email} />
      <AvatarFallback>{getInitials(user?.full_name, user?.email)}</AvatarFallback>
    </Avatar>
  );
};-e 
-e

File: web/src/components/global/providers.tsx
"use client";

import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import Cookies from 'js-cookie';
import { SWRConfig } from 'swr';
import { toast } from 'sonner';

// A simple JWT parser without adding extra dependencies
const parseJwt = (token: string) => {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Failed to parse JWT:", error);
        return null;
    }
};

interface User {
    email: string;
    full_name?: string;
}

interface AuthContextType {
  accessToken: string | null;
  user: User | null;
  login: (token: string, refreshToken: string) => void;
  logout: () => void;
  isAuthenticated: boolean;
  isLoading: boolean;
  apiUrl: string;
  authedFetch: (url: string, options?: RequestInit) => Promise<Response>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider = ({ children, apiUrl }: { children: React.ReactNode, apiUrl: string }) => {
  const [accessToken, setAccessToken] = useState<string | null>(null);
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const token = Cookies.get('alloy_access_token');
    if (token) {
      const decodedToken = parseJwt(token);
      if (decodedToken && decodedToken.sub) {
        setUser({ email: decodedToken.sub, full_name: decodedToken.full_name });
        setAccessToken(token);
      }
    }
    setIsLoading(false);
  }, []);

  const logout = useCallback(() => {
    setUser(null);
    setAccessToken(null);
    Cookies.remove('alloy_access_token');
    Cookies.remove('alloy_refresh_token');
    window.location.href = '/login';
  }, []);

  const refreshAccessToken = useCallback(async (): Promise<string | null> => {
    const refreshToken = Cookies.get('alloy_refresh_token');
    if (!refreshToken) {
      logout();
      return null;
    }
    try {
      const res = await fetch(`${apiUrl}/api/v1/auth/refresh`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refresh_token: refreshToken }),
      });
      if (!res.ok) throw new Error('Refresh failed, please log in again.');
      const { access_token: newAccessToken } = await res.json();
      const decodedToken = parseJwt(newAccessToken);
      setAccessToken(newAccessToken);
      if (decodedToken) setUser({ email: decodedToken.sub, full_name: decodedToken.full_name });
      Cookies.set('alloy_access_token', newAccessToken, { expires: 1 / 24, secure: process.env.NODE_ENV === 'production' });
      return newAccessToken;
    } catch (error) {
      console.error("Token refresh failed:", error);
      logout();
      return null;
    }
  }, [apiUrl, logout]);

  const authedFetch = useCallback(async (url: string, options?: RequestInit): Promise<Response> => {
    let token = Cookies.get('alloy_access_token');
    if (!token) { logout(); throw new Error("User not authenticated"); }
    
    const res = await fetch(url, { ...options, headers: { ...options?.headers, 'Authorization': `Bearer ${token}` } });
    
    if (res.status === 401) {
      const newToken = await refreshAccessToken();
      if (newToken) {
        return fetch(url, { ...options, headers: { ...options?.headers, 'Authorization': `Bearer ${newToken}` } });
      } else {
        throw new Error("Session expired");
      }
    }
    return res;
  }, [logout, refreshAccessToken]);

  const login = useCallback((token: string, refreshToken: string) => {
    const decodedToken = parseJwt(token);
    if (decodedToken && decodedToken.sub) {
      setUser({ email: decodedToken.sub, full_name: decodedToken.full_name });
      setAccessToken(token);
      Cookies.set('alloy_access_token', token, { expires: 1 / 24, secure: process.env.NODE_ENV === 'production' }); // 1 hour
      Cookies.set('alloy_refresh_token', refreshToken, { expires: 7, secure: process.env.NODE_ENV === 'production' });
    }
  }, []);

  const value = {
    accessToken,
    user,
    login,
    logout,
    isAuthenticated: !!accessToken,
    isLoading,
    apiUrl,
    authedFetch,
  };

  const swrFetcher = async (url: string) => {
      const res = await authedFetch(url);
      if (!res.ok) {
          const errorData = await res.json().catch(() => ({ detail: `Request failed with status ${res.status}` }));
          throw new Error(errorData.detail);
      }
      return res.json();
  };

  return <AuthContext.Provider value={value}>
    <SWRConfig value={{ fetcher: swrFetcher, onError: (error) => {
      if (error.message !== 'Session expired' && error.message !== 'User not authenticated') { toast.error("Error", { description: error.message }); }
    }}}>{children}</SWRConfig>
  </AuthContext.Provider>;
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export const AppProviders = ({ children, apiUrl }: { children: React.ReactNode; apiUrl: string }) => {
    return <AuthProvider apiUrl={apiUrl}>{children}</AuthProvider>
};-e 
-e

File: web/src/hooks/use-mobile.ts
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}
-e 
-e

File: web/src/lib/utils.ts
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
-e 
-e

--- DIRECTORY TREES ---

Backend Tree:
backend/src
 __pycache__
  main.cpython-313.pyc
 api
  __init__.py
  __pycache__
   __init__.cpython-313.pyc
  v1
      __init__.py
      __pycache__
       __init__.cpython-313.pyc
       auth.cpython-313.pyc
       health.cpython-313.pyc
       reports.cpython-313.pyc
       utils.cpython-313.pyc
      auth.py
      health.py
      reports.py
      utils.py
 core
  __pycache__
   security.cpython-313.pyc
   settings.cpython-313.pyc
  security.py
  settings.py
 db
  __init__.py
  __pycache__
   __init__.cpython-313.pyc
   postgresql.cpython-313.pyc
  models
   __init__.py
   __pycache__
       __init__.cpython-313.pyc
       analysis.cpython-313.pyc
       report.cpython-313.pyc
       user.cpython-313.pyc
  postgresql.py
 main.py
 services
  __pycache__
   docling.cpython-313.pyc
   pdf_generator.cpython-313.pyc
   pdf_layouts.cpython-313.pyc
   pdf_template.cpython-313.pyc
   react_agent.cpython-313.pyc
   report_generator.cpython-313.pyc
   search.cpython-313.pyc
  docling.py
  pdf_generator.py
  pdf_layouts.py
  react_agent.py
  report_generator.py
  search.py
 utils
     __init__.py
     __pycache__
         __init__.cpython-313.pyc

16 directories, 42 files

Backend Tests Tree:
backend/tests
 __init__.py
 __pycache__
  __init__.cpython-313.pyc
  conftest.cpython-313-pytest-8.4.1.pyc
 api
  __init__.py
  __pycache__
   __init__.cpython-313.pyc
  v1
      __init__.py
      __pycache__
       __init__.cpython-313.pyc
       test_auth.cpython-313-pytest-8.4.1.pyc
       test_health.cpython-313-pytest-8.4.1.pyc
       test_reports.cpython-313-pytest-8.4.1.pyc
      test_auth.py
      test_health.py
      test_reports.py
 conftest.py
 core
     __init__.py
     __pycache__
      __init__.cpython-313.pyc
      test_security.cpython-313-pytest-8.4.1.pyc
     test_security.py

8 directories, 18 files

Web App Tree:
web/src
 app
  (pages)
   (auth)
    layout.tsx
    login
     page.tsx
    register
     page.tsx
    token
        page.tsx
   (authed)
       dashboard
        page.tsx
        reports
         [id]
          page.tsx
         page.tsx
        settings
         page.tsx
        support
         page.tsx
        team
            page.tsx
       layout.tsx
  favicon.ico
  globals.css
  layout.tsx
  page.tsx
 components
  auth
   AuthVisual.tsx
  global
   Breadcrumbs.tsx
   CommandPalette.tsx
   DashboardGreeting.tsx
   DemoReportCard.tsx
   Footer.tsx
   Header.tsx
   Hero.tsx
   LinesPatternCard.tsx
   Logo.tsx
   PageLoader.tsx
   PromptInputBox.tsx
   providers.tsx
   Sidebar.tsx
   UserAvatar.tsx
  report
   AIAnalystChat.tsx
   ReportView.tsx
  ui
      accordion.tsx
      alert-dialog.tsx
      alert.tsx
      avatar.tsx
      badge.tsx
      breadcrumb.tsx
      button.tsx
      card.tsx
      chart.tsx
      collapsible.tsx
      command.tsx
      dialog.tsx
      dropdown-menu.tsx
      input.tsx
      label.tsx
      resizable.tsx
      scroll-area.tsx
      select.tsx
      separator.tsx
      sheet.tsx
      sidebar.tsx
      skeleton.tsx
      sonner.tsx
      switch.tsx
      table.tsx
      tabs.tsx
      textarea.tsx
      tooltip.tsx
 hooks
  use-mobile.ts
 lib
  utils.ts
 types
     report.ts

22 directories, 63 files

-----------------------

Project Context: Alloy - The Cultural Due Diligence Platform

Core Concept: A financial-grade intelligence platform for M&A, VC, and corporate strategy firms that de-risks multi-billion dollar acquisitions by replacing executive "gut feeling" with a data-driven "Cultural Compatibility Score."

System Architecture: Two-Part System

The project is composed of two distinct but interconnected components:

1. FastAPI Backend (backend):

Role: The "Intelligence & Qloo Engine." This is the core brain of the operation.

Function:
- Its primary responsibility is to receive an authenticated request with two brand names (an Acquirer and a Target).
- It makes foundational, parallel calls to the Qloo Taste AI API to retrieve the complete, raw cultural taste profiles for both brand audiences. This is the "Source of Truth."
- It then processes this rich Qloo data to generate the core analytical modules: an Affinity Overlap score, a Culture Clash "red flag" report, and an Untapped Growth opportunities map.
- In the final step, it feeds ONLY the raw Qloo cultural affinity lists (e.g., top 50 movies, books, artists) to a Large Language Model, tasking it to act as an expert brand strategist and deduce the "Brand Archetype" from the data alone.
- It is entirely stateless, relying on JWTs for authentication.

Endpoints: A primary `/v1/report/create` for generating the analysis, and robust OAuth2 endpoints (`/auth/...`) for user management.

2. Next.js Web App (web):

Role: The "Executive Dashboard & Command Center." This is the user-facing application.

Function:
- Handles user signup, login (via OAuth against the FastAPI backend), and future billing/settings.
- Provides a clean, professional interface for users to input the two brands they wish to analyze.
- Its most critical function is to receive the complete JSON report from the backend and render it into a stunning, multi-module, interactive dashboard. This includes data visualizations like Venn diagrams for overlap, comparison tables for clashes, and strategic summaries.
- It guides the user through the data story, turning complex cultural intelligence into clear, actionable business insights.

User Experience & Core Loop:

1. Onboarding: An analyst from a VC firm signs up and logs in via the web app's secure OAuth flow.
2. Core Action: From their dashboard, they create a new analysis, entering "Disney" as the Acquirer and "A24 Films" as the Target, then click "Generate Report."
3. Processing: The frontend shows a professional loading state, indicating that deep analysis is underway ("Analyzing Taste DNA... Synthesizing Thesis...").
4. The Reveal: The complete, multi-part "Alloy Report" is displayed. The user can interact with the Affinity Overlap chart, review the stark brand differences in the Culture Clash table, explore growth opportunities, and read the final, AI-generated Brand Archetype summary that explains the "why" behind the data. The report is automatically saved to their account for future reference.
